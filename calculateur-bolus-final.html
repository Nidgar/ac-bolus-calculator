<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>AC Bolus - Calculateur de Bolus</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Theme color pour Android -->
  <meta name="theme-color" content="#6ee7ff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1220" />
  
  <!-- Description pour PWA -->
  <meta name="description" content="Outil éducatif pour comprendre le calcul bolus (glucides / correction). Ne remplace pas un avis médical ni un protocole." />
  
  <!-- Apple Touch Icons (iOS) -->
  <link rel="apple-touch-icon" href="assets/img/icon-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="assets/img/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="assets/img/icon-512.png" />
  
  <!-- Favicons classiques -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="assets/img/favicon-48.png" />
  <link rel="icon" type="image/png" sizes="96x96" href="assets/img/favicon-96.png" />
  
  <!-- Android Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="AC Bolus" />
  
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="AC Bolus" />
  
  <!-- Scripts déplacés en bas du body pour garantir l'ordre d'exécution (Issue 1) -->
  
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --border: rgba(255,255,255,0.12);
      --accent: #6ee7ff;
      --accent2: #a78bfa;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --cool: #60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 20px;
      --focus: 0 0 0 3px rgba(110,231,255,0.35);
      color-scheme: dark;
    }
    :root[data-theme="clair"]{
      --bg: #f0f2f5;
      --panel: rgba(0,0,0,0.12);
      --panel2: rgba(0,0,0,0.16);
      --text: rgba(0,0,0,0.95);
      --muted: rgba(0,0,0,0.72);
      --border: rgba(0,0,0,0.25);
      --accent: #0284c7;
      --accent2: #6d28d9;
      --good: #047857;
      --warn: #c2410c;
      --bad: #dc2626;
      --cool: #1d4ed8;
      --shadow: 0 18px 60px rgba(0,0,0,0.25);
      color-scheme: light;
    }

    *{ box-sizing:border-box; }
    html{ 
      height: 100%;
    }
    body{ 
      display:flex; 
      flex-direction:column; 
      align-items:center;
      min-height: 100vh; /* Couvre toute la hauteur de la fenêtre */
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1100px 520px at 14% 0%, rgba(167,139,250,0.20), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(110,231,255,0.16), transparent 60%),
        var(--bg);
      background-attachment: fixed; /* Background fixe, ne défile pas */
      color: var(--text);
      line-height: 1.35;
    }

    .skip{
      position:absolute; left:-999px; top:0;
      background: var(--text); color: var(--bg);
      padding:10px 12px; border-radius: 14px;
      z-index: 9999;
    }
    .skip:focus{ left:12px; top:12px; outline:none; }

    .wrap{
      max-width: 840px;  /* Optimisé pour 4 boutons + espacements égaux (~35px) */
      width: 100%;  /* Prend toute la largeur disponible */
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 14px;
      box-sizing: border-box;  /* Inclut padding dans la largeur */
      overflow: visible;  /* Permet au bouton toggle de dépasser */
    }

    @media (max-width:720px){
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .logo{
      width: 64px;
      height: 64px;
      display:grid;
      place-items:center;
      border-radius: 16px;
      
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sub{
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-weight: 800;
    }
    :root[data-theme="clair"] .btn{
      background: rgba(255,255,255,0.85);
      border-color: rgba(0,0,0,0.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn-ghost{ background: transparent; }
    .btn[aria-pressed="true"]{
      /* default pressed state */
      border-color: rgba(110,231,255,0.45);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
    }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; transform:none; }
    .btn-error{ border-color:#fb7185 !important; box-shadow:0 0 0 2px rgba(251,113,133,0.4); }

    .card{
      background: linear-gradient(180deg, var(--panel), transparent 140%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      max-width: 100%;
      overflow-wrap: break-word;
    }
    :root[data-theme="clair"] .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85) 140%);
      border-color: rgba(0,0,0,0.20);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 15px;
      letter-spacing: 0.2px;
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .pillbar{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
      justify-content: center; /* Centré */
    }
    .pills{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
      justify-content: center; /* Centré */
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel2);
      font-size: 13px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    
    /* Texte des labels (Glycémie, Glucides, Objectif) */
    .pill-label {
      display: inline; /* Visible par défaut */
    }
    
    /* Mode mobile : cacher les labels, garder icône + valeur */
    @media (max-width: 500px) {
      .pill-label {
        display: none; /* Cache "Glycémie", "Glucides", "Objectif" */
      }
      
      .pill {
        padding: 6px 10px; /* Padding réduit */
        font-size: 12px; /* Police légèrement plus petite */
      }
    }
    
    :root[data-theme="clair"] .pill{
      background: rgba(255,255,255,0.85);
      border-color: rgba(0,0,0,0.20);
    }
    .pill strong{ color: var(--text); }

    .dotGly{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
      flex: 0 0 auto;
    }
    .dotGly.cool{ background: var(--cool); border-color: rgba(96,165,250,0.55); box-shadow: 0 0 0 3px rgba(96,165,250,0.14); }
    .dotGly.good{ background: var(--good); border-color: rgba(52,211,153,0.55); box-shadow: 0 0 0 3px rgba(52,211,153,0.14); }
    .dotGly.warn{ background: var(--warn); border-color: rgba(251,191,36,0.60); box-shadow: 0 0 0 3px rgba(251,191,36,0.14); }
    .dotGly.bad{  background: var(--bad);  border-color: rgba(251,113,133,0.60); box-shadow: 0 0 0 3px rgba(251,113,133,0.14); }

    .input-error{ border-color: rgba(251,113,133,0.65) !important; box-shadow: 0 0 0 3px rgba(251,113,133,0.18) !important; }
    
    /* Effet néon pour les champs obligatoires non remplis */
    input[type="number"].input-required-empty, input[type="text"].input-required-empty{
      border-color: rgba(110,231,255,0.85);
      box-shadow:
        0 0 0 2px rgba(110,231,255,0.22),
        0 0 18px rgba(110,231,255,0.35),
        0 0 32px rgba(37,99,235,0.15);
      animation: pulseNeon 2s ease-in-out infinite;
    }
    
    @keyframes pulseNeon {
      0%, 100% { 
        box-shadow:
          0 0 0 2px rgba(110,231,255,0.22),
          0 0 18px rgba(110,231,255,0.35),
          0 0 32px rgba(37,99,235,0.15);
      }
      50% { 
        box-shadow:
          0 0 0 2px rgba(110,231,255,0.30),
          0 0 22px rgba(110,231,255,0.45),
          0 0 40px rgba(37,99,235,0.22);
      }
    }

    @keyframes pulseNeonRed {
      0%, 100% {
        box-shadow:
          0 0 0 2px rgba(251,113,133,0.35),
          0 0 18px rgba(251,113,133,0.45),
          0 0 32px rgba(220,38,38,0.25);
      }
      50% {
        box-shadow:
          0 0 0 3px rgba(251,113,133,0.55),
          0 0 28px rgba(251,113,133,0.65),
          0 0 48px rgba(220,38,38,0.40);
      }
    }
    
    .alertBanner{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(251,113,133,0.35);
      background: rgba(251,113,133,0.10);
      color: var(--text);
      font-weight: 900;
      display:none;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    .alertBanner.show{ display:block; }
    .alertBanner span{ color: var(--muted); font-weight: 800; }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 520px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .label{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    
    /* Labels agrandis pour les champs principaux */
    .label-large {
      font-size: 16px !important; /* Augmenté de 12px à 16px */
      font-weight: 900;
      color: var(--text) !important;
    }
    
    .label-large .label-icon {
      font-size: 24px; /* Icônes plus grandes */
      line-height: 1;
    }
    
    input[type="number"], input[type="text"], select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    :root[data-theme="clair"] input[type="number"],
    :root[data-theme="clair"] input[type="text"],
    :root[data-theme="clair"] select{
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.25);
    }

    /* Erreurs de champ sans décalage */
    .fieldLine{ display:flex; flex-direction:column; gap:6px; }
    .fieldError{ height: 18px; line-height:18px; font-size:12px; font-weight:900; color: var(--bad);
      visibility:hidden; white-space: nowrap; overflow: hidden; }
    .fieldError.show{ visibility:visible; }

    input[type="number"]:focus, input[type="text"]:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(110,231,255,0.55);
    }
    select option{ background: var(--bg); color: var(--text); }


    .results{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
      transition: grid-template-columns 0.4s ease;
    }
    
    /* Mode simple : 1 colonne (total seul) */
    body.simple-mode .results {
      grid-template-columns: 1fr;
    }
    
    /* Mode simple avec détails : 3 colonnes */
    body.simple-mode.show-bolus-details .results {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    /* Mode initié : toujours 3 colonnes sur desktop */
    @media (min-width: 520px){
      body:not(.simple-mode) .results { 
        grid-template-columns: 1fr 1fr 1fr; 
      }
      .results.simple{ 
        grid-template-columns: 1fr; 
      }
    }
    
    /* Mobile : toujours 1 colonne */
    @media (max-width: 519px){
      .results { 
        grid-template-columns: 1fr !important; 
      }
    }
    .res{ text-align:center;
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 16px;
      padding: 12px;
    }
    .res.total{
      border-color: rgba(110,231,255,0.45);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
    }
    .res .k{ font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .res .v{ font-size: 22px; font-weight: 950; font-variant-numeric: tabular-nums; }
    .res.total .v{ font-size: 30px; letter-spacing: 0.2px; }
    .total-detail{
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
      font-variant-numeric: tabular-nums;
      opacity: 0.75;
      min-height: 14px;
    }
    /* P0 Issue 6 — Bloc hypo dédié dans le résultat */
    #hypoBlock{
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 2px solid rgba(251,113,133,0.55);
      background: rgba(220,38,38,0.20);
      font-size: 12px;
      font-weight: 800;
      line-height: 1.5;
      text-align: left;
      color: var(--text);
    }
    #hypoBlock.show{
      display: block;
      animation: pulseNeonRed 2s ease-in-out infinite;
    }
    #hypoBlock .hypoTitle{
      font-size: 14px;
      font-weight: 950;
      margin-bottom: 4px;
    }
    /* P1 Issue 3 — Disclaimer éducatif résultat */
    #resultDisclaimer{
      display: none;
      margin-top: 8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(110,231,255,0.30);
      background: rgba(110,231,255,0.08);
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      line-height: 1.4;
      text-align: center;
    }
    #resultDisclaimer.show{ display: block; }

    .miniBadges{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      flex-direction: row;
      align-items:center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    :root[data-theme="clair"] .badge{ background: rgba(0,0,0,0.03); }
    .badge strong{ color: var(--text); }
    /* P0 Issue 5 — Mini-explication inline ICR/FSI */
    .badgeHint{
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      opacity: 0.75;
      white-space: nowrap;
      border-left: 1px solid var(--border);
      padding-left: 6px;
    }

    .status{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed var(--border);
      color: var(--muted);
      min-height: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      text-align:center;
    }
    .status.ok{ border-style: solid; border-color: rgba(52,211,153,0.35); background: rgba(52,211,153,0.14); font-weight: 950; color: var(--text); }
    .statusIcon{ font-size: 18px; line-height: 1; flex: 0 0 auto; }
    .statusText{ font-weight: inherit; }

    .status.warn{ border-style: solid; border-color: rgba(251,191,36,0.35); background: rgba(251,191,36,0.16); font-weight: 950; color: var(--text); }
    .status.bad{ border-style: solid; border-color: rgba(251,113,133,0.35); }
    .status.info{ border-style: solid; border-color: rgba(110,231,255,0.45); background: rgba(110,231,255,0.16); font-weight: 950; color: var(--text); }

    details{
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    summary{ cursor:pointer; color: var(--text); font-weight: 950; }

    /* P1 Issue 4 — Ce que l'outil fait / ne fait pas */
    .dosDonts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 560px) { .dosDonts { grid-template-columns: 1fr; } }
    .dosDontsCol {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 11px;
      line-height: 1.55;
    }
    .dosDo {
      background: rgba(52,211,153,0.08);
      border: 1px solid rgba(52,211,153,0.3);
    }
    .dosDont {
      background: rgba(251,113,133,0.08);
      border: 1px solid rgba(251,113,133,0.3);
    }
    .dosDontsTitle {
      font-weight: 900;
      font-size: 12px;
      margin-bottom: 6px;
      color: var(--text);
    }
    .dosDontsCol ul {
      margin: 0;
      padding-left: 16px;
    }
    .dosDontsCol li { margin-bottom: 4px; }

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .metric{
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 16px;
      padding: 12px;
    }
    .metric .k{ font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .metric .v{ font-size: 20px; font-weight: 950; font-variant-numeric: tabular-nums; }

    .hidden{ display:none !important; }
    /* Garantit que l'attribut HTML hidden prime sur tout display CSS (ex: flex/grid) */
    [hidden]{ display:none !important; }

    /* Bouton toggle détails bolus (mode simple) */
    .toggle-details-btn {
      position: absolute;
      left: -26px;  /* Déplacé 10px vers la gauche (de -16px à -26px) */
      top: 50%;
      transform: translateY(-50%);
      width: 44px;  /* Légèrement plus grand pour meilleure visibilité */
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--accent);  /* Bordure accent pour meilleure visibilité */
      background: var(--panel2);
      color: var(--accent);  /* Couleur accent pour meilleure visibilité */
      font-size: 22px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;  /* Z-index très élevé pour être au-dessus de tout */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);  /* Ombre pour le détacher du fond */
    }
    
    .toggle-details-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: translateY(-50%) scale(1.15);
      box-shadow: 0 6px 20px rgba(110, 231, 255, 0.4);
    }
    
    /* Cache le bouton sur petit écran */
    @media (max-width: 768px) {
      .toggle-details-btn {
        left: 8px;
        top: -20px;
        transform: translateY(0);
      }
      
      .toggle-details-btn:hover {
        transform: translateY(0) scale(1.1);
      }
    }
    
    /* Détails bolus (Correction + Repas) */
    .bolus-detail {
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    
    /* Mode simple : détails cachés par défaut */
    body.simple-mode .bolus-detail {
      display: none !important;
      opacity: 0;
    }
    
    /* Mode simple avec détails affichés */
    body.simple-mode.show-bolus-details .bolus-detail {
      display: block !important;
      opacity: 1 !important;
      animation: fadeIn 0.4s ease;
    }
    
    /* Animation d'apparition en fondu */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    /* Mode initié : détails toujours visibles */
    body:not(.simple-mode) .bolus-detail {
      display: block;
      opacity: 1;
    }
    
    /* Verrouillage temporaire des zones de calcul pendant l'édition des ratios */
    body.editing-ratios #panelFast{
      opacity: 0.35;
      pointer-events: none;
      user-select: none;
      filter: saturate(0.9);
    }
    body.editing-ratios #panelFast * { pointer-events: none; }
    
    footer{
      color: var(--muted);
      font-size: 12px;
      padding: 4px 2px 14px;
      text-align:center;
    }
    /* P1 Issue 3 — Disclaimer permanent */
    .footerDisclaimer{
      display: block;
      margin: 0 0 6px 0;
      padding: 9px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,190,0,0.35);
      background: rgba(255,190,0,0.08);
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      line-height: 1.6;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }
    /* P2 Issue 6 — Contexte scolaire */
    .footerDisclaimerSchool{
      border-color: rgba(99,102,241,0.35);
      background: rgba(99,102,241,0.08);
    }
  
    header{
      max-width: 840px;  /* Aligné avec .wrap */
      margin:0 auto 24px auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }
    .headerLeft{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
      text-align:left;
    }
    .titleBlock{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .headerRight{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    @media (max-width:720px){
      header{ flex-direction:column; align-items:center; text-align:center; }
      .headerLeft{ justify-content:center; text-align:center; }
      .headerRight{ justify-content:center; }
    }

    /* Mode simple SANS détails : on affiche uniquement le total */
    body.simple-mode:not(.show-bolus-details) #corrFastBox,
    body.simple-mode:not(.show-bolus-details) #repasFastBox,
    body.simple-mode #ratioBadgesFast{
      display:none !important;
    }
    
    /* Mode simple : classe générale pour cacher des éléments */
    body.simple-mode .hide-in-simple {
      display: none !important;
    }
    
    /* Mode avancé : cacher les éléments réservés au mode simple */
    body:not(.simple-mode) .hide-in-advanced {
      display: none !important;
    }
    
    /* En mode simple SANS détails, le total prend toute la largeur */
    body.simple-mode:not(.show-bolus-details) #resultsFastGrid{
      grid-template-columns: 1fr !important;
    }
    
    /* ===== INTERFACE RECHERCHE ALIMENTS ===== */
    
    /* Masquer en mode simple */
    body.simple-mode #foodSearchToggle,
    body.simple-mode #foodSearchPanel{
      display:none !important;
    }
    
    @keyframes foodTogglePulse {
      0%, 100% { box-shadow: 0 4px 18px rgba(110,231,255,0.35), 0 0 0 0 rgba(110,231,255,0.45); }
      50%       { box-shadow: 0 4px 28px rgba(110,231,255,0.6),  0 0 0 8px rgba(110,231,255,0.0); }
    }
    @keyframes foodToggleHue {
      0%   { filter: hue-rotate(0deg)   brightness(1.05); }
      100% { filter: hue-rotate(360deg) brightness(1.05); }
    }
    .foodSearchToggle{
      width: 100%;
      padding: 14px 20px;
      background: linear-gradient(135deg, #3ecfea, #a78bfa);
      border: none;
      border-radius: 16px;
      color: #fff;
      font-size: 1.12rem;
      font-weight: 900;
      letter-spacing: 0.03em;
      text-shadow: 0 0 10px rgba(0,0,0,0.4), 0 0 20px rgba(0,0,0,0.25), 0 1px 3px rgba(0,0,0,0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      box-shadow: 0 4px 18px rgba(110,231,255,0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      animation: foodTogglePulse 2.2s ease-in-out infinite;
    }
    :root[data-theme="clair"] .foodSearchToggle {
      background: linear-gradient(135deg, #ff6b6b, #ffa94d, #ffe066, #69db7c, #4dabf7, #748ffc, #da77f2, #ff6b6b);
      background-size: 200% 200%;
      animation: foodToggleHue 12s linear infinite;
      box-shadow: 0 4px 18px rgba(200,100,200,0.35);
    }
    .foodSearchToggle .btn-emoji {
      font-size: 1.9em;
      line-height: 1;
      display: inline-block;
    }
    .foodSearchToggle:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 26px rgba(110,231,255,0.55);
      animation: none;
    }
    .foodSearchToggle.active{
      background: linear-gradient(135deg, #2bb8d4, #8b6fe0);
      box-shadow: 0 2px 10px rgba(110,231,255,0.25);
      animation: none;
      transform: none;
      filter: none;
    }
    
    #foodSearchPanel{
      margin-top: 12px;
      padding: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    
    .searchBox{
      position: relative;
      margin-bottom: 12px;
    }
    .searchBox input{
      width: 100%;
      padding: 12px 12px 12px 40px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
    }
    :root[data-theme="clair"] .searchBox input{
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.25);
    }
    .searchBox input:focus{
      outline: none;
      border-color: rgba(110,231,255,0.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,0.15);
    }
    .searchIcon{
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: 0.5;
    }
    
    /* ── Toggle vue 100g / portion ─────────────────────── */
    .searchViewToggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 4px 8px;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
    }
    .searchViewToggle span { flex: 1; }
    .viewToggleBtn {
      display: flex;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      font-size: 11px;
      font-weight: 800;
    }
    .viewToggleBtn button {
      padding: 4px 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }
    .viewToggleBtn button.active {
      background: var(--accent);
      color: var(--bg);
    }
    /* Masquage conditionnel selon vue active */
    .searchResults[data-view="portion"] .meta-100g   { display: none; }
    .searchResults[data-view="100g"]    .meta-portion { display: none; }

    .searchResults{
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 12px;
      background: var(--panel2);
      border-radius: 12px;
      padding: 4px;
    }
    .searchResults:empty{ display: none; }
    
    .foodItem{
      padding: 10px 12px;
      margin: 4px 0;
      background: rgba(255,255,255,0.04);
      border: 1px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    :root[data-theme="clair"] .foodItem{
      background: rgba(255,255,255,0.7);
    }
    .foodItem:hover{
      background: rgba(110,231,255,0.12);
      border-color: rgba(110,231,255,0.35);
    }
    .foodItem .info{
      flex: 1;
    }
    .foodItem .name{
      font-weight: 800;
      margin-bottom: 2px;
    }
    .foodItem .meta{
      font-size: 12px;
      color: var(--muted);
    }
    .foodItem .add{
      padding: 6px 12px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 900;
      border: none;
      cursor: pointer;
    }
    
    .myPlate{
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
    .myPlate h4{
      margin: 0 0 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .plateEmpty{
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .plateItem{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    :root[data-theme="clair"] .plateItem{
      background: rgba(255,255,255,0.7);
    }
    .plateItem .itemInfo{
      flex: 1;
      min-width: 0;
    }
    .plateItem .itemName{
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .plateItem .itemMeta{
      font-size: 12px;
      color: var(--muted);
    }
    .plateItem input{
      width: 70px;
      padding: 6px 8px;
      text-align: center;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-weight: 800;
      font-size: 14px;
    }
    .plateItem button{
      padding: 6px 10px;
      background: var(--bad);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
    }
    
    .plateSummary{
      margin-top: 12px;
      padding: 12px;
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
    }
    .plateSummary .summaryGrid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .plateSummary .summaryItem{
      text-align: center;
    }
    
    /* Bloc IG coloré selon le niveau (avec transparence) */
    .plateSummary .summaryItem.ig-low {
      background: rgba(52, 211, 153, 0.12);  /* Vert transparent */
      border: 1px solid rgba(52, 211, 153, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    
    .plateSummary .summaryItem.ig-medium {
      background: rgba(251, 191, 36, 0.12);  /* Jaune transparent */
      border: 1px solid rgba(251, 191, 36, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    
    .plateSummary .summaryItem.ig-high {
      background: rgba(251, 113, 133, 0.12);  /* Rouge transparent */
      border: 1px solid rgba(251, 113, 133, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    .plateSummary .summaryLabel{
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .plateSummary .summaryValue{
      font-size: 20px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
    }
    .plateSummary .timingSuggestion{
      padding: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 800;
      text-align: center;
    }
    :root[data-theme="clair"] .plateSummary .timingSuggestion{
      background: rgba(255,255,255,0.5);
    }

    /* ── Issue 2 P0 : Opt-in conseil IG/CG ─────────────────────────────── */
    .igTimingWrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .igTimingRevealBtn {
      width: 100%;
      padding: 10px 14px;
      background: rgba(99,102,241,0.12);
      color: inherit;
      border: 1.5px solid rgba(99,102,241,0.3);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      text-align: left;
      transition: background 0.15s;
    }
    .igTimingRevealBtn:hover {
      background: rgba(99,102,241,0.22);
    }
    .igTimingContent {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .igTimingDisclaimer {
      background: rgba(251,191,36,0.12);
      border: 1px solid rgba(251,191,36,0.35);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.55;
      font-weight: 600;
    }
    :root[data-theme="clair"] .igTimingRevealBtn {
      background: rgba(99,102,241,0.08);
      border-color: rgba(99,102,241,0.25);
    }
    :root[data-theme="clair"] .igTimingDisclaimer {
      background: rgba(251,191,36,0.1);
    }
    
    .validateMealBtn{
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      background: var(--good);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .validateMealBtn:hover{
      background: #059669;
    }
    .validateMealBtn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ===== MODE SIMPLE : WIZARD DE COMPOSITION DE REPAS ===== */
    
    /* Container principal - largeur fixe pour cohérence */
    
    /* ==================== WIZARD MODAL ==================== */
    
    /* Overlay (fond semi-transparent) */
    #wizardOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    #wizardOverlay.show {
      opacity: 1;
      pointer-events: all;
    }
    
    /* Panneau modal du wizard */
    #wizardModal {
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
      position: relative;
    }
    
    #wizardOverlay.show #wizardModal {
      transform: scale(1) translateY(0);
    }
    
    /* Bouton de fermeture */
    .wizardCloseBtn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .wizardCloseBtn:hover {
      background: var(--panel2);
      border-color: rgba(110,231,255,0.55);
      color: var(--text);
      transform: scale(1.05);
    }
    
    #simpleModeContainer {
      padding: 20px;
      width: 100%;
    }
    
    /* Header du wizard */
    .wizardHeader {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .wizardProgress {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 800;
    }
    
    .wizardHeader h2 {
      font-size: 24px;
      font-weight: 950;
      margin: 0 0 8px 0;
    }
    
    .wizardHeader p {
      font-size: 16px;
      color: var(--muted);
      margin: 0;
    }
    
    /* Grille de choix de type de repas */
    .repasTypeGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    @media (min-width: 600px) {
      .repasTypeGrid {
        display: flex;
        justify-content: space-evenly;  /* Espacement égal PARTOUT (bords inclus) */
        gap: 0;
        max-width: 808px;  /* 4×166px + 5×(808-664)/5 = 4×166px + 5×28.8px */
        width: 100%;
      }
      
      .repasTypeCard {
        flex: 0 0 166px;  /* Largeur fixe 166px */
      }
    }
    
    .repasTypeCard {
      background: linear-gradient(135deg, var(--panel), var(--panel2));
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 24px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      /* Pas de max-width ni margin - la grille gère tout */
    }
    
    .repasTypeCard:hover {
      border-color: rgba(110,231,255,0.55);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      transform: translateY(-2px);
    }
    
    .repasTypeEmoji {
      font-size: 56px;  /* Réduit de 64px à 56px */
      line-height: 1;
    }
    
    .repasTypeName {
      font-size: 13px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.3;
      min-height: 34px;  /* Hauteur fixe pour 2 lignes */
      max-height: 34px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;  /* Limite à 2 lignes */
      -webkit-box-orient: vertical;
    }
    
    /* ==================== SÉLECTIONS ACTUELLES (SIMPLIFIÉ) ==================== */
    
    .selectionsActuelles {
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .selectionsContainer {
      background: rgba(110,231,255,0.08);
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
      overflow: hidden;
    }
    
    /* Message si aucun aliment */
    .selectionsEmpty {
      font-size: 14px;
      font-weight: 800;
      color: var(--muted);
      font-style: italic;
      text-align: center;
      padding: 12px 16px;
    }
    
    /* Liste des aliments sélectionnés */
    .selectionsItems {
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.6;
      padding: 12px 16px;
    }
    
    /* Total de glucides (compact, juste le chiffre) */
    .selectionsTotalGlucides {
      background: rgba(110,231,255,0.15);
      padding: 8px 16px;
      font-size: 16px;
      font-weight: 950;
      color: var(--accent);
      text-align: center;
      border-top: 1px solid rgba(110,231,255,0.25);
    }
    
    /* ==================== FIN SÉLECTIONS ==================== */
    
    /* Grille d'aliments - AVEC SCROLL (2 lignes max) */
    .alimentsGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      max-width: 500px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      
      /* NOUVEAU : Limiter à 2 lignes avec scroll */
      max-height: 270px; /* 2 lignes complètes : 2×110 + 12 (gap) + 24 (padding) + marge */
      overflow-y: auto;
      padding: 12px; /* Padding égal partout */
      
      /* Scrollbar style */
      scrollbar-width: thin;
      scrollbar-color: rgba(110,231,255,0.4) transparent;
    }
    
    /* Scrollbar custom pour WebKit (Chrome, Safari) */
    .alimentsGrid::-webkit-scrollbar {
      width: 6px; /* Réduit à 6px pour être plus discret */
    }
    
    .alimentsGrid::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .alimentsGrid::-webkit-scrollbar-thumb {
      background: rgba(110,231,255,0.4);
      border-radius: 3px;
    }
    
    .alimentsGrid::-webkit-scrollbar-thumb:hover {
      background: rgba(110,231,255,0.6);
    }
    
    @media (min-width: 600px) {
      .alimentsGrid {
        /* 4 colonnes avec cartes plus petites et espacements égaux */
        grid-template-columns: repeat(4, 1fr);
        max-width: 720px;
        width: 100%;  /* Prend la largeur disponible */
        gap: 12px;
        padding: 12px; /* Espacement égal partout */
        max-height: 270px; /* 2 lignes complètes */
      }
    }
    
    .alimentCard {
      position: relative;
      background: var(--panel2);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 10px 6px; /* Réduit légèrement */
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px; /* Réduit légèrement */
      min-height: 110px; /* Réduit de 120px à 110px */
      width: 100%;
      box-sizing: border-box;
    }
    
    .alimentCard:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
      transform: translateY(-2px);
    }
    
    .alimentCard.selected {
      border-color: var(--good);
      background: rgba(52,211,153,0.12);
    }
    
    .alimentEmoji {
      font-size: 40px;  /* Réduit de 48px à 40px */
      line-height: 1;
    }
    
    .alimentNom {
      font-size: 12px;
      font-weight: 800;
      text-align: center;
      color: var(--text);
      line-height: 1.3;
      min-height: 31px;  /* Hauteur fixe pour 2 lignes (12px * 1.3 * 2) */
      max-height: 31px;  /* Force la hauteur */
      overflow: hidden;  /* Cache le texte qui dépasse */
      display: -webkit-box;
      -webkit-line-clamp: 2;  /* Limite à 2 lignes */
      -webkit-box-orient: vertical;
      word-break: break-word;  /* Force la coupure des mots longs */
      overflow-wrap: break-word;  /* Fallback */
      width: 100%;  /* Prend toute la largeur disponible */
      max-width: 100%;  /* Ne dépasse jamais 100% */
    }
    
    /* P2 Issue 7 — Champ glucides verrouillé par le wizard */
    #carbFast[readonly] {
      opacity: 0.55;
      cursor: not-allowed;
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.15) !important;
    }
    .carbWizardLock {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 10px;
      background: rgba(99,102,241,0.12);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }
    .carbWizardLock button {
      margin-left: auto;
      padding: 3px 10px;
      background: rgba(99,102,241,0.2);
      border: 1px solid rgba(99,102,241,0.4);
      border-radius: 6px;
      color: inherit;
      font-size: 11px;
      font-weight: 800;
      cursor: pointer;
    }
    .carbWizardLock button:hover {
      background: rgba(99,102,241,0.35);
    }

    .alimentPortion {
      font-size: 10px;
      font-weight: 500;
      color: var(--muted);
      opacity: 0.7;
      text-align: center;
      line-height: 1.2;
      margin-bottom: 2px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .alimentGlucides {
      font-size: 12px;
      font-weight: 900;
      color: var(--accent); /* #6ee7ff foncé · #0284c7 clair */
      font-variant-numeric: tabular-nums;
    }
    
    .alimentCheck {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--good);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 900;
    }
    
    /* Cartes spéciales */
    .alimentCardPlus {
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border-style: dashed;
    }
    
    .alimentCardPlus:hover {
      border-style: solid;
    }
    
    .alimentCardNone {
      background: rgba(251,113,133,0.08);
      border-color: rgba(251,113,133,0.35);
    }
    
    .alimentCardNone:hover {
      background: rgba(251,113,133,0.12);
      border-color: rgba(251,113,133,0.55);
    }
    
    /* Navigation */
    .wizardNavigation {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      max-width: 700px;  /* Réduit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    .btnPrimary, .btnSecondary {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btnPrimary {
      background: var(--good);
      color: white;
      flex: 1;
      min-width: 120px;
    }
    
    .btnPrimary:hover {
      background: #059669;
    }
    
    .btnPrimary.btnLarge {
      padding: 16px 32px;
      font-size: 16px;
    }
    
    .btnSecondary {
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btnSecondary:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
    }
    
    /* Total en bas */
    .wizardTotal {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
      font-size: 18px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      max-width: 700px;  /* Réduit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Récapitulatif */
    .recapRepas {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      max-width: 700px;  /* Réduit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    .recapRepas h3 {
      font-size: 20px;
      font-weight: 950;
      margin: 0 0 20px 0;
      text-align: center;
    }
    
    .recapSection {
      margin-bottom: 16px;
    }
    
    .recapSectionTitle {
      font-size: 14px;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .recapItem {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--panel2);
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 800;
    }
    
    .recapGlucides {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }
    
    /* Zone des totaux réorganisée */
    .recapTotaux {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Ligne des 2 blocs (glucides + IG) */
    .recapTotalItems {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Bloc individuel (glucides ou IG) */
    .recapTotalItem {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 24px 16px;
      border-radius: 16px;
      border: 1px solid;
    }
    
    /* Bloc Glucides (violet) */
    .recapTotalItem.glucides {
      background: rgba(110, 231, 255, 0.15); /* accent foncé #6ee7ff */
      border-color: rgba(110, 231, 255, 0.4);
    }
    
    /* Bloc IG - Couleur par défaut (neutre) */
    .recapTotalItem.ig {
      background: rgba(244, 114, 182, 0.15); /* Rose transparent par défaut */
      border-color: rgba(244, 114, 182, 0.4);
    }
    
    /* Bloc IG - IG BAS (< 55) - Vert - SPÉCIFICITÉ RENFORCÉE */
    .recapTotalItem.ig.ig-low,
    .recapRepas .recapTotalItem.ig.ig-low {
      background: rgba(52, 211, 153, 0.15) !important; /* Vert transparent */
      border-color: rgba(52, 211, 153, 0.4) !important;
    }
    
    /* Bloc IG - IG MOYEN (55-69) - Jaune/Orange - SPÉCIFICITÉ RENFORCÉE */
    .recapTotalItem.ig.ig-medium,
    .recapRepas .recapTotalItem.ig.ig-medium {
      background: rgba(251, 191, 36, 0.15) !important; /* Jaune transparent */
      border-color: rgba(251, 191, 36, 0.4) !important;
    }
    
    /* Bloc IG - IG ÉLEVÉ (≥ 70) - Rouge - SPÉCIFICITÉ RENFORCÉE */
    .recapTotalItem.ig.ig-high,
    .recapRepas .recapTotalItem.ig.ig-high {
      background: rgba(251, 113, 133, 0.15) !important; /* Rouge transparent */
      border-color: rgba(251, 113, 133, 0.4) !important;
    }
    
    .recapTotalLabel {
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .recapTotalLabel .emoji {
      font-size: 24px;
    }
    
    .recapTotalValue {
      font-size: 48px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }
    .recapTotalItem.glucides .recapTotalValue {
      color: var(--accent); /* #6ee7ff foncé · #0284c7 clair */
    }
    
    /* Bloc Conseil (sous les totaux) */
    .recapConseil {
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      padding: 16px 20px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 900;
      text-align: center;
      line-height: 1.4;
    }
    
    .recapConseil .icon {
      font-size: 24px;
      margin-right: 8px;
    }
    
    /* Responsive : empiler les blocs sur mobile */
    @media (max-width: 600px) {
      .recapTotalItems {
        grid-template-columns: 1fr;
      }
    }
    
    :root[data-theme="clair"] .recapConseil {
      background: rgba(255,255,255,0.5);
    }
    
    :root[data-theme="clair"] .recapTotalItem.glucides {
      background: rgba(2, 132, 199, 0.15); /* accent clair #0284c7 */
      border-color: rgba(2, 132, 199, 0.4);
    }
    
    :root[data-theme="clair"] .recapTotalItem.ig {
      background: rgba(244, 114, 182, 0.25);
    }
    
    /* Accordéon pour la liste des aliments */
    .recapAccordeon {
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .recapAccordeonBtn {
      width: 100%;
      padding: 14px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .recapAccordeonBtn:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
    }
    
    #recapAccordeonIcon {
      font-size: 12px;
      transition: transform 0.3s ease;
    }
    
    .recapAliments {
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Mode sombre / clair */
    :root[data-theme="clair"] .repasTypeCard,
    :root[data-theme="clair"] .alimentCard {
      background: rgba(255,255,255,0.7);
    }
    
    :root[data-theme="clair"] .alimentCard.selected {
      background: rgba(52,211,153,0.2);
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Aller au contenu</a>

<div class="wrap">
  <header>
  <div class="headerLeft">
    <img class="logo" src="assets/img/favicon-96.png" alt="Logo AC BOLUS">
    <div class="titleBlock">
      <h1>AC Bolus</h1>
      <div class="sub">Outil éducatif — calcul bolus</div>
    </div>
  </div>

  <div class="headerRight">
    <button id="simpleBtn" class="btn" type="button" aria-pressed="false" aria-label="Activer le mode simple"><span id="simpleBtnIcon" aria-hidden="true">🔭</span> <span id="simpleText">Mode simple</span></button>
    <a href="top10.html" class="btn btn-ghost" aria-label="Top aliments" title="Top aliments consommés" style="display:inline-flex;align-items:center;justify-content:center;text-decoration:none;"><span aria-hidden="true">🏆</span></a>
    <button id="settingsBtn" class="btn btn-ghost" type="button" aria-expanded="false" aria-controls="settingsPanel" aria-label="Mes ratios"><span aria-hidden="true">⚙️</span></button>
    <button id="themeBtn" class="btn btn-ghost" type="button" aria-pressed="false" aria-label="Changer le thème"><span id="themeIcon" class="iconSpin" aria-hidden="true"></span></button>
  </div>
</header>

  <main id="main" class="wrap" style="padding:0; gap:14px" role="main">
    <section class="card">
      <div class="pillbar">
        <div class="pills" aria-label="Résumé">
          <div class="pill">
            <span id="pillDot" class="dotGly" aria-hidden="true"></span>
            🩸 <span class="pill-label">Glycémie</span> : <strong id="pillGly">—</strong> <span id="pillGlyUnit">mg/dL</span>
          </div>
          <div class="pill">🍬 <span class="pill-label">Glucides</span> : <strong id="pillCarbs">—</strong> g</div>
          <div class="pill">🎯 <span class="pill-label">Objectif</span> : <strong id="pillTarget">—</strong> mg/dL</div>
        </div>
      </div>

      <!-- Alerte "ratios obligatoires" (temps réel) -->
      <div id="ratioAlert" class="alertBanner" role="status" aria-live="polite" aria-atomic="true">
        ⚠️ Complète les insulines quotidiennes avant tout calcul :
        <span>Basale ≥ <strong>20 U</strong> et Rapide ≥ <strong>10 U</strong>.</span>
      </div>

      <div id="settingsPanel" class="hidden" style="margin-top:12px">
        <div class="row2">
          <label>
            <div class="label">Objectif glycémie (mg/dL)</div>
            <div class="fieldLine">
              <input id="objectif" type="text" inputmode="numeric" min="70" max="180" step="1" value="110">
              <div id="objectifErr" class="fieldError" role="status" aria-live="polite">⚠️ 70–180</div>
            </div>
          </label>

          <label>
            <div class="label">Arrondi affiché</div>
            <select id="arrondi" aria-label="Arrondi de dose">
              <option value="0.1" selected>0,1 U (stylo)</option>
              <option value="0.5">0,5 U</option>
              <option value="1">1 U</option>
            </select>
            <div style="margin-top:8px; color:var(--muted); font-size:12px">On arrondit seulement l'affichage, pas les calculs internes.</div>
          </label>
        </div>

        <details open>
          <summary>🧮 Insulines quotidiennes (obligatoire)</summary>
          <p style="margin:8px 0 0; color:var(--muted); font-size:12px">
            <strong>DTQ</strong> = Basale + Rapide
            &nbsp;·&nbsp;
            <strong>ICR</strong> = 500 ÷ DTQ <em>(g de glucides couverts par 1 U)</em>
            &nbsp;·&nbsp;
            <strong>FSI</strong> = 1800 ÷ DTQ <em>(<span id="fsiDefUnit">mg/dL</span> abaissé par 1 U)</em>
          </p>

          <div class="row2" style="margin-top:12px">
            <label>
              <div class="label">Insuline basale (U / jour) — 20 à 35</div>
              <div class="fieldLine">
                <input id="basale" type="text" inputmode="decimal" min="20" max="35" step="0.5" value="" placeholder="20–35">
                <div id="basaleErr" class="fieldError" role="status" aria-live="polite">⚠️ 20–35</div>
              </div>
            </label>

            <label>
              <div class="label">Insuline rapide totale (U / jour) — 10 à 25</div>
              <div class="fieldLine">
                <input id="rapide" type="text" inputmode="decimal" min="10" max="25" step="0.5" value="" placeholder="10–25">
                <div id="rapideErr" class="fieldError" role="status" aria-live="polite">⚠️ 10–25</div>
              </div>
            </label>
          </div>

          <div class="metrics" aria-label="Valeurs calculées">
            <div class="metric"><div class="k">DTQ (U/j)</div><div id="dtq" class="v">—</div></div>
            <div class="metric"><div class="k">ICR — 500÷DTQ (g/U)</div><div id="icr" class="v">—</div></div>
            <div class="metric"><div class="k">FSI — 1800÷DTQ (<span id="fsiMetricUnit">mg/dL</span>/U)</div><div id="fsi" class="v">—</div></div>
          </div>
          <div id="fsiWarn" class="fieldError" role="alert" aria-live="assertive" style="display:none; margin-top:8px;"></div>
        </details>

        <details>
          <summary>⚠️ Note de sécurité</summary>
          <p>
            Outil éducatif pour comprendre le calcul (glucides / correction). Ne remplace pas un avis médical ni un protocole. Vérifie toujours les unités et les valeurs avant injection.
          </p>
        </details>

        <!-- P1 Issue 4 — Ce que l'outil fait / ne fait pas -->
        <details>
          <summary>📌 Ce que l'outil fait / ne fait pas</summary>
          <div class="dosDonts">
            <div class="dosDontsCol dosDo">
              <div class="dosDontsTitle">✅ Ce que l'outil fait</div>
              <ul>
                <li>Aide à comprendre le calcul théorique d'un bolus à partir des glucides, d'un ratio et d'une sensibilité.</li>
                <li>Illustre l'impact pédagogique de l'index glycémique (IG) et de la charge glycémique (CG).</li>
                <li>Permet d'explorer différents scénarios alimentaires.</li>
              </ul>
            </div>
            <div class="dosDontsCol dosDont">
              <div class="dosDontsTitle">❌ Ce que l'outil ne fait pas</div>
              <ul>
                <li>Ne remplace pas un professionnel de santé.</li>
                <li>Ne constitue pas une recommandation médicale personnalisée.</li>
                <li>Ne prend pas en compte l'activité physique, les insulines spécifiques, les situations d'hypoglycémie sévère, maladie, pompe, boucle fermée, etc.</li>
                <li>Ne doit pas être utilisé comme unique base de décision thérapeutique.</li>
              </ul>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- MODE RAPIDE -->
    <section id="panelFast" class="card" role="tabpanel" aria-labelledby="tabFast">
      <!-- CHAMPS GLYCÉMIE + GLUCIDES (Toujours visibles, EN HAUT) -->
      <div class="row2" style="margin-top:12px">
        <div class="stepper">
          <div class="label label-large">
            <span id="labelDotFast" class="dotGly" aria-hidden="true"></span>
            <span class="label-icon">🩸</span> Glycémie actuelle (<span id="glyUnitLabel">mg/dL</span>)
          </div>
          <div class="fieldLine">
            <input id="glyFast" type="text" inputmode="decimal" min="50" step="1" value="" placeholder="Entre 50 et 500">
            <div id="glyFastErr" class="fieldError" role="status" aria-live="polite">⚠️ Glycémie hors plage (50–500 mg/dL ou 0.5–6 g/L).</div>
            <div id="glyDangerBadge" role="alert" aria-live="assertive" style="display:none; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4;"></div>
          </div>
        </div>

        <div class="stepper">
          <div class="label label-large">
            <span class="label-icon">🍬</span> Glucides du repas (g)
          </div>
          <div class="fieldLine">
            <input id="carbFast" type="text" inputmode="numeric" min="0" max="200" step="1" value="" placeholder="Entre 0 et 200">
            <div id="carbFastErr" class="fieldError" role="status" aria-live="polite">⚠️ Glucides hors plage (0 à 200).</div>
            <div id="carbWizardLockBadge" class="carbWizardLock" style="display:none;" role="status" aria-live="polite">
              🔒 Valeur saisie via le repas
              <button id="carbUnlockBtn" type="button" aria-label="Modifier manuellement les glucides">🔓 Modifier</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RÉSULTATS avec bouton toggle -->
      <div style="position: relative; overflow: visible;">
        <!-- Bouton toggle (mode simple uniquement) -->
        <button id="toggleDetailsBtn" 
                class="toggle-details-btn hide-in-advanced" 
                onclick="toggleBolusDetails()" 
                aria-label="Afficher les détails"
                aria-expanded="false">
          <span id="toggleDetailsIcon">+</span>
        </button>
        
        <div id="resultsFastGrid" class="results" aria-label="Résultats rapides">
          <div id="corrFastBox" class="res bolus-detail">
            <div class="k">Correction</div><div id="corrFast" class="v">—</div>
          </div>
          <div id="repasFastBox" class="res bolus-detail">
            <div class="k">Repas</div><div id="repasFast" class="v">—</div>
          </div>
          <div class="res total">
            <div class="k">Bolus conseillé</div><div id="totalFast" class="v">—</div>
            <div id="totalDetail" class="total-detail" aria-label="Détail du calcul d'arrondi"></div>
            <!-- P0 Issue 6 — Bloc hypo dédié -->
            <div id="hypoBlock" role="alert" aria-live="assertive">
              <div class="hypoTitle">⛔ 0 U — Glycémie Basse | Pas de Bolus | Resucrage recommandé</div>
              Suis ton plan hypoglycémie et demande à un adulte/soignant.
            </div>
            <!-- P1 Issue 3 — Disclaimer éducatif -->
            <div id="resultDisclaimer" role="note" aria-live="polite">
              ℹ️ Estimation pour apprendre. Fais valider par un adulte/soignant.
            </div>
          </div>
        </div>
      </div>

      <!-- RATIOS (Seulement en mode initié) -->
      <div id="ratioBadgesFast" class="miniBadges hide-in-simple" aria-label="Ratios utilisés (rapide)">
        <span class="badge" title="1 unité d'insuline couvre X grammes de glucides">
          ICR : <strong id="icrBadgeFast">—</strong> g/U
          <span class="badgeHint">1U → <strong id="icrBadgeHintVal">—</strong> g glucides</span>
        </span>
        <span class="badge" title="1 unité d'insuline abaisse la glycémie de X">
          FSI : <strong id="fsiBadgeFast">—</strong> <span id="fsiBadgeUnit">mg/dL</span>/U
          <span class="badgeHint">1U ↓ glycémie de <strong id="fsiBadgeHintVal">—</strong> <span id="fsiBadgeHintUnit">mg/dL</span></span>
        </span>
      </div>

      <!-- MESSAGE STATUS : Résultat de la composition du repas -->
      <div id="statusFast" class="status" role="status" aria-live="polite" aria-atomic="true"></div>

      <!-- BOUTONS COMPOSITION REPAS (Mode simple uniquement) -->
      <div id="repasButtonsSimple" class="hide-in-advanced" style="margin: 16px 0;">
        <div style="text-align: center; margin-bottom: 12px;">
          <h3 style="font-size: 16px; font-weight: 900; color: var(--text); margin: 0;">🌟 Compose ton repas</h3>
          <p style="font-size: 13px; color: var(--muted); margin: 4px 0 0 0;">Choisis le type de repas</p>
        </div>
        <div class="repasTypeGrid" style="margin: 0 auto;">
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('petit_dejeuner')" type="button">
            <div class="repasTypeEmoji">🌅</div>
            <div class="repasTypeName">PETIT-DÉJ</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('dejeuner')" type="button">
            <div class="repasTypeEmoji">🍽️</div>
            <div class="repasTypeName">DÉJEUNER</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('gouter')" type="button">
            <div class="repasTypeEmoji">🧁</div>
            <div class="repasTypeName">GOÛTER</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('diner')" type="button">
            <div class="repasTypeEmoji">🌙</div>
            <div class="repasTypeName">DÎNER</div>
          </button>
        </div>
      </div>

      <!-- WIZARD MODE SIMPLE : Modale avec overlay -->
      <div id="wizardOverlay">
        <div id="wizardModal">
          <button class="wizardCloseBtn" onclick="simpleModeWizard.fermerWizard()" aria-label="Fermer">✕</button>
          <div id="simpleModeContainer">
            <!-- Le wizard s'affichera ici dynamiquement -->
          </div>
        </div>
      </div>

      <!-- CONTENU MODE INITIÉ UNIQUEMENT -->
      <div id="fastCalculatorFields" class="hide-in-simple">
      <!-- Bouton pour composer le repas (mode initié uniquement) -->
      <button 
        id="foodSearchToggle" 
        class="foodSearchToggle" 
        type="button"
        aria-expanded="false"
      >
        <span class="btn-emoji">🍽️</span> Composer mon repas
      </button>

      <!-- Panneau de recherche d'aliments -->
      <div id="foodSearchPanel" class="hidden">
        <!-- Recherche -->
        <div class="searchBox">
          <span class="searchIcon">🔍</span>
          <input 
            type="text" 
            id="foodSearchInput" 
            placeholder="Rechercher un aliment..."
            autocomplete="off"
          >
        </div>

        <!-- Toggle vue 100g / portion -->
        <div class="searchViewToggle" id="searchViewToggle" style="display:none;">
          <span>Afficher :</span>
          <div class="viewToggleBtn" role="group" aria-label="Mode d'affichage des glucides">
            <button id="viewBtnPortion" class="active" onclick="setSearchView('portion')" aria-pressed="true">
              🍽️ Par portion
            </button>
            <button id="viewBtn100g" onclick="setSearchView('100g')" aria-pressed="false">
              📊 Pour 100g
            </button>
          </div>
        </div>

        <!-- Résultats de recherche -->
        <div id="searchResults" class="searchResults" data-view="portion"></div>

        <!-- Mon assiette -->
        <div class="myPlate">
          <h4>🍽️ Mon assiette</h4>
          <div id="plateItems"></div>
          <div id="plateSummary"></div>
        </div>

        <!-- Bouton validation -->
        <button 
          id="validateMealBtn" 
          class="validateMealBtn"
          type="button"
          disabled
        >
          ✅ Valider mon repas
        </button>
      </div>
      </div><!-- Fin fastCalculatorFields -->
    </section>

    <footer>
      <span class="footerDisclaimer" role="note">⚠️ Outil éducatif. Ne remplace pas un avis médical.<br>Toute décision thérapeutique doit être validée avec un professionnel de santé.</span>
      <span class="footerDisclaimer footerDisclaimerSchool" role="note">🏫 En contexte scolaire, cet outil doit être utilisé avec un adulte formé et selon le protocole établi avec l'équipe médicale.</span>
      Tout reste sur ton appareil. Le thème et le mode simple sont enregistrés en local.
    </footer>
  </main>
</div>

<script>
(() => {
  "use strict";

  // -------------------- Helpers --------------------
  const $ = (id) => document.getElementById(id);

  const Util = {
    toNumber(v){
      if(v === null || v === undefined) return NaN;
      const s = String(v).trim().replace(",", ".");
      if(s === "") return NaN;
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    },
    clamp(n, min, max){
      if(!Number.isFinite(n)) return NaN;
      return Math.min(max, Math.max(min, n));
    },
    roundToStep(n, step){
      if(!Number.isFinite(n)) return NaN;
      const s = Number(step);
      const safeStep = (Number.isFinite(s) && s > 0) ? s : 0.1;
      return Math.round(n / safeStep) * safeStep;
    }
  };

  const rangeOk = (n, min, max) => Number.isFinite(n) && n >= min && n <= max;

  // -------------------- Constants --------------------
  const GLY_MIN = 50, GLY_MAX = 600; // P0 audit: warning fort >600, blocage g/L >10
  const CARB_MIN = 0, CARB_MAX = 200;
  const TARGET_MIN = 70, TARGET_MAX = 180;

  const MIN_BASALE = 20, MAX_BASALE = 35;
  const MIN_RAPIDE = 10,  MAX_RAPIDE = 25;
  // P0 Issue 3 — FSI inversé : plage physiologique acceptable du FSI calculé
  const FSI_MIN = 10,  FSI_MAX = 150;  // mg/dL/U — blocage si FSI < 5 (critère audit)

  // -------------------- AppStorage (inline) --------------------
  // AppStorage doit être disponible avant l'objet Storage ci-dessous.
  // On l'embarque ici plutôt que de le charger via <script src> externe,
  // car le script inline s'exécute AVANT les scripts du bas du <body>.
  // Le fichier storage.js externe reste chargé pour food-search-ui.js.
  // Les deux définitions sont identiques — window.AppStorage est le point commun.
  if (!window.AppStorage) {
    window.AppStorage = (() => {
      const ENVELOPE_VERSION = 1;

      function get(key, opts = {}) {
        const { maxAge, schemaVersion } = opts;
        let raw;
        try { raw = localStorage.getItem(key); } catch (e) { return null; }
        if (raw === null) return null;
        let envelope;
        try { envelope = JSON.parse(raw); } catch (e) { localStorage.removeItem(key); return null; }
        if (!envelope || typeof envelope !== 'object' || envelope.v !== ENVELOPE_VERSION) {
          localStorage.removeItem(key); return null;
        }
        if (schemaVersion !== undefined && envelope.sv !== schemaVersion) {
          localStorage.removeItem(key); return null;
        }
        const now = Date.now();
        if (maxAge !== undefined) {
          if (!Number.isFinite(envelope.savedAt) || now - envelope.savedAt > maxAge) {
            localStorage.removeItem(key); return null;
          }
        } else if (envelope.expiresAt !== null && Number.isFinite(envelope.expiresAt)) {
          if (now > envelope.expiresAt) { localStorage.removeItem(key); return null; }
        }
        return envelope.data;
      }

      function set(key, value, opts = {}) {
        const { ttl, schemaVersion } = opts;
        const now = Date.now();
        const envelope = {
          v: ENVELOPE_VERSION,
          sv: schemaVersion !== undefined ? schemaVersion : null,
          savedAt: now,
          expiresAt: (ttl !== undefined && Number.isFinite(ttl)) ? now + ttl : null,
          data: value
        };
        try { localStorage.setItem(key, JSON.stringify(envelope)); return true; }
        catch (e) { return false; }
      }

      function clear(key) {
        try { localStorage.removeItem(key); } catch (_) {}
      }

      const KEYS = {
        theme:      'bc_theme',
        simpleMode: 'bc_simple',
        ratios:     'bc_ratios',
        lastCarbs:  'bc_last_carbs',
        meal:       'bc_meal_composition',
      };
      const SCHEMA = { ratios: 2, meal: 2 };
      const TTL    = { ratios: 3 * 24 * 60 * 60 * 1000, meal: 8 * 60 * 60 * 1000 };

      return { get, set, clear, KEYS, SCHEMA, TTL };
    })();
  }
  // Alias local pour raccourcir les appels dans ce script
  const AppStorage = window.AppStorage;

  // -------------------- BolusMath (inline) --------------------
  // Même raison que AppStorage : le script inline s'exécute avant les <script src>.
  // Les fichiers bolusMath.js et units.js externes restent chargés pour usage futur.
  if (!window.BolusMath) {
    window.BolusMath = (() => {
      const ICR_CONSTANT = 500;
      const FSI_CONSTANT = 1800;
      function _positif(n) { return Number.isFinite(n) && n > 0; }

      function calcRatios(basale, rapide) {
        if (!Number.isFinite(basale) || !Number.isFinite(rapide)) return { dtq: NaN, icr: NaN, fsi: NaN };
        const dtq = basale + rapide;
        if (!_positif(dtq)) return { dtq: NaN, icr: NaN, fsi: NaN };
        return { dtq, icr: ICR_CONSTANT / dtq, fsi: FSI_CONSTANT / dtq };
      }
      function calcCorrection(glycemie, objectif, fsi) {
        if (!Number.isFinite(glycemie) || !Number.isFinite(objectif) || !_positif(fsi)) return NaN;
        return (glycemie - objectif) / fsi;
      }
      function calcRepas(glucides, icr) {
        if (!Number.isFinite(glucides) || glucides < 0 || !_positif(icr)) return NaN;
        return glucides / icr;
      }
      function calcTotal(correction, repas) {
        if (!Number.isFinite(correction) || !Number.isFinite(repas)) return NaN;
        return correction + repas;
      }
      const STEP_DEFAULT = 0.1;
      function roundToStep(n, step) {
        if (!Number.isFinite(n)) return NaN;
        const s = Number(step);
        const safeStep = (Number.isFinite(s) && s > 0) ? s : STEP_DEFAULT;
        return Math.round(n / safeStep) * safeStep;
      }
      function clamp(n, min, max) {
        if (!Number.isFinite(n)) return NaN;
        return Math.min(max, Math.max(min, n));
      }
      function calcBolus({ glycemie, objectif, glucides, basale, rapide, step = 0.1 }) {
        const { dtq, icr, fsi } = calcRatios(basale, rapide);
        const correction   = calcCorrection(glycemie, objectif, fsi);
        const repas        = calcRepas(glucides, icr);
        const total        = calcTotal(correction, repas);
        const totalArrondi = roundToStep(total, step);
        return { correction, repas, total, totalArrondi, dtq, icr, fsi };
      }
      return { calcRatios, calcCorrection, calcRepas, calcTotal, calcBolus, roundToStep, clamp, ICR_CONSTANT, FSI_CONSTANT };
    })();
  }
  const BolusMath = window.BolusMath;

  if (!window.GlyUnits) {
    window.GlyUnits = (() => {
      const GL_TO_MGDL = 100, MGDL_TO_GL = 1/100, MMOL_TO_MGDL = 18.016, MGDL_TO_MMOL = 1/18.016;
      const RANGE = { min: 20, max: 600 };
      function _parse(str) {
        if (str === null || str === undefined) return NaN;
        const s = String(str).trim().replace(',', '.');
        if (s === '') return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }
      function mgdlToGl(v)  { const n = _parse(v); return Number.isFinite(n) ? n * MGDL_TO_GL : NaN; }
      function glToMgdl(v)  { const n = _parse(v); return Number.isFinite(n) ? n * GL_TO_MGDL : NaN; }
      function mgdlToMmol(v){ const n = _parse(v); return Number.isFinite(n) ? n * MGDL_TO_MMOL : NaN; }
      function mmolToMgdl(v){ const n = _parse(v); return Number.isFinite(n) ? n * MMOL_TO_MGDL : NaN; }
      function parseGly(str, opts = {}) {
        const n = _parse(str);
        if (!Number.isFinite(n)) return NaN;
        if (!opts.allowOutOfRange && (n < RANGE.min || n > RANGE.max)) return NaN;
        return n;
      }
      function parseGlyGl(str) {
        const gl = _parse(str);
        if (!Number.isFinite(gl)) return NaN;
        const mgdl = glToMgdl(gl);
        if (!Number.isFinite(mgdl) || mgdl < RANGE.min || mgdl > RANGE.max) return NaN;
        return mgdl;
      }
      function formatMgdl(v) { return Number.isFinite(v) ? String(Math.round(v)) : '—'; }
      function formatGl(v)   { return Number.isFinite(v) ? v.toFixed(1) : '—'; }
      function detectUnit(str) {
        const n = _parse(str);
        if (!Number.isFinite(n)) return 'unknown';
        if (n >= RANGE.min && n <= RANGE.max) return 'mgdl';
        if (n > 0 && n < RANGE.min) { const m = glToMgdl(n); if (m >= RANGE.min && m <= RANGE.max) return 'gl'; }
        return 'unknown';
      }
      return { mgdlToGl, glToMgdl, mgdlToMmol, mmolToMgdl, parseGly, parseGlyGl, formatMgdl, formatGl, detectUnit, GL_TO_MGDL, MGDL_TO_GL, MMOL_TO_MGDL, MGDL_TO_MMOL, RANGE };
    })();
  }
  const GlyUnits = window.GlyUnits; // eslint-disable-line no-unused-vars (utilisé pour usage futur)

  // -------------------- Storage --------------------
  // Wrapper mince qui mappe les méthodes de l'app vers AppStorage.
  const Storage = {

    getTheme(){
      return AppStorage.get(AppStorage.KEYS.theme) || 'clair';
    },
    setTheme(v){
      AppStorage.set(AppStorage.KEYS.theme, v); // pas de TTL : persistant
    },

    getSimple(){
      const val = AppStorage.get(AppStorage.KEYS.simpleMode);
      if (val === null) return true; // mode simple par défaut si jamais configuré
      return val === true || val === '1' || val === 1;
    },
    setSimple(v){
      AppStorage.set(AppStorage.KEYS.simpleMode, v ? '1' : '0'); // pas de TTL : persistant
    },

    getLastCarbs(){
      const n = AppStorage.get(AppStorage.KEYS.lastCarbs);
      if (n === null) return null;
      const parsed = typeof n === 'number' ? n : Util.toNumber(String(n));
      return Number.isFinite(parsed) ? parsed : null;
    },
    setLastCarbs(v){
      if (Number.isFinite(v)) AppStorage.set(AppStorage.KEYS.lastCarbs, v); // persistant
    },

    // Ratios persistés 3 jours — avec schemaVersion
    getRatios(){
      const o = AppStorage.get(AppStorage.KEYS.ratios, {
        schemaVersion: AppStorage.SCHEMA.ratios
      });
      if (!o || typeof o !== 'object') return null;
      const r = {
        basale:  Util.toNumber(o.basale),
        rapide:  Util.toNumber(o.rapide),
        objectif: Util.toNumber(o.objectif),
        step:    Util.toNumber(o.step)
      };
      // Vérification minimaliste : basale et rapide doivent être des nombres finis
      if (!Number.isFinite(r.basale) || !Number.isFinite(r.rapide)) return null;
      return r;
    },
    setRatios({ basale, rapide, objectif, step }){
      AppStorage.set(
        AppStorage.KEYS.ratios,
        { basale, rapide, objectif, step },
        { ttl: AppStorage.TTL.ratios, schemaVersion: AppStorage.SCHEMA.ratios }
      );
    },
    clearRatios(){
      AppStorage.clear(AppStorage.KEYS.ratios);
    }
  };

  // -------------------- DOM --------------------
  const el = {
    // header / toggles
    themeBtn: $("themeBtn"),
    themeIcon: $("themeIcon"),
    simpleBtn: $("simpleBtn"),
    simpleBtnIcon: $("simpleBtnIcon"),
    simpleText: $("simpleText"),

    // settings
    settingsBtn: $("settingsBtn"),
    settingsPanel: $("settingsPanel"),
    ratioAlert: $("ratioAlert"),

    basale: $("basale"),
    rapide: $("rapide"),
    objectif: $("objectif"),
    arrondi: $("arrondi"),

    basaleErr: $("basaleErr"),
    rapideErr: $("rapideErr"),
    objectifErr: $("objectifErr"),

    // fast inputs
    glyFast: $("glyFast"),
    carbFast: $("carbFast"),
    carbWizardLockBadge: $("carbWizardLockBadge"),
    glyFastErr: $("glyFastErr"),
    glyDangerBadge: $("glyDangerBadge"),
    carbFastErr: $("carbFastErr"),

    // unit labels (dynamic)
    glyUnitLabel: $("glyUnitLabel"),
    pillGlyUnit: $("pillGlyUnit"),

    // unit labels (dynamic)
    glyUnitLabel: $("glyUnitLabel"),
    pillGlyUnit: $("pillGlyUnit"),

    // pills
    pillGly: $("pillGly"),
    pillCarbs: $("pillCarbs"),
    pillTarget: $("pillTarget"),
    dtq: $("dtq"),
    icr: $("icr"),
    fsi: $("fsi"),
    fsiWarn: $("fsiWarn"),
    icrBadgeFast: $("icrBadgeFast"),
    fsiBadgeFast: $("fsiBadgeFast"),
    // P0 Issue 5 — Unités FSI/ICR dynamiques
    icrBadgeHintVal: $("icrBadgeHintVal"),
    fsiBadgeUnit:    $("fsiBadgeUnit"),
    fsiBadgeHintVal: $("fsiBadgeHintVal"),
    fsiBadgeHintUnit:$("fsiBadgeHintUnit"),
    fsiDefUnit:      $("fsiDefUnit"),
    fsiMetricUnit:   $("fsiMetricUnit"),

    // results
    corrFast: $("corrFast"),
    repasFast: $("repasFast"),
    totalFast: $("totalFast"),
    totalDetail: $("totalDetail"),

    statusFast: $("statusFast"),
    status: $("status"),
    // P0 Issue 6 — Bloc hypo dédié + P1 Issue 3 — Disclaimer
    hypoBlock:        $("hypoBlock"),
    resultDisclaimer: $("resultDisclaimer")
  };

  // -------------------- UI State --------------------
  const Touched = { gly:false, carbs:false, objectif:false, basale:false, rapide:false };
  let simpleMode = false;
  // Note : window.simpleModeWizard est géré par app.js (bootstrap unique)

  // -------------------- Theme --------------------
  function applyTheme(theme){
    document.documentElement.dataset.theme = theme;
    if(el.themeIcon) el.themeIcon.textContent = (theme === "sombre") ? "🌙" : "☀️";
  }

  function initTheme(){
    const t = Storage.getTheme();
    applyTheme(t);
  }

  function toggleTheme(){
    const cur = Storage.getTheme();
    const next = (cur === "clair") ? "sombre" : "clair";
    Storage.setTheme(next);
    applyTheme(next);
  }

  // -------------------- Simple mode --------------------
  function applySimpleMode(){
    if(el.simpleBtn) el.simpleBtn.setAttribute("aria-pressed", String(simpleMode));
    if(el.simpleText) el.simpleText.textContent = simpleMode ? "Mode simple" : "Mode initié";
    
    // Changer l'icône du bouton toggle
    if(el.simpleBtnIcon){
      el.simpleBtnIcon.textContent = simpleMode ? "🌟" : "🔭";
    }
    
    document.body.classList.toggle("simple-mode", !!simpleMode);
    
    // NOUVEAU : Gérer l'affichage wizard vs contenu mode initié
    const wizardContainer = document.getElementById('simpleModeContainer');
    const initiatedContent = document.getElementById('fastCalculatorFields');
    
    if(simpleMode){
      // MODE SIMPLE : Afficher le wizard, cacher le contenu mode initié
      if(wizardContainer) {
        wizardContainer.classList.remove('hidden');
        // Initialiser le wizard (instance gérée par app.js)
        if(window.simpleModeWizard){
          // Ne pas rappeler init() (déjà fait par app.js au boot).
          // On veut simplement afficher l'écran d'accueil du wizard.
          window.simpleModeWizard.afficherChoixRepas();
        }
      }
      if(initiatedContent) initiatedContent.classList.add('hidden');
      
      // Les champs Glycémie et Glucides restent TOUJOURS visibles
      // Les détails (Correction, Repas, ICR, FSI) sont cachés par CSS (.hide-in-simple)
    } else {
      // MODE INITIÉ : Cacher le wizard, afficher le contenu mode initié
      if(wizardContainer) wizardContainer.classList.add('hidden');
      if(initiatedContent) initiatedContent.classList.remove('hidden');
      
      // Tous les détails sont visibles
    }
  }

  function toggleSimpleMode(){
    simpleMode = !simpleMode;
    Storage.setSimple(simpleMode);
    applySimpleMode();
    render();
  }

  // -------------------- Toggle détails bolus (mode simple) --------------------
  function toggleBolusDetails() {
    const isShowing = document.body.classList.toggle('show-bolus-details');
    const btn = document.getElementById('toggleDetailsBtn');
    const icon = document.getElementById('toggleDetailsIcon');
    if (btn && icon) {
      icon.textContent = isShowing ? '−' : '+';
      btn.setAttribute('aria-expanded', String(isShowing));
      btn.setAttribute('aria-label', isShowing ? 'Masquer les détails' : 'Afficher les détails');
    }
    
    // Recalculer et afficher les valeurs
    render();
  }
  
  // Rendre la fonction accessible globalement
  window.toggleBolusDetails = toggleBolusDetails;

  // -------------------- Field errors --------------------
  function setFieldError(inputEl, errEl, show){
    if(!inputEl || !errEl) return;
    inputEl.classList.toggle("input-error", !!show);
    errEl.classList.toggle("show", !!show);
  }

  // -------------------- Settings panel lock --------------------
  function setEditingRatios(isEditing){
    document.body.classList.toggle("editing-ratios", !!isEditing);
  }

  function toggleSettings(){
    if(!el.settingsPanel || !el.settingsBtn) return;
    const isOpen = !el.settingsPanel.classList.contains("hidden");
    el.settingsPanel.classList.toggle("hidden", isOpen);
    el.settingsBtn.setAttribute("aria-expanded", String(!isOpen));
    setEditingRatios(!isOpen);
    if(!isOpen){
      // opening: focus sur objectif glycémie pour accessibilité clavier
      setTimeout(() => {
        el.objectif?.focus();
      }, 100);
    }
  }

  // -------------------- Ratios / DTQ / ICR / FSI --------------------
  function ratiosInRange(basale, rapide){
    const ok = Number.isFinite(basale) && Number.isFinite(rapide)
      && basale >= MIN_BASALE && basale <= MAX_BASALE
      && rapide >= MIN_RAPIDE && rapide <= MAX_RAPIDE;
    return ok;
  }

  /**
   * Valide basale/rapide ET le FSI calculé résultant.
   * P0 Issue 3 : FSI hors plage [FSI_MIN, FSI_MAX] → warning + blocage si FSI < 5.
   */
  function updateRatioAlert(basale, rapide){
    const ok = ratiosInRange(basale, rapide);
    if(el.ratioAlert){
      el.ratioAlert.classList.toggle("show", !ok);
    }
    setFieldError(el.basale, el.basaleErr, Touched.basale && !(Number.isFinite(basale) && basale >= MIN_BASALE && basale <= MAX_BASALE));
    setFieldError(el.rapide, el.rapideErr, Touched.rapide && !(Number.isFinite(rapide) && rapide >= MIN_RAPIDE && rapide <= MAX_RAPIDE));

    // ── Validation du FSI calculé (P0 Issue 3) ─────────────────────────
    let fsiOk = true;
    if (el.fsiWarn) {
      if (ok) {
        const dtq = basale + rapide;
        const fsi = 1800 / dtq;
        if (fsi < 5) {
          // Blocage dur — FSI < 5 : correction serait dangereusement élevée
          el.fsiWarn.textContent = `🚫 FSI calculé : ${fsi.toFixed(1)} mg/dL/U — valeur impossible (< 5). Vérifiez vos doses d'insuline.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else if (fsi < FSI_MIN) {
          // Warning fort — FSI très bas (correction puissante)
          el.fsiWarn.textContent = `⚠️ FSI calculé : ${fsi.toFixed(1)} mg/dL/U — très sensible (norme : 10–150 mg/dL/U). Confirmez avec votre équipe soignante.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else if (fsi > FSI_MAX) {
          // Warning fort — FSI très élevé (correction faible, possible sous-dosage)
          el.fsiWarn.textContent = `⚠️ FSI calculé : ${fsi.toFixed(1)} mg/dL/U — valeur inhabituelle (norme : 10–150 mg/dL/U). Vérifiez vos doses.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else {
          el.fsiWarn.style.display = 'none';
          el.fsiWarn.textContent = '';
        }
      } else {
        el.fsiWarn.style.display = 'none';
        el.fsiWarn.textContent = '';
      }
    }
    // ───────────────────────────────────────────────────────────────────

    return ok && fsiOk;
  }

  function validateTarget(){
    const t = Util.toNumber(el.objectif?.value);
    const invalid = !rangeOk(t, TARGET_MIN, TARGET_MAX);
    setFieldError(el.objectif, el.objectifErr, Touched.objectif && invalid);
    return { target: t, ok: !invalid };
  }

  function computeRatios(basale, rapide){
    // Délègue à BolusMath — source unique de vérité pour ICR/FSI/DTQ
    return BolusMath.calcRatios(basale, rapide);
  }

  function readCommonParams(){
    const basale = Util.toNumber(el.basale?.value);
    const rapide = Util.toNumber(el.rapide?.value);
    const rawStep = Util.toNumber(el.arrondi?.value);
    const VALID_STEPS = [0.1, 0.5, 1];
    const step = VALID_STEPS.includes(rawStep) ? rawStep : 0.1;
    if (!VALID_STEPS.includes(rawStep) && el.arrondi) el.arrondi.value = '0.1';
    const tv = validateTarget();
    const ratiosOk = updateRatioAlert(basale, rapide);

    if(!ratiosOk || !tv.ok){
      return { basale, rapide, objectif: tv.target, step, ratiosOk:false, targetOk: tv.ok, dtq:NaN, icr:NaN, fsi:NaN };
    }
    const { dtq, icr, fsi } = computeRatios(basale, rapide);
    return { basale, rapide, objectif: tv.target, step, ratiosOk:true, targetOk:true, dtq, icr, fsi };
  }

  // -------------------- Sécurité P0 : popup confirmation unité glycémie --------------------
  let _lastGlyWarnValue = null; // anti-spam : ne répète pas le popup pour la même valeur

  /**
   * Affiche un popup de confirmation quand la valeur saisie est suspecte.
   * @param {number} rawVal  - Valeur brute saisie
   * @param {'mgdl-overflow'} type
   */
  function _showGlyUnitWarning(rawVal, type) {
    if (type === 'mgdl-overflow') {
      const asGl   = GlyUnits.mgdlToGl(rawVal);          // ex: 180 → 1.8 g/L
      const asMgdl = Math.round(rawVal);                   // la valeur telle que saisie
      const msg =
        `⚠️ Vérification unité glycémie\n\n` +
        `Vous avez saisi : ${asMgdl}\n\n` +
        `• En mg/dL → ${asMgdl} mg/dL (très élevé, hyperglycémie sévère)\n` +
        `• En g/L   → ${asMgdl} g/L = ${asMgdl * 100} mg/dL (valeur physiologiquement impossible)\n\n` +
        `Si vous êtes bien en mg/dL, la valeur sera acceptée.\n` +
        `Sinon, corrigez votre saisie ou changez d'unité.`;
      // Utilise window.confirm natif (synchrone, accessible, pas de dépendance)
      const confirmed = window.confirm(msg);
      if (!confirmed) {
        // Vider le champ → force re-saisie
        if (el.glyFast) {
          el.glyFast.value = '';
          _lastGlyWarnValue = null;
        }
      }
    }
  }

  // -------------------- Inputs validation (fast mode only) --------------------
  function validateMealInputs(){
    const rawGly = el.glyFast?.value ?? '';
    const c = Util.toNumber(el.carbFast?.value);

    // --- Détection automatique de l'unité glycémie ---
    const detectedUnit = GlyUnits.detectUnit(rawGly); // 'mgdl' | 'gl' | 'unknown'
    const rawNum = Util.toNumber(rawGly);
    let g;
    if (detectedUnit === 'gl') {
      g = GlyUnits.glToMgdl(rawGly);   // converti en mg/dL pour tous les calculs
    } else {
      g = rawNum;                        // mg/dL direct
    }

    // Mise à jour visuelle de l'unité détectée
    const unitLabel = detectedUnit === 'gl' ? 'g/L' : 'mg/dL';
    if (el.glyUnitLabel)  el.glyUnitLabel.textContent  = unitLabel;
    if (el.pillGlyUnit)   el.pillGlyUnit.textContent   = unitLabel;

    // ═══════════════════════════════════════════════════════════════════
    // SÉCURITÉ P0 — Détection confusion unités mg/dL ↔ g/L
    // ═══════════════════════════════════════════════════════════════════
    let glyErrMsg = '⚠️ Glycémie hors plage (50–500 mg/dL ou 0.5–6 g/L).';
    let glyHardBlock = false;

    if (Number.isFinite(rawNum) && rawNum > 0) {
      // CAS 1 : Saisie > 600 mg/dL → suspicion de saisie en g/L (ex: 180 g/L)
      // Critère audit : saisie > 600 mg/dL → warning fort
      if (detectedUnit !== 'gl' && rawNum > 600) {
        const asGl = GlyUnits.mgdlToGl(rawNum);
        glyErrMsg = `🚨 ${rawNum} mg/dL dépasse 600 — saisi en g/L ? (${rawNum} g/L = ${Math.round(rawNum * 100)} mg/dL). Vérifiez votre unité.`;
        // Déclenchement popup unique par valeur (évite le spam)
        if (Touched.gly && rawNum !== _lastGlyWarnValue) {
          _lastGlyWarnValue = rawNum;
          _showGlyUnitWarning(rawNum, 'mgdl-overflow');
        }
      }

      // CAS 2 : Saisie détectée g/L > 10 g/L → BLOCAGE (= 1000 mg/dL, impossible)
      // Critère audit : saisie > 10 g/L → blocage
      // Note : detectUnit retourne 'gl' pour 0.2–5.9, 'unknown' au-delà → on couvre les deux
      if ((detectedUnit === 'gl' && rawNum > 10) || (detectedUnit === 'unknown' && rawNum > 10 && rawNum < GLY_MIN)) {
        glyErrMsg = `🚫 ${rawNum} g/L est impossible (max physiologique ≈ 6 g/L = 600 mg/dL). Vérifiez votre saisie.`;
        glyHardBlock = true;
        g = NaN; // Force invalide — bloque le calcul
      }

      // CAS 3 : Valeur dans zone ambiguë (100–600) alors que l'utilisateur pourrait
      // avoir saisi en g/L sans le savoir (ex: "1.8" détecté g/L → 180 mg/dL, OK mais
      // on confirme visuellement pour rassurer)
    }
    // ═══════════════════════════════════════════════════════════════════

    const glyInvalid = glyHardBlock || !rangeOk(g, GLY_MIN, GLY_MAX);
    const carbInvalid = !rangeOk(c, CARB_MIN, CARB_MAX);

    // ═══════════════════════════════════════════════════════════════════
    // SÉCURITÉ P1 — Glycémie aberrante (Issue 4)
    // Badge rouge "valeur inhabituelle" pour glycémies sévères mais acceptées
    // ═══════════════════════════════════════════════════════════════════
    if (el.glyDangerBadge) {
      const gVal = Number.isFinite(g) ? g : rawNum; // valeur en mg/dL pour les seuils
      if (!glyInvalid && Number.isFinite(gVal)) {
        if (gVal >= 501) {
          // Seuil médical DKA/HHS : > 500 mg/dL → urgence métabolique potentielle
          el.glyDangerBadge.textContent = '🚨 Valeur critique (> 500 mg/dL) — Consultez immédiatement votre équipe soignante avant toute injection.';
          el.glyDangerBadge.style.cssText = 'display:block; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4; background:rgba(239,68,68,0.18); border:1.5px solid rgba(239,68,68,0.55); color:inherit;';
        } else if (gVal >= 400) {
          // Seuil intermédiaire : hyperglycémie sévère
          el.glyDangerBadge.textContent = '⚠️ Hyperglycémie sévère (≥ 400 mg/dL) — Vérifiez votre glycémie avant injection.';
          el.glyDangerBadge.style.cssText = 'display:block; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4; background:rgba(251,113,133,0.14); border:1.5px solid rgba(251,113,133,0.45); color:inherit;';
        } else {
          el.glyDangerBadge.style.display = 'none';
          el.glyDangerBadge.textContent = '';
        }
      } else {
        el.glyDangerBadge.style.display = 'none';
        el.glyDangerBadge.textContent = '';
      }
    }
    // ═══════════════════════════════════════════════════════════════════

    // Mise à jour dynamique du message d'erreur glycémie
    if (el.glyFastErr) el.glyFastErr.textContent = glyErrMsg;
    setFieldError(el.glyFast, el.glyFastErr, Touched.gly && glyInvalid);
    setFieldError(el.carbFast, el.carbFastErr, Touched.carbs && carbInvalid);

    const confirmed = Touched.gly && Touched.carbs;
    
    // Effet néon si le champ est vide ou invalide (et pas encore touché pour éviter l'erreur rouge)
    const glyEmpty = !rawGly || glyInvalid;
    const carbEmpty = !el.carbFast?.value || carbInvalid;
    
    if(el.glyFast){
      if(glyEmpty && !Touched.gly){
        el.glyFast.classList.add("input-required-empty");
      } else {
        el.glyFast.classList.remove("input-required-empty");
      }
    }
    
    if(el.carbFast){
      if(carbEmpty && !Touched.carbs){
        el.carbFast.classList.add("input-required-empty");
      } else {
        el.carbFast.classList.remove("input-required-empty");
      }
    }

    return { gly: g, glyRaw: rawGly, glyUnit: detectedUnit, carbs: c, ok: !(glyInvalid || carbInvalid), confirmed };
  }

  // -------------------- Status --------------------
  function setStatus(level, text){
    const node = el.statusFast || el.status;
    if(!node) return;
    
    // NOUVEAU : Vérifier si un message du wizard est présent
    const wizardMessage = node.querySelector('[data-wizard-preserved="true"]');
    
    // Si un message wizard existe, ne PAS l'écraser
    if(wizardMessage){
      // Mettre à jour seulement la classe (pour la couleur de fond)
      node.classList.remove("ok","warn","bad","info");
      node.classList.add("ok"); // Toujours vert si wizard message présent
      return; // Ne rien faire d'autre - préserver le message
    }
    
    // Sinon, comportement normal
    node.classList.remove("ok","warn","bad","info");
    node.classList.add(level);

    const icon = (level === "ok") ? "✅" : (level === "warn") ? "⚠️" : (level === "info") ? "💎" : "⛔";
    node.innerHTML = "";
    const i = document.createElement("span");
    i.className = "statusIcon";
    i.setAttribute("aria-hidden","true");
    i.textContent = icon;
    const t = document.createElement("span");
    t.className = "statusText";
    t.textContent = text;
    node.appendChild(i);
    node.appendChild(t);
  }

  // -------------------- Calculation --------------------
  function calcBolus(){
    const p = readCommonParams();
    const v = validateMealInputs();

    // gate: ratios + target
    if(!p.ratiosOk || !p.targetOk){
      setStatus("warn", "Vérifie les paramètres (insulines quotidiennes et objectif).");
      return null;
    }
    // gate: inputs in range - mais seulement afficher l'erreur si les champs sont vraiment invalides (et touchés)
    if(!v.ok && v.confirmed){
      setStatus("warn", "Vérifie les champs en rouge");
      return null;
    }
    // gate: user confirmation (touch) - si pas confirmé, on garde le message bleu
    if(!v.confirmed){
      setStatus("info", "Complète les champs en bleu pour calculer ton bolus");
      return null;
    }

    // keep last carbs
    if(Number.isFinite(v.carbs)) Storage.setLastCarbs(v.carbs);

    // Délègue à BolusMath — source unique de vérité pour les formules
    const { correction, repas, total, totalArrondi } = BolusMath.calcBolus({
      glycemie:  v.gly,
      objectif:  p.objectif,
      glucides:  v.carbs,
      basale:    p.basale,
      rapide:    p.rapide,
      step:      p.step
    });

    // Règle produit : pas de bolus négatif conseillé.
    const isHypo = Number.isFinite(totalArrondi) && totalArrondi < 0;
    const totalConseille = isHypo ? 0 : totalArrondi;

    return { ...p, ...v, correction, repas, total, totalArrondi, totalConseille, isHypo };
  }

  // -------------------- Rendering --------------------
  function renderPills(params){
    // Affichage des données (pills)
    const t = params?.objectif;
    if(el.pillTarget) el.pillTarget.textContent = (Number.isFinite(t) && rangeOk(t, TARGET_MIN, TARGET_MAX)) ? String(t) : "—";

    const rawGly = el.glyFast?.value ?? '';
    const detectedUnit = GlyUnits.detectUnit(rawGly);
    const gMgdl = detectedUnit === 'gl' ? GlyUnits.glToMgdl(rawGly) : Util.toNumber(rawGly);
    // Affichage dans l'unité saisie par l'utilisateur
    const gDisplay = detectedUnit === 'gl'
      ? (Number.isFinite(gMgdl) ? GlyUnits.formatGl(GlyUnits.mgdlToGl(gMgdl)) : '—')
      : (Number.isFinite(gMgdl) ? String(Math.round(gMgdl)) : '—');
    if(el.pillGly) el.pillGly.textContent = gDisplay;
    const g = gMgdl; // mg/dL pour les seuils de couleur ci-dessous
    
    // Coloration du point glycémie selon la valeur (pour les pills et le champ input)
    const pillDot = $("pillDot");
    const labelDotFast = $("labelDotFast");
    
    if(Number.isFinite(g) && Number.isFinite(t)){
      const classes = [];
      if(g < t - 20) classes.push("bad");           // Hypo
      else if(g < t) classes.push("cool");          // Légèrement bas
      else if(g <= t + 20) classes.push("good");    // Objectif
      else if(g <= t + 50) classes.push("warn");    // Légèrement haut
      else classes.push("bad");                     // Hyper
      
      // Appliquer aux deux points
      if(pillDot){
        pillDot.classList.remove("cool", "good", "warn", "bad");
        pillDot.classList.add(...classes);
      }
      if(labelDotFast){
        labelDotFast.classList.remove("cool", "good", "warn", "bad");
        labelDotFast.classList.add(...classes);
      }
    } else {
      // Reset si pas de valeur
      if(pillDot) pillDot.classList.remove("cool", "good", "warn", "bad");
      if(labelDotFast) labelDotFast.classList.remove("cool", "good", "warn", "bad");
    }

    const c = Util.toNumber(el.carbFast?.value);
    if(el.pillCarbs) el.pillCarbs.textContent = Number.isFinite(c) ? String(c) : "—";

    // Ratios calculés (DTQ / ICR / FSI) visibles dans Paramètres / détails
    if(el.dtq) el.dtq.textContent = Number.isFinite(params?.dtq) ? params.dtq.toFixed(1) : "—";
    if(el.icr) el.icr.textContent = Number.isFinite(params?.icr) ? params.icr.toFixed(1) : "—";
    if(el.fsi) el.fsi.textContent = Number.isFinite(params?.fsi) ? params.fsi.toFixed(1) : "—";

    // Badges rapides (mode initié seulement)
    const icrTxt = Number.isFinite(params?.icr) ? params.icr.toFixed(1) : "—";
    const fsiTxt = Number.isFinite(params?.fsi) ? params.fsi.toFixed(1) : "—";
    if(el.icrBadgeFast) el.icrBadgeFast.textContent = icrTxt;
    if(el.fsiBadgeFast) el.fsiBadgeFast.textContent = fsiTxt;
    if(el.icrBadgeHintVal) el.icrBadgeHintVal.textContent = icrTxt;

    // P0 Issue 5 — Unités FSI dynamiques selon l'unité glycémie détectée
    const rawGlyForUnit = el.glyFast?.value ?? '';
    const unitForFSI = GlyUnits.detectUnit(rawGlyForUnit) === 'gl' ? 'g/L' : 'mg/dL';
    const fsiDisplay = (unitForFSI === 'g/L' && Number.isFinite(params?.fsi))
      ? (params.fsi / 100).toFixed(3)
      : fsiTxt;
    if(el.fsiBadgeUnit)     el.fsiBadgeUnit.textContent     = unitForFSI;
    if(el.fsiBadgeHintVal)  el.fsiBadgeHintVal.textContent  = fsiDisplay;
    if(el.fsiBadgeHintUnit) el.fsiBadgeHintUnit.textContent = unitForFSI;
    if(el.fsiDefUnit)       el.fsiDefUnit.textContent       = unitForFSI;
    if(el.fsiMetricUnit)    el.fsiMetricUnit.textContent    = unitForFSI;
  }

  function renderResults(r){
    const fmt = (n) => Number.isFinite(n) ? n.toFixed(2) : "—";
    const fmt1 = (n) => Number.isFinite(n) ? n.toFixed(1) : "—";
    const hypoBlock  = el.hypoBlock;
    const disclaimer = el.resultDisclaimer;

    const showDetails = document.body.classList.contains('show-bolus-details');

    if(simpleMode && !showDetails){
      if(el.totalFast)   el.totalFast.textContent   = r ? fmt1(r.totalConseille) : "—";
      if(el.corrFast)    el.corrFast.textContent    = "—";
      if(el.repasFast)   el.repasFast.textContent   = "—";
      if(el.totalDetail) el.totalDetail.textContent = "";
      // P0 Issue 6 — Hypo block
      if(hypoBlock)  hypoBlock.classList.toggle("show", !!(r?.isHypo));
      // P1 Issue 3 — Disclaimer visible sauf en hypo (hypoBlock le remplace)
      if(disclaimer) disclaimer.classList.toggle("show", !!(r && !r.isHypo));
      return;
    }

    if(!r){
      if(el.corrFast)    el.corrFast.textContent    = "—";
      if(el.repasFast)   el.repasFast.textContent   = "—";
      if(el.totalFast)   el.totalFast.textContent   = "—";
      if(el.totalDetail) el.totalDetail.textContent = "";
      if(hypoBlock)  hypoBlock.classList.remove("show");
      if(disclaimer) disclaimer.classList.remove("show");
      return;
    }

    if(el.corrFast)  el.corrFast.textContent  = fmt(r.correction);
    if(el.repasFast) el.repasFast.textContent = fmt(r.repas);
    if(el.totalFast) el.totalFast.textContent = fmt1(r.totalConseille);

    // P0 Issue 6 — Hypo block : visible si total négatif, masque totalDetail
    if(hypoBlock)  hypoBlock.classList.toggle("show", !!r.isHypo);
    // P1 Issue 3 — Disclaimer : visible sauf en hypo
    if(disclaimer) disclaimer.classList.toggle("show", !r.isHypo);

    // Ligne d'arrondi : masquée en cas d'hypo (hypoBlock la remplace)
    if(el.totalDetail && Number.isFinite(r.total)){
      if(r.isHypo){
        el.totalDetail.textContent = "";
      } else {
        const exactStr  = r.total.toFixed(2);
        const stepStr   = String(r.step);
        const isExact   = Math.abs(r.total - r.totalConseille) < 0.001;
        el.totalDetail.textContent = isExact
          ? `= ${exactStr} U (exact)`
          : `= ${exactStr} → arrondi au pas ${stepStr} U`;
      }
    }
  }

  // ── P2 Issue 7 — Verrou wizard sur le champ glucides ───────────────
  // Exposées sur window pour être accessibles depuis simple-mode-wizard.js
  // et food-search-ui.js (scripts externes, hors closure)
  // ── Toggle vue recherche : 'portion' (défaut) | '100g' ──────────────────────
  window.setSearchView = function(view) {
    const results   = document.getElementById('searchResults');
    const btnPortion = document.getElementById('viewBtnPortion');
    const btn100g    = document.getElementById('viewBtn100g');
    if (!results) return;

    results.setAttribute('data-view', view);

    if (btnPortion && btn100g) {
      btnPortion.classList.toggle('active', view === 'portion');
      btn100g.classList.toggle('active',    view === '100g');
      btnPortion.setAttribute('aria-pressed', String(view === 'portion'));
      btn100g.setAttribute('aria-pressed',    String(view === '100g'));
    }
  };

  window.lockCarbField = function(sourceLabel) {
    const field = document.getElementById('carbFast');
    const badge = document.getElementById('carbWizardLockBadge');
    if (!field) return;
    field.setAttribute('readonly', 'true');
    if (badge) badge.style.display = 'flex';
  };
  window.unlockCarbField = function() {
    const field = document.getElementById('carbFast');
    const badge = document.getElementById('carbWizardLockBadge');
    if (!field) return;
    field.removeAttribute('readonly');
    field.classList.remove('input-required-empty');
    if (badge) badge.style.display = 'none';
    field.focus();
  };
  // ────────────────────────────────────────────────────────────────────

  function render(){
    const p = readCommonParams();
    renderPills(p);

    const result = calcBolus();
    renderResults(result);

    if(result){
      if(result.isHypo){
        setStatus("bad", "⛔ Glycémie basse — 0 U conseillé. Resucrage recommandé, ne pas injecter.");
      } else {
        // P1 Issue 4 — Alerte physiologique glycémie aberrante
        if (Number.isFinite(result.gly) && result.gly >= 501) {
          setStatus("bad", "🚨 Glycémie critique (> 500 mg/dL) — Consultez immédiatement votre équipe soignante. Bolus calculé à titre indicatif uniquement.");
        } else if (Number.isFinite(result.gly) && result.gly >= 400) {
          setStatus("warn", "⚠️ Hyperglycémie sévère (≥ 400 mg/dL) — Vérifiez votre glycémie avant toute injection.");
        } else {
          setStatus("ok", "Calcul du Bolus réalisé");
        }
        if(p.rapide > p.basale){
          setStatus("warn", "⚠️ Insuline rapide > basale : vérifie que c'est cohérent.");
        }
      }
    }
    // Pas de else ici - on laisse calcBolus() gérer les messages d'erreur/info
  }

  // -------------------- Init --------------------
  function init(){
    // Theme / simple mode
    initTheme();
    simpleMode = Storage.getSimple();
    
    // Note : window.simpleModeWizard est créé par app.js après ce script
    
    applySimpleMode();

    // Restore ratios (3 days) if available
    const saved = Storage.getRatios();
    if(saved && el.basale && el.rapide && el.objectif && el.arrondi){
      el.basale.value = Number.isFinite(saved.basale) ? String(saved.basale) : "";
      el.rapide.value = Number.isFinite(saved.rapide) ? String(saved.rapide) : "";
      el.objectif.value = Number.isFinite(saved.objectif) ? String(saved.objectif) : el.objectif.value;
      el.arrondi.value = Number.isFinite(saved.step) ? String(saved.step) : el.arrondi.value;
      
      // Marquer comme "touched" et valider si les valeurs restaurées sont invalides
      if(!ratiosInRange(saved.basale, saved.rapide)){
        Touched.basale = true;
        Touched.rapide = true;
      }
      if(!rangeOk(saved.objectif, TARGET_MIN, TARGET_MAX)){
        Touched.objectif = true;
      }
    }

    // Restore last carbs (does NOT count as confirmation)
    // Désactivé : on force l'utilisateur à entrer ses glucides à chaque fois
    /*
    const lastC = Storage.getLastCarbs();
    if(Number.isFinite(lastC) && el.carbFast){
      el.carbFast.value = String(lastC);
    }
    */

    // Touch tracking (show errors only after user interaction)
    const mark = (k) => { if(k in Touched) Touched[k] = true; };

    el.glyFast?.addEventListener("input", () => { mark("gly"); render(); }, { passive:true });
    el.glyFast?.addEventListener("blur",  () => { mark("gly"); render(); }, { passive:true });
    el.glyFast?.addEventListener("change",() => { mark("gly"); render(); }, { passive:true });

    // ── P2 Issue 8 — Normalisation virgule → point en temps réel ────────
    // input[type="text"] laisse JS lire la valeur brute incluant la virgule.
    // On remplace immédiatement avant que toNumber() ne soit appelé.
    const DECIMAL_FIELDS = ['glyFast', 'carbFast', 'basale', 'rapide', 'objectif'];
    DECIMAL_FIELDS.forEach(id => {
      const field = document.getElementById(id);
      if (!field) return;
      field.addEventListener('input', () => {
        const raw = field.value;
        const normalized = raw.replace(/,/g, '.');
        if (normalized !== raw) {
          // Préserver la position du curseur
          const pos = field.selectionStart;
          field.value = normalized;
          // Repositionner le curseur (la virgule et le point ont la même largeur)
          try { field.setSelectionRange(pos, pos); } catch(e) {}
        }
      }, { passive: true });
    });
    // ─────────────────────────────────────────────────────────────────────

    el.carbFast?.addEventListener("input", () => { mark("carbs"); render(); }, { passive:true });
    el.carbFast?.addEventListener("blur",  () => { mark("carbs"); render(); }, { passive:true });
    el.carbFast?.addEventListener("change",() => { mark("carbs"); render(); }, { passive:true });

    // P2 Issue 7 — Bouton déverrouillage manuel du champ glucides
    document.getElementById("carbUnlockBtn")?.addEventListener("click", () => {
      window.unlockCarbField();
      mark("carbs");
      render();
    });

    // NOUVEAU : Effacer le message wizard si modification manuelle des glucides
    el.carbFast?.addEventListener("input", function(){
      const statusNode = el.statusFast || el.status;
      if(statusNode){
        const wizardMessage = statusNode.querySelector('[data-wizard-preserved="true"]');
        if(wizardMessage){
          // L'utilisateur modifie manuellement → effacer le message wizard
          wizardMessage.remove();
        }
      }
    }, { passive:true });

    el.objectif?.addEventListener("input", () => { mark("objectif"); render(); }, { passive:true });
    el.objectif?.addEventListener("blur",  () => { mark("objectif"); render(); }, { passive:true });

    el.basale?.addEventListener("input", () => { mark("basale"); render(); }, { passive:true });
    el.basale?.addEventListener("blur",  () => { mark("basale"); render(); }, { passive:true });

    el.rapide?.addEventListener("input", () => { mark("rapide"); render(); }, { passive:true });
    el.rapide?.addEventListener("blur",  () => { mark("rapide"); render(); }, { passive:true });

    el.arrondi?.addEventListener("change", () => { render(); }, { passive:true });

    // Buttons
    el.themeBtn?.addEventListener("click", toggleTheme);
    el.simpleBtn?.addEventListener("click", toggleSimpleMode);
    el.settingsBtn?.addEventListener("click", toggleSettings);

    // Close settings on Escape
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && el.settingsPanel && !el.settingsPanel.classList.contains("hidden")){
        toggleSettings();
      }
    });

    // Save ratios when leaving settings panel (auto-save)
    // We keep it simple: save on any change, but only if in-range.
    let saveTimeout = null;
    const saveRatiosIfOk = () => {
      const basale = Util.toNumber(el.basale?.value);
      const rapide = Util.toNumber(el.rapide?.value);
      const objectif = Util.toNumber(el.objectif?.value);
      const step = Util.toNumber(el.arrondi?.value);
      if(ratiosInRange(basale, rapide) && rangeOk(objectif, TARGET_MIN, TARGET_MAX)){
        Storage.setRatios({ basale, rapide, objectif, step });
        
        // Feedback visuel temporaire
        if(el.settingsBtn){
          const originalText = el.settingsBtn.innerHTML;
          el.settingsBtn.innerHTML = '✓ Sauvegardé';
          el.settingsBtn.style.color = 'var(--good)';
          
          if(saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            el.settingsBtn.innerHTML = originalText;
            el.settingsBtn.style.color = '';
          }, 2000);
        }
      }
    };
    el.basale?.addEventListener("change", saveRatiosIfOk);
    el.rapide?.addEventListener("change", saveRatiosIfOk);
    el.objectif?.addEventListener("change", saveRatiosIfOk);
    el.arrondi?.addEventListener("change", saveRatiosIfOk);

    // Initial render
    setEditingRatios(false);
    render();
    
    // Forcer l'affichage du message bleu initial si aucun champ n'est rempli
    const statusNode = el.statusFast || el.status;
    if(statusNode){
      setStatus("info", "Complète les champs en bleu pour calculer ton bolus");
    }
  }

  init();
  
  // BOUTON DE TEST MANUEL (À RETIRER APRÈS DEBUG)
  window.testColorerBlocIG = function() {
    console.log('🧪 TEST MANUEL DE COLORATION');
    const blocIG = document.querySelector('.recapTotalItem.ig');
    if (blocIG) {
      const valueElement = blocIG.querySelector('.recapTotalValue');
      if (valueElement) {
        const valueText = valueElement.textContent.trim();
        const igValue = parseInt(valueText.replace(/[^\d]/g, ''));
        console.log('📝 Texte brut:', valueText);
        console.log('📊 Valeur parsée:', igValue);
        
        // Déterminer la classe et l'emoji avec logs détaillés
        let classe = '';
        let emoji = '';
        if (igValue < 55) {
          classe = 'ig-low';
          emoji = '🟢';
          console.log(`✅ ${igValue} < 55 → IG BAS (VERT)`);
        } else if (igValue <= 69) {
          classe = 'ig-medium';
          emoji = '🟡';
          console.log(`✅ ${igValue} est entre 55 et 69 → IG MOYEN (JAUNE)`);
        } else {
          classe = 'ig-high';
          emoji = '🔴';
          console.log(`✅ ${igValue} >= 70 → IG ÉLEVÉ (ROUGE)`);
        }
        
        // Nettoyer complètement
        blocIG.classList.remove('ig-low', 'ig-medium', 'ig-high');
        blocIG.style.background = '';
        blocIG.style.borderColor = '';
        
        // Appliquer la nouvelle classe
        blocIG.classList.add(classe);
        console.log('Classe appliquée:', classe);
        console.log('Classes finales:', blocIG.className);
        
        // CHANGER LA SPHÈRE APRÈS LE CHIFFRE (pas l'icône du label !)
        const currentText = valueElement.textContent;
        const numberOnly = igValue.toString();
        const newText = numberOnly + ' ' + emoji;
        valueElement.textContent = newText;
        console.log(`🎨 Sphère changée: "${currentText}" → "${newText}"`);
        
        // Forcer le style inline avec setProperty
        if (classe === 'ig-low') {
          blocIG.style.setProperty('background', 'rgba(52, 211, 153, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(52, 211, 153, 0.4)', 'important');
        } else if (classe === 'ig-medium') {
          blocIG.style.setProperty('background', 'rgba(251, 191, 36, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(251, 191, 36, 0.4)', 'important');
        } else {
          blocIG.style.setProperty('background', 'rgba(251, 113, 133, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(251, 113, 133, 0.4)', 'important');
        }
        console.log('✅ Style inline forcé avec setProperty');
        console.log('Background final:', window.getComputedStyle(blocIG).backgroundColor);
      }
    } else {
      console.log('❌ Bloc IG non trouvé');
    }
  };
  console.log('💡 Pour tester: tapez testColorerBlocIG() dans la console');
})();

// -------------------- Coloration dynamique du bloc IG (Récapitulatif mode simple) --------------------
(() => {
  "use strict";

  function getIGClass(v) { return v < 55 ? 'ig-low' : v <= 69 ? 'ig-medium' : 'ig-high'; }

  function colorerBlocIGRecap() {
    const blocIG = document.querySelector('.recapTotalItem.ig');
    if (!blocIG) return false;
    const valueElement = blocIG.querySelector('.recapTotalValue');
    if (!valueElement) return false;
    const igValue = parseInt(valueElement.textContent.replace(/[^\d]/g, ''));
    if (isNaN(igValue)) return false;

    const igClass = getIGClass(igValue);
    const emoji   = igClass === 'ig-low' ? '🟢' : igClass === 'ig-medium' ? '🟡' : '🔴';

    blocIG.classList.remove('ig-low', 'ig-medium', 'ig-high');
    blocIG.style.background  = '';
    blocIG.style.borderColor = '';
    blocIG.classList.add(igClass);
    valueElement.textContent = valueElement.textContent.replace(/[^\d]/g, '') + ' ' + emoji;

    const colors = {
      'ig-low':    ['rgba(52,211,153,0.15)',  'rgba(52,211,153,0.4)'],
      'ig-medium': ['rgba(251,191,36,0.15)',  'rgba(251,191,36,0.4)'],
      'ig-high':   ['rgba(251,113,133,0.15)', 'rgba(251,113,133,0.4)'],
    };
    blocIG.style.setProperty('background',   colors[igClass][0], 'important');
    blocIG.style.setProperty('border-color', colors[igClass][1], 'important');
    return true;
  }

  const observer = new MutationObserver((mutations) => {
    const recapAdded = mutations.some(m =>
      Array.from(m.addedNodes).some(n =>
        n.nodeType === 1 && (
          n.classList?.contains('recapRepas') ||
          n.classList?.contains('recapTotalItem') ||
          n.querySelector?.('.recapRepas') ||
          n.querySelector?.('.recapTotalItem')
        )
      )
    );
    if (recapAdded) setTimeout(colorerBlocIGRecap, 100);
  });
  observer.observe(document.body, { childList: true, subtree: true });
})();

// -------------------- Coloration dynamique du bloc IG (Mon assiette) --------------------
(() => {
  "use strict";

  function getIGClass(v) { return v < 55 ? 'ig-low' : v <= 69 ? 'ig-medium' : 'ig-high'; }

  function colorerBlocIG() {
    const plateSummary = document.getElementById('plateSummary');
    if (!plateSummary) return;
    plateSummary.querySelectorAll('.summaryItem').forEach((item) => {
      const label = item.querySelector('.summaryLabel');
      const val   = item.querySelector('.summaryValue');
      if (!label || !val) return;
      const txt = label.textContent.trim().toLowerCase();
      if (txt.includes('ig') || txt.includes('index') || txt.includes('glycémique')) {
        const igValue = parseInt(val.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(igValue)) {
          item.classList.remove('ig-low', 'ig-medium', 'ig-high');
          item.classList.add(getIGClass(igValue));
        }
      }
    });
  }

  const plateSummary = document.getElementById('plateSummary');
  if (plateSummary) {
    const observer = new MutationObserver(colorerBlocIG);
    observer.observe(plateSummary, { childList: true, subtree: true, characterData: true });
  }
})();
</script>

<!--
  ORDRE D'EXÉCUTION GARANTI (Issue 1 + Issue 2 + Issue 4 + Issue 7) :
  1. storage.js        — AppStorage unifié (TTL + versioning), doit être 1er
  2. bolusMath.js      — BolusMath : pure functions moteur bolus
  3. units.js          — GlyUnits : conversions mg/dL ↔ g/L + parsing
  4. notifications.js  — Notify : toasts/bannières/confirm centralisés
  5. food-database     — FoodDatabase (utilise Notify pour les erreurs)
  6. bolus-optimizer   — BolusOptimizer (pas de dépendances)
  7. food-search-ui    — FoodSearchUI (dépend de AppStorage + Notify)
  8. simple-mode-*     — SimpleModeData + SimpleModeWizard
  9. app.js en dernier — instancie FoodSearchUI et SimpleModeWizard une seule fois
-->
<script src="storage.js?v=2.1"></script>
<script src="bolusMath.js?v=2.1"></script>
<script src="units.js?v=2.1"></script>
<script src="notifications.js?v=2.1"></script>
<script src="food-database.js?v=2.1"></script>
<script src="bolus-optimizer.js?v=2.1"></script>
<script src="food-search-ui.js?v=2.1"></script>
<script src="simple-mode-data.js?v=2.1"></script>
<script src="simple-mode-wizard.js?v=2.1"></script>
<script src="app.js?v=2.1"></script>

</body>
</html>
