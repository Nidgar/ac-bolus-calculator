<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>AC Bolus - Calculateur de Bolus</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Theme color pour Android -->
  <meta name="theme-color" content="#6ee7ff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b1220" />
  
  <!-- Description pour PWA -->
  <meta name="description" content="Calculateur de bolus intelligent pour la gestion du diab√®te" />
  
  <!-- Apple Touch Icons (iOS) -->
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
  
  <!-- Favicons classiques -->
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="favicon-48.png" />
  <link rel="icon" type="image/png" sizes="96x96" href="favicon-96.png" />
  
  <!-- Android Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="AC Bolus" />
  
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="AC Bolus" />
  
  <!-- Scripts d√©plac√©s en bas du body pour garantir l'ordre d'ex√©cution (Issue 1) -->
  
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --border: rgba(255,255,255,0.12);
      --accent: #6ee7ff;
      --accent2: #a78bfa;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --cool: #60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 20px;
      --focus: 0 0 0 3px rgba(110,231,255,0.35);
      color-scheme: dark;
    }
    :root[data-theme="clair"]{
      --bg: #f0f2f5;
      --panel: rgba(0,0,0,0.12);
      --panel2: rgba(0,0,0,0.16);
      --text: rgba(0,0,0,0.95);
      --muted: rgba(0,0,0,0.72);
      --border: rgba(0,0,0,0.25);
      --accent: #0284c7;
      --accent2: #6d28d9;
      --good: #047857;
      --warn: #c2410c;
      --bad: #dc2626;
      --cool: #1d4ed8;
      --shadow: 0 18px 60px rgba(0,0,0,0.25);
      color-scheme: light;
    }

    *{ box-sizing:border-box; }
    html{ 
      height: 100%;
    }
    body{ 
      display:flex; 
      flex-direction:column; 
      align-items:center;
      min-height: 100vh; /* Couvre toute la hauteur de la fen√™tre */
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1100px 520px at 14% 0%, rgba(167,139,250,0.20), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(110,231,255,0.16), transparent 60%),
        var(--bg);
      background-attachment: fixed; /* Background fixe, ne d√©file pas */
      color: var(--text);
      line-height: 1.35;
    }

    .skip{
      position:absolute; left:-999px; top:0;
      background: var(--text); color: var(--bg);
      padding:10px 12px; border-radius: 14px;
      z-index: 9999;
    }
    .skip:focus{ left:12px; top:12px; outline:none; }

    .wrap{
      max-width: 840px;  /* Optimis√© pour 4 boutons + espacements √©gaux (~35px) */
      width: 100%;  /* Prend toute la largeur disponible */
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 14px;
      box-sizing: border-box;  /* Inclut padding dans la largeur */
      overflow: visible;  /* Permet au bouton toggle de d√©passer */
    }

    @media (max-width:720px){
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .logo{
      width: 64px;
      height: 64px;
      display:grid;
      place-items:center;
      border-radius: 16px;
      
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sub{
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-weight: 800;
    }
    :root[data-theme="clair"] .btn{
      background: rgba(255,255,255,0.85);
      border-color: rgba(0,0,0,0.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn-ghost{ background: transparent; }
    .btn[aria-pressed="true"]{
      /* default pressed state */
      border-color: rgba(110,231,255,0.45);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
    }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; transform:none; }
    .btn-error{ border-color:#fb7185 !important; box-shadow:0 0 0 2px rgba(251,113,133,0.4); }

    .card{
      background: linear-gradient(180deg, var(--panel), transparent 140%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      max-width: 100%;
      overflow-wrap: break-word;
    }
    :root[data-theme="clair"] .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85) 140%);
      border-color: rgba(0,0,0,0.20);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 15px;
      letter-spacing: 0.2px;
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .pillbar{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
      justify-content: center; /* Centr√© */
    }
    .pills{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
      justify-content: center; /* Centr√© */
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel2);
      font-size: 13px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    
    /* Texte des labels (Glyc√©mie, Glucides, Objectif) */
    .pill-label {
      display: inline; /* Visible par d√©faut */
    }
    
    /* Mode mobile : cacher les labels, garder ic√¥ne + valeur */
    @media (max-width: 500px) {
      .pill-label {
        display: none; /* Cache "Glyc√©mie", "Glucides", "Objectif" */
      }
      
      .pill {
        padding: 6px 10px; /* Padding r√©duit */
        font-size: 12px; /* Police l√©g√®rement plus petite */
      }
    }
    
    :root[data-theme="clair"] .pill{
      background: rgba(255,255,255,0.85);
      border-color: rgba(0,0,0,0.20);
    }
    .pill strong{ color: var(--text); }

    .dotGly{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
      flex: 0 0 auto;
    }
    .dotGly.cool{ background: var(--cool); border-color: rgba(96,165,250,0.55); box-shadow: 0 0 0 3px rgba(96,165,250,0.14); }
    .dotGly.good{ background: var(--good); border-color: rgba(52,211,153,0.55); box-shadow: 0 0 0 3px rgba(52,211,153,0.14); }
    .dotGly.warn{ background: var(--warn); border-color: rgba(251,191,36,0.60); box-shadow: 0 0 0 3px rgba(251,191,36,0.14); }
    .dotGly.bad{  background: var(--bad);  border-color: rgba(251,113,133,0.60); box-shadow: 0 0 0 3px rgba(251,113,133,0.14); }

    .input-error{ border-color: rgba(251,113,133,0.65) !important; box-shadow: 0 0 0 3px rgba(251,113,133,0.18) !important; }
    
    /* Effet n√©on pour les champs obligatoires non remplis */
    input[type="number"].input-required-empty, input[type="text"].input-required-empty{
      border-color: rgba(110,231,255,0.85);
      box-shadow:
        0 0 0 2px rgba(110,231,255,0.22),
        0 0 18px rgba(110,231,255,0.35),
        0 0 32px rgba(37,99,235,0.15);
      animation: pulseNeon 2s ease-in-out infinite;
    }
    
    @keyframes pulseNeon {
      0%, 100% { 
        box-shadow:
          0 0 0 2px rgba(110,231,255,0.22),
          0 0 18px rgba(110,231,255,0.35),
          0 0 32px rgba(37,99,235,0.15);
      }
      50% { 
        box-shadow:
          0 0 0 2px rgba(110,231,255,0.30),
          0 0 22px rgba(110,231,255,0.45),
          0 0 40px rgba(37,99,235,0.22);
      }
    }
    
    .alertBanner{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(251,113,133,0.35);
      background: rgba(251,113,133,0.10);
      color: var(--text);
      font-weight: 900;
      display:none;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    .alertBanner.show{ display:block; }
    .alertBanner span{ color: var(--muted); font-weight: 800; }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 520px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .label{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    
    /* Labels agrandis pour les champs principaux */
    .label-large {
      font-size: 16px !important; /* Augment√© de 12px √† 16px */
      font-weight: 900;
      color: var(--text) !important;
    }
    
    .label-large .label-icon {
      font-size: 24px; /* Ic√¥nes plus grandes */
      line-height: 1;
    }
    
    input[type="number"], input[type="text"], select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    :root[data-theme="clair"] input[type="number"],
    :root[data-theme="clair"] input[type="text"],
    :root[data-theme="clair"] select{
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.25);
    }

    /* Erreurs de champ sans d√©calage */
    .fieldLine{ display:flex; flex-direction:column; gap:6px; }
    .fieldError{ height: 18px; line-height:18px; font-size:12px; font-weight:900; color: var(--bad);
      visibility:hidden; white-space: nowrap; overflow: hidden; }
    .fieldError.show{ visibility:visible; }

    input[type="number"]:focus, input[type="text"]:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(110,231,255,0.55);
    }
    select option{ background: var(--bg); color: var(--text); }


    .results{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
      transition: grid-template-columns 0.4s ease;
    }
    
    /* Mode simple : 1 colonne (total seul) */
    body.simple-mode .results {
      grid-template-columns: 1fr;
    }
    
    /* Mode simple avec d√©tails : 3 colonnes */
    body.simple-mode.show-bolus-details .results {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    /* Mode initi√© : toujours 3 colonnes sur desktop */
    @media (min-width: 520px){
      body:not(.simple-mode) .results { 
        grid-template-columns: 1fr 1fr 1fr; 
      }
      .results.simple{ 
        grid-template-columns: 1fr; 
      }
    }
    
    /* Mobile : toujours 1 colonne */
    @media (max-width: 519px){
      .results { 
        grid-template-columns: 1fr !important; 
      }
    }
    .res{ text-align:center;
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 16px;
      padding: 12px;
    }
    .res.total{
      border-color: rgba(110,231,255,0.45);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
    }
    .res .k{ font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .res .v{ font-size: 22px; font-weight: 950; font-variant-numeric: tabular-nums; }
    .res.total .v{ font-size: 30px; letter-spacing: 0.2px; }
    .total-detail{
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
      font-variant-numeric: tabular-nums;
      opacity: 0.75;
      min-height: 14px;
    }

    .miniBadges{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    :root[data-theme="clair"] .badge{ background: rgba(0,0,0,0.03); }
    .badge strong{ color: var(--text); }

    .status{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed var(--border);
      color: var(--muted);
      min-height: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      text-align:center;
    }
    .status.ok{ border-style: solid; border-color: rgba(52,211,153,0.35); background: rgba(52,211,153,0.14); font-weight: 950; color: var(--text); }
    .statusIcon{ font-size: 18px; line-height: 1; flex: 0 0 auto; }
    .statusText{ font-weight: inherit; }

    .status.warn{ border-style: solid; border-color: rgba(251,191,36,0.35); background: rgba(251,191,36,0.16); font-weight: 950; color: var(--text); }
    .status.bad{ border-style: solid; border-color: rgba(251,113,133,0.35); }
    .status.info{ border-style: solid; border-color: rgba(110,231,255,0.45); background: rgba(110,231,255,0.16); font-weight: 950; color: var(--text); }

    details{
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    summary{ cursor:pointer; color: var(--text); font-weight: 950; }

    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .metric{
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 16px;
      padding: 12px;
    }
    .metric .k{ font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .metric .v{ font-size: 20px; font-weight: 950; font-variant-numeric: tabular-nums; }

    .hidden{ display:none !important; }
    /* Garantit que l'attribut HTML hidden prime sur tout display CSS (ex: flex/grid) */
    [hidden]{ display:none !important; }

    /* Bouton toggle d√©tails bolus (mode simple) */
    .toggle-details-btn {
      position: absolute;
      left: -26px;  /* D√©plac√© 10px vers la gauche (de -16px √† -26px) */
      top: 50%;
      transform: translateY(-50%);
      width: 44px;  /* L√©g√®rement plus grand pour meilleure visibilit√© */
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--accent);  /* Bordure accent pour meilleure visibilit√© */
      background: var(--panel2);
      color: var(--accent);  /* Couleur accent pour meilleure visibilit√© */
      font-size: 22px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;  /* Z-index tr√®s √©lev√© pour √™tre au-dessus de tout */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);  /* Ombre pour le d√©tacher du fond */
    }
    
    .toggle-details-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: translateY(-50%) scale(1.15);
      box-shadow: 0 6px 20px rgba(110, 231, 255, 0.4);
    }
    
    /* Cache le bouton sur petit √©cran */
    @media (max-width: 768px) {
      .toggle-details-btn {
        left: 8px;
        top: -20px;
        transform: translateY(0);
      }
      
      .toggle-details-btn:hover {
        transform: translateY(0) scale(1.1);
      }
    }
    
    /* D√©tails bolus (Correction + Repas) */
    .bolus-detail {
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    
    /* Mode simple : d√©tails cach√©s par d√©faut */
    body.simple-mode .bolus-detail {
      display: none !important;
      opacity: 0;
    }
    
    /* Mode simple avec d√©tails affich√©s */
    body.simple-mode.show-bolus-details .bolus-detail {
      display: block !important;
      opacity: 1 !important;
      animation: fadeIn 0.4s ease;
    }
    
    /* Animation d'apparition en fondu */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    /* Mode initi√© : d√©tails toujours visibles */
    body:not(.simple-mode) .bolus-detail {
      display: block;
      opacity: 1;
    }
    
    /* Verrouillage temporaire des zones de calcul pendant l'√©dition des ratios */
    body.editing-ratios #panelFast{
      opacity: 0.35;
      pointer-events: none;
      user-select: none;
      filter: saturate(0.9);
    }
    body.editing-ratios #panelFast * { pointer-events: none; }
    
    footer{
      color: var(--muted);
      font-size: 12px;
      padding: 4px 2px 14px;
      text-align:center;
    }
  
    header{
      max-width: 840px;  /* Align√© avec .wrap */
      margin:0 auto 24px auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }
    .headerLeft{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
      text-align:left;
    }
    .titleBlock{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .headerRight{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    @media (max-width:720px){
      header{ flex-direction:column; align-items:center; text-align:center; }
      .headerLeft{ justify-content:center; text-align:center; }
      .headerRight{ justify-content:center; }
    }

    /* Mode simple SANS d√©tails : on affiche uniquement le total */
    body.simple-mode:not(.show-bolus-details) #corrFastBox,
    body.simple-mode:not(.show-bolus-details) #repasFastBox,
    body.simple-mode #ratioBadgesFast{
      display:none !important;
    }
    
    /* Mode simple : classe g√©n√©rale pour cacher des √©l√©ments */
    body.simple-mode .hide-in-simple {
      display: none !important;
    }
    
    /* Mode avanc√© : cacher les √©l√©ments r√©serv√©s au mode simple */
    body:not(.simple-mode) .hide-in-advanced {
      display: none !important;
    }
    
    /* En mode simple SANS d√©tails, le total prend toute la largeur */
    body.simple-mode:not(.show-bolus-details) #resultsFastGrid{
      grid-template-columns: 1fr !important;
    }
    
    /* ===== INTERFACE RECHERCHE ALIMENTS ===== */
    
    /* Masquer en mode simple */
    body.simple-mode #foodSearchToggle,
    body.simple-mode #foodSearchPanel{
      display:none !important;
    }
    
    .foodSearchToggle{
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 2px dashed rgba(110,231,255,0.35);
      border-radius: 16px;
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      margin: 12px 0;
      transition: all 0.2s ease;
    }
    .foodSearchToggle:hover{
      background: linear-gradient(135deg, rgba(110,231,255,0.18), rgba(167,139,250,0.14));
      border-color: rgba(110,231,255,0.55);
    }
    .foodSearchToggle.active{
      background: linear-gradient(135deg, rgba(110,231,255,0.22), rgba(167,139,250,0.18));
      border-style: solid;
      border-color: rgba(110,231,255,0.65);
    }
    
    #foodSearchPanel{
      margin-top: 12px;
      padding: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    
    .searchBox{
      position: relative;
      margin-bottom: 12px;
    }
    .searchBox input{
      width: 100%;
      padding: 12px 12px 12px 40px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
    }
    :root[data-theme="clair"] .searchBox input{
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.25);
    }
    .searchBox input:focus{
      outline: none;
      border-color: rgba(110,231,255,0.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,0.15);
    }
    .searchIcon{
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: 0.5;
    }
    
    .searchResults{
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 12px;
      background: var(--panel2);
      border-radius: 12px;
      padding: 4px;
    }
    .searchResults:empty{ display: none; }
    
    .foodItem{
      padding: 10px 12px;
      margin: 4px 0;
      background: rgba(255,255,255,0.04);
      border: 1px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    :root[data-theme="clair"] .foodItem{
      background: rgba(255,255,255,0.7);
    }
    .foodItem:hover{
      background: rgba(110,231,255,0.12);
      border-color: rgba(110,231,255,0.35);
    }
    .foodItem .info{
      flex: 1;
    }
    .foodItem .name{
      font-weight: 800;
      margin-bottom: 2px;
    }
    .foodItem .meta{
      font-size: 12px;
      color: var(--muted);
    }
    .foodItem .add{
      padding: 6px 12px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 900;
      border: none;
      cursor: pointer;
    }
    
    .myPlate{
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
    .myPlate h4{
      margin: 0 0 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .plateEmpty{
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .plateItem{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    :root[data-theme="clair"] .plateItem{
      background: rgba(255,255,255,0.7);
    }
    .plateItem .itemInfo{
      flex: 1;
      min-width: 0;
    }
    .plateItem .itemName{
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .plateItem .itemMeta{
      font-size: 12px;
      color: var(--muted);
    }
    .plateItem input{
      width: 70px;
      padding: 6px 8px;
      text-align: center;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-weight: 800;
      font-size: 14px;
    }
    .plateItem button{
      padding: 6px 10px;
      background: var(--bad);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
    }
    
    .plateSummary{
      margin-top: 12px;
      padding: 12px;
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
    }
    .plateSummary .summaryGrid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .plateSummary .summaryItem{
      text-align: center;
    }
    
    /* Bloc IG color√© selon le niveau (avec transparence) */
    .plateSummary .summaryItem.ig-low {
      background: rgba(52, 211, 153, 0.12);  /* Vert transparent */
      border: 1px solid rgba(52, 211, 153, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    
    .plateSummary .summaryItem.ig-medium {
      background: rgba(251, 191, 36, 0.12);  /* Jaune transparent */
      border: 1px solid rgba(251, 191, 36, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    
    .plateSummary .summaryItem.ig-high {
      background: rgba(251, 113, 133, 0.12);  /* Rouge transparent */
      border: 1px solid rgba(251, 113, 133, 0.30);
      border-radius: 10px;
      padding: 8px;
    }
    .plateSummary .summaryLabel{
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .plateSummary .summaryValue{
      font-size: 20px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
    }
    .plateSummary .timingSuggestion{
      padding: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 800;
      text-align: center;
    }
    :root[data-theme="clair"] .plateSummary .timingSuggestion{
      background: rgba(255,255,255,0.5);
    }

    /* ‚îÄ‚îÄ Issue 2 P0 : Opt-in conseil IG/CG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .igTimingWrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .igTimingRevealBtn {
      width: 100%;
      padding: 10px 14px;
      background: rgba(99,102,241,0.12);
      color: inherit;
      border: 1.5px solid rgba(99,102,241,0.3);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      text-align: left;
      transition: background 0.15s;
    }
    .igTimingRevealBtn:hover {
      background: rgba(99,102,241,0.22);
    }
    .igTimingContent {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .igTimingDisclaimer {
      background: rgba(251,191,36,0.12);
      border: 1px solid rgba(251,191,36,0.35);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.55;
      font-weight: 600;
    }
    :root[data-theme="clair"] .igTimingRevealBtn {
      background: rgba(99,102,241,0.08);
      border-color: rgba(99,102,241,0.25);
    }
    :root[data-theme="clair"] .igTimingDisclaimer {
      background: rgba(251,191,36,0.1);
    }
    
    .validateMealBtn{
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      background: var(--good);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .validateMealBtn:hover{
      background: #059669;
    }
    .validateMealBtn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ===== MODE SIMPLE : WIZARD DE COMPOSITION DE REPAS ===== */
    
    /* Container principal - largeur fixe pour coh√©rence */
    
    /* ==================== WIZARD MODAL ==================== */
    
    /* Overlay (fond semi-transparent) */
    #wizardOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    #wizardOverlay.show {
      opacity: 1;
      pointer-events: all;
    }
    
    /* Panneau modal du wizard */
    #wizardModal {
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
      position: relative;
    }
    
    #wizardOverlay.show #wizardModal {
      transform: scale(1) translateY(0);
    }
    
    /* Bouton de fermeture */
    .wizardCloseBtn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .wizardCloseBtn:hover {
      background: var(--panel2);
      border-color: rgba(110,231,255,0.55);
      color: var(--text);
      transform: scale(1.05);
    }
    
    #simpleModeContainer {
      padding: 20px;
      width: 100%;
    }
    
    /* Header du wizard */
    .wizardHeader {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .wizardProgress {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 800;
    }
    
    .wizardHeader h2 {
      font-size: 24px;
      font-weight: 950;
      margin: 0 0 8px 0;
    }
    
    .wizardHeader p {
      font-size: 16px;
      color: var(--muted);
      margin: 0;
    }
    
    /* Grille de choix de type de repas */
    .repasTypeGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    
    @media (min-width: 600px) {
      .repasTypeGrid {
        display: flex;
        justify-content: space-evenly;  /* Espacement √©gal PARTOUT (bords inclus) */
        gap: 0;
        max-width: 808px;  /* 4√ó166px + 5√ó(808-664)/5 = 4√ó166px + 5√ó28.8px */
        width: 100%;
      }
      
      .repasTypeCard {
        flex: 0 0 166px;  /* Largeur fixe 166px */
      }
    }
    
    .repasTypeCard {
      background: linear-gradient(135deg, var(--panel), var(--panel2));
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 24px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      /* Pas de max-width ni margin - la grille g√®re tout */
    }
    
    .repasTypeCard:hover {
      border-color: rgba(110,231,255,0.55);
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      transform: translateY(-2px);
    }
    
    .repasTypeEmoji {
      font-size: 56px;  /* R√©duit de 64px √† 56px */
      line-height: 1;
    }
    
    .repasTypeName {
      font-size: 13px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.3;
      min-height: 34px;  /* Hauteur fixe pour 2 lignes */
      max-height: 34px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;  /* Limite √† 2 lignes */
      -webkit-box-orient: vertical;
    }
    
    /* ==================== S√âLECTIONS ACTUELLES (SIMPLIFI√â) ==================== */
    
    .selectionsActuelles {
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .selectionsContainer {
      background: rgba(110,231,255,0.08);
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
      overflow: hidden;
    }
    
    /* Message si aucun aliment */
    .selectionsEmpty {
      font-size: 14px;
      font-weight: 800;
      color: var(--muted);
      font-style: italic;
      text-align: center;
      padding: 12px 16px;
    }
    
    /* Liste des aliments s√©lectionn√©s */
    .selectionsItems {
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.6;
      padding: 12px 16px;
    }
    
    /* Total de glucides (compact, juste le chiffre) */
    .selectionsTotalGlucides {
      background: rgba(110,231,255,0.15);
      padding: 8px 16px;
      font-size: 16px;
      font-weight: 950;
      color: var(--accent);
      text-align: center;
      border-top: 1px solid rgba(110,231,255,0.25);
    }
    
    /* ==================== FIN S√âLECTIONS ==================== */
    
    /* Grille d'aliments - AVEC SCROLL (2 lignes max) */
    .alimentsGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      max-width: 500px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      
      /* NOUVEAU : Limiter √† 2 lignes avec scroll */
      max-height: 270px; /* 2 lignes compl√®tes : 2√ó110 + 12 (gap) + 24 (padding) + marge */
      overflow-y: auto;
      padding: 12px; /* Padding √©gal partout */
      
      /* Scrollbar style */
      scrollbar-width: thin;
      scrollbar-color: rgba(110,231,255,0.4) transparent;
    }
    
    /* Scrollbar custom pour WebKit (Chrome, Safari) */
    .alimentsGrid::-webkit-scrollbar {
      width: 6px; /* R√©duit √† 6px pour √™tre plus discret */
    }
    
    .alimentsGrid::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .alimentsGrid::-webkit-scrollbar-thumb {
      background: rgba(110,231,255,0.4);
      border-radius: 3px;
    }
    
    .alimentsGrid::-webkit-scrollbar-thumb:hover {
      background: rgba(110,231,255,0.6);
    }
    
    @media (min-width: 600px) {
      .alimentsGrid {
        /* 4 colonnes avec cartes plus petites et espacements √©gaux */
        grid-template-columns: repeat(4, 1fr);
        max-width: 720px;
        width: 100%;  /* Prend la largeur disponible */
        gap: 12px;
        padding: 12px; /* Espacement √©gal partout */
        max-height: 270px; /* 2 lignes compl√®tes */
      }
    }
    
    .alimentCard {
      position: relative;
      background: var(--panel2);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 10px 6px; /* R√©duit l√©g√®rement */
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px; /* R√©duit l√©g√®rement */
      min-height: 110px; /* R√©duit de 120px √† 110px */
      width: 100%;
      box-sizing: border-box;
    }
    
    .alimentCard:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
      transform: translateY(-2px);
    }
    
    .alimentCard.selected {
      border-color: var(--good);
      background: rgba(52,211,153,0.12);
    }
    
    .alimentEmoji {
      font-size: 40px;  /* R√©duit de 48px √† 40px */
      line-height: 1;
    }
    
    .alimentNom {
      font-size: 12px;
      font-weight: 800;
      text-align: center;
      color: var(--text);
      line-height: 1.3;
      min-height: 31px;  /* Hauteur fixe pour 2 lignes (12px * 1.3 * 2) */
      max-height: 31px;  /* Force la hauteur */
      overflow: hidden;  /* Cache le texte qui d√©passe */
      display: -webkit-box;
      -webkit-line-clamp: 2;  /* Limite √† 2 lignes */
      -webkit-box-orient: vertical;
      word-break: break-word;  /* Force la coupure des mots longs */
      overflow-wrap: break-word;  /* Fallback */
      width: 100%;  /* Prend toute la largeur disponible */
      max-width: 100%;  /* Ne d√©passe jamais 100% */
    }
    
    /* P2 Issue 7 ‚Äî Champ glucides verrouill√© par le wizard */
    #carbFast[readonly] {
      opacity: 0.55;
      cursor: not-allowed;
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.15) !important;
    }
    .carbWizardLock {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 10px;
      background: rgba(99,102,241,0.12);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }
    .carbWizardLock button {
      margin-left: auto;
      padding: 3px 10px;
      background: rgba(99,102,241,0.2);
      border: 1px solid rgba(99,102,241,0.4);
      border-radius: 6px;
      color: inherit;
      font-size: 11px;
      font-weight: 800;
      cursor: pointer;
    }
    .carbWizardLock button:hover {
      background: rgba(99,102,241,0.35);
    }

    .alimentPortion {
      font-size: 10px;
      font-weight: 500;
      color: var(--muted);
      opacity: 0.7;
      text-align: center;
      line-height: 1.2;
      margin-bottom: 2px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .alimentGlucides {
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    
    .alimentCheck {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--good);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 900;
    }
    
    /* Cartes sp√©ciales */
    .alimentCardPlus {
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border-style: dashed;
    }
    
    .alimentCardPlus:hover {
      border-style: solid;
    }
    
    .alimentCardNone {
      background: rgba(251,113,133,0.08);
      border-color: rgba(251,113,133,0.35);
    }
    
    .alimentCardNone:hover {
      background: rgba(251,113,133,0.12);
      border-color: rgba(251,113,133,0.55);
    }
    
    /* Navigation */
    .wizardNavigation {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      max-width: 700px;  /* R√©duit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    .btnPrimary, .btnSecondary {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btnPrimary {
      background: var(--good);
      color: white;
      flex: 1;
      min-width: 120px;
    }
    
    .btnPrimary:hover {
      background: #059669;
    }
    
    .btnPrimary.btnLarge {
      padding: 16px 32px;
      font-size: 16px;
    }
    
    .btnSecondary {
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btnSecondary:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
    }
    
    /* Total en bas */
    .wizardTotal {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      border-radius: 12px;
      font-size: 18px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      max-width: 700px;  /* R√©duit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    /* R√©capitulatif */
    .recapRepas {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      max-width: 700px;  /* R√©duit de 800px */
      margin-left: auto;
      margin-right: auto;
    }
    
    .recapRepas h3 {
      font-size: 20px;
      font-weight: 950;
      margin: 0 0 20px 0;
      text-align: center;
    }
    
    .recapSection {
      margin-bottom: 16px;
    }
    
    .recapSectionTitle {
      font-size: 14px;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .recapItem {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--panel2);
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 800;
    }
    
    .recapGlucides {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }
    
    /* Zone des totaux r√©organis√©e */
    .recapTotaux {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Ligne des 2 blocs (glucides + IG) */
    .recapTotalItems {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Bloc individuel (glucides ou IG) */
    .recapTotalItem {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 24px 16px;
      border-radius: 16px;
      border: 1px solid;
    }
    
    /* Bloc Glucides (violet) */
    .recapTotalItem.glucides {
      background: rgba(167, 139, 250, 0.15); /* Violet transparent */
      border-color: rgba(167, 139, 250, 0.4);
    }
    
    /* Bloc IG - Couleur par d√©faut (neutre) */
    .recapTotalItem.ig {
      background: rgba(244, 114, 182, 0.15); /* Rose transparent par d√©faut */
      border-color: rgba(244, 114, 182, 0.4);
    }
    
    /* Bloc IG - IG BAS (< 55) - Vert - SP√âCIFICIT√â RENFORC√âE */
    .recapTotalItem.ig.ig-low,
    .recapRepas .recapTotalItem.ig.ig-low {
      background: rgba(52, 211, 153, 0.15) !important; /* Vert transparent */
      border-color: rgba(52, 211, 153, 0.4) !important;
    }
    
    /* Bloc IG - IG MOYEN (55-69) - Jaune/Orange - SP√âCIFICIT√â RENFORC√âE */
    .recapTotalItem.ig.ig-medium,
    .recapRepas .recapTotalItem.ig.ig-medium {
      background: rgba(251, 191, 36, 0.15) !important; /* Jaune transparent */
      border-color: rgba(251, 191, 36, 0.4) !important;
    }
    
    /* Bloc IG - IG √âLEV√â (‚â• 70) - Rouge - SP√âCIFICIT√â RENFORC√âE */
    .recapTotalItem.ig.ig-high,
    .recapRepas .recapTotalItem.ig.ig-high {
      background: rgba(251, 113, 133, 0.15) !important; /* Rouge transparent */
      border-color: rgba(251, 113, 133, 0.4) !important;
    }
    
    .recapTotalLabel {
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .recapTotalLabel .emoji {
      font-size: 24px;
    }
    
    .recapTotalValue {
      font-size: 48px;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }
    
    /* Bloc Conseil (sous les totaux) */
    .recapConseil {
      background: linear-gradient(135deg, rgba(110,231,255,0.12), rgba(167,139,250,0.10));
      border: 1px solid rgba(110,231,255,0.35);
      padding: 16px 20px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 900;
      text-align: center;
      line-height: 1.4;
    }
    
    .recapConseil .icon {
      font-size: 24px;
      margin-right: 8px;
    }
    
    /* Responsive : empiler les blocs sur mobile */
    @media (max-width: 600px) {
      .recapTotalItems {
        grid-template-columns: 1fr;
      }
    }
    
    :root[data-theme="clair"] .recapConseil {
      background: rgba(255,255,255,0.5);
    }
    
    :root[data-theme="clair"] .recapTotalItem.glucides {
      background: rgba(167, 139, 250, 0.25);
    }
    
    :root[data-theme="clair"] .recapTotalItem.ig {
      background: rgba(244, 114, 182, 0.25);
    }
    
    /* Accord√©on pour la liste des aliments */
    .recapAccordeon {
      margin-bottom: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .recapAccordeonBtn {
      width: 100%;
      padding: 14px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .recapAccordeonBtn:hover {
      border-color: rgba(110,231,255,0.55);
      background: rgba(110,231,255,0.08);
    }
    
    #recapAccordeonIcon {
      font-size: 12px;
      transition: transform 0.3s ease;
    }
    
    .recapAliments {
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Mode sombre / clair */
    :root[data-theme="clair"] .repasTypeCard,
    :root[data-theme="clair"] .alimentCard {
      background: rgba(255,255,255,0.7);
    }
    
    :root[data-theme="clair"] .alimentCard.selected {
      background: rgba(52,211,153,0.2);
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Aller au contenu</a>

<div class="wrap">
  <header>
  <div class="headerLeft">
    <img class="logo" src="favicon-96.png" alt="Logo AC BOLUS">
    <div class="titleBlock">
      <h1>AC Bolus</h1>
      <div class="sub">Calculateur de Bolus</div>
    </div>
  </div>

  <div class="headerRight">
    <button id="simpleBtn" class="btn" type="button" aria-pressed="false" aria-label="Activer le mode simple"><span id="simpleBtnIcon" aria-hidden="true">üî≠</span> <span id="simpleText">Mode simple</span></button>
    <button id="settingsBtn" class="btn btn-ghost" type="button" aria-expanded="false" aria-controls="settingsPanel" aria-label="Mes ratios"><span aria-hidden="true">‚öôÔ∏è</span></button>
    <button id="themeBtn" class="btn btn-ghost" type="button" aria-pressed="false" aria-label="Changer le th√®me"><span id="themeIcon" class="iconSpin" aria-hidden="true"></span></button>
  </div>
</header>

  <main id="main" class="wrap" style="padding:0; gap:14px" role="main">
    <section class="card">
      <div class="pillbar">
        <div class="pills" aria-label="R√©sum√©">
          <div class="pill">
            <span id="pillDot" class="dotGly" aria-hidden="true"></span>
            ü©∏ <span class="pill-label">Glyc√©mie</span> : <strong id="pillGly">‚Äî</strong> <span id="pillGlyUnit">mg/dL</span>
          </div>
          <div class="pill">üç¨ <span class="pill-label">Glucides</span> : <strong id="pillCarbs">‚Äî</strong> g</div>
          <div class="pill">üéØ <span class="pill-label">Objectif</span> : <strong id="pillTarget">‚Äî</strong> mg/dL</div>
        </div>
      </div>

      <!-- Alerte "ratios obligatoires" (temps r√©el) -->
      <div id="ratioAlert" class="alertBanner" role="status" aria-live="polite" aria-atomic="true">
        ‚ö†Ô∏è Compl√®te les insulines quotidiennes avant tout calcul :
        <span>Basale ‚â• <strong>20 U</strong> et Rapide ‚â• <strong>10 U</strong>.</span>
      </div>

      <div id="settingsPanel" class="hidden" style="margin-top:12px">
        <div class="row2">
          <label>
            <div class="label">Objectif glyc√©mie (mg/dL)</div>
            <div class="fieldLine">
              <input id="objectif" type="text" inputmode="numeric" min="70" max="180" step="1" value="110">
              <div id="objectifErr" class="fieldError" role="status" aria-live="polite">‚ö†Ô∏è 70‚Äì180</div>
            </div>
          </label>

          <label>
            <div class="label">Arrondi affich√©</div>
            <select id="arrondi" aria-label="Arrondi de dose">
              <option value="0.1" selected>0,1 U (stylo)</option>
              <option value="0.5">0,5 U</option>
              <option value="1">1 U</option>
            </select>
            <div style="margin-top:8px; color:var(--muted); font-size:12px">On arrondit seulement l'affichage, pas les calculs internes.</div>
          </label>
        </div>

        <details open>
          <summary>üßÆ Insulines quotidiennes (obligatoire)</summary>
          <p style="margin:8px 0 0; color:var(--muted); font-size:12px">
            <strong>DTQ</strong> = Basale + Rapide
            &nbsp;¬∑&nbsp;
            <strong>ICR</strong> = 500 √∑ DTQ <em>(g de glucides couverts par 1 U)</em>
            &nbsp;¬∑&nbsp;
            <strong>FSI</strong> = 1800 √∑ DTQ <em>(mg/dL abaiss√© par 1 U)</em>
          </p>

          <div class="row2" style="margin-top:12px">
            <label>
              <div class="label">Insuline basale (U / jour) ‚Äî 20 √† 35</div>
              <div class="fieldLine">
                <input id="basale" type="text" inputmode="decimal" min="20" max="35" step="0.5" value="" placeholder="20‚Äì35">
                <div id="basaleErr" class="fieldError" role="status" aria-live="polite">‚ö†Ô∏è 20‚Äì35</div>
              </div>
            </label>

            <label>
              <div class="label">Insuline rapide totale (U / jour) ‚Äî 10 √† 25</div>
              <div class="fieldLine">
                <input id="rapide" type="text" inputmode="decimal" min="10" max="25" step="0.5" value="" placeholder="10‚Äì25">
                <div id="rapideErr" class="fieldError" role="status" aria-live="polite">‚ö†Ô∏è 10‚Äì25</div>
              </div>
            </label>
          </div>

          <div class="metrics" aria-label="Valeurs calcul√©es">
            <div class="metric"><div class="k">DTQ (U/j)</div><div id="dtq" class="v">‚Äî</div></div>
            <div class="metric"><div class="k">ICR ‚Äî 500√∑DTQ (g/U)</div><div id="icr" class="v">‚Äî</div></div>
            <div class="metric"><div class="k">FSI ‚Äî 1800√∑DTQ (mg/dL/U)</div><div id="fsi" class="v">‚Äî</div></div>
          </div>
          <div id="fsiWarn" class="fieldError" role="alert" aria-live="assertive" style="display:none; margin-top:8px;"></div>
        </details>

        <details>
          <summary>‚ö†Ô∏è Note de s√©curit√©</summary>
          <p>
            Cet outil est informatif. Ne remplace pas l'avis m√©dical. V√©rifie toujours les unit√©s et les valeurs avant injection.
          </p>
        </details>
      </div>
    </section>

    <!-- MODE RAPIDE -->
    <section id="panelFast" class="card" role="tabpanel" aria-labelledby="tabFast">
      <!-- CHAMPS GLYC√âMIE + GLUCIDES (Toujours visibles, EN HAUT) -->
      <div class="row2" style="margin-top:12px">
        <div class="stepper">
          <div class="label label-large">
            <span id="labelDotFast" class="dotGly" aria-hidden="true"></span>
            <span class="label-icon">ü©∏</span> Glyc√©mie actuelle (<span id="glyUnitLabel">mg/dL</span>)
          </div>
          <div class="fieldLine">
            <input id="glyFast" type="text" inputmode="decimal" min="50" step="1" value="" placeholder="Entre 50 et 500">
            <div id="glyFastErr" class="fieldError" role="status" aria-live="polite">‚ö†Ô∏è Glyc√©mie hors plage (50‚Äì500 mg/dL ou 0.5‚Äì6 g/L).</div>
            <div id="glyDangerBadge" role="alert" aria-live="assertive" style="display:none; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4;"></div>
          </div>
        </div>

        <div class="stepper">
          <div class="label label-large">
            <span class="label-icon">üç¨</span> Glucides du repas (g)
          </div>
          <div class="fieldLine">
            <input id="carbFast" type="text" inputmode="numeric" min="0" max="200" step="1" value="" placeholder="Entre 0 et 200">
            <div id="carbFastErr" class="fieldError" role="status" aria-live="polite">‚ö†Ô∏è Glucides hors plage (0 √† 200).</div>
            <div id="carbWizardLockBadge" class="carbWizardLock" style="display:none;" role="status" aria-live="polite">
              üîí Valeur saisie via le repas
              <button id="carbUnlockBtn" type="button" aria-label="Modifier manuellement les glucides">üîì Modifier</button>
            </div>
          </div>
        </div>
      </div>

      <!-- R√âSULTATS avec bouton toggle -->
      <div style="position: relative; overflow: visible;">
        <!-- Bouton toggle (mode simple uniquement) -->
        <button id="toggleDetailsBtn" 
                class="toggle-details-btn hide-in-advanced" 
                onclick="toggleBolusDetails()" 
                aria-label="Afficher les d√©tails"
                aria-expanded="false">
          <span id="toggleDetailsIcon">+</span>
        </button>
        
        <div id="resultsFastGrid" class="results" aria-label="R√©sultats rapides">
          <div id="corrFastBox" class="res bolus-detail">
            <div class="k">Correction</div><div id="corrFast" class="v">‚Äî</div>
          </div>
          <div id="repasFastBox" class="res bolus-detail">
            <div class="k">Repas</div><div id="repasFast" class="v">‚Äî</div>
          </div>
          <div class="res total">
            <div class="k">Bolus conseill√©</div><div id="totalFast" class="v">‚Äî</div>
            <div id="totalDetail" class="total-detail" aria-label="D√©tail du calcul d'arrondi"></div>
          </div>
        </div>
      </div>

      <!-- RATIOS (Seulement en mode initi√©) -->
      <div id="ratioBadgesFast" class="miniBadges hide-in-simple" aria-label="Ratios utilis√©s (rapide)">
        <span class="badge">ICR : <strong id="icrBadgeFast">‚Äî</strong> g/U</span>
        <span class="badge">FSI : <strong id="fsiBadgeFast">‚Äî</strong> mg/dL/U</span>
      </div>

      <!-- MESSAGE STATUS : R√©sultat de la composition du repas -->
      <div id="statusFast" class="status" role="status" aria-live="polite" aria-atomic="true"></div>

      <!-- BOUTONS COMPOSITION REPAS (Mode simple uniquement) -->
      <div id="repasButtonsSimple" class="hide-in-advanced" style="margin: 16px 0;">
        <div style="text-align: center; margin-bottom: 12px;">
          <h3 style="font-size: 16px; font-weight: 900; color: var(--text); margin: 0;">üåü Compose ton repas</h3>
          <p style="font-size: 13px; color: var(--muted); margin: 4px 0 0 0;">Choisis le type de repas</p>
        </div>
        <div class="repasTypeGrid" style="margin: 0 auto;">
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('petit_dejeuner')" type="button">
            <div class="repasTypeEmoji">üåÖ</div>
            <div class="repasTypeName">PETIT-D√âJ</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('dejeuner')" type="button">
            <div class="repasTypeEmoji">üçΩÔ∏è</div>
            <div class="repasTypeName">D√âJEUNER</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('gouter')" type="button">
            <div class="repasTypeEmoji">üßÅ</div>
            <div class="repasTypeName">GO√õTER</div>
          </button>
          <button class="repasTypeCard" onclick="simpleModeWizard.ouvrirRepas('diner')" type="button">
            <div class="repasTypeEmoji">üåô</div>
            <div class="repasTypeName">D√éNER</div>
          </button>
        </div>
      </div>

      <!-- WIZARD MODE SIMPLE : Modale avec overlay -->
      <div id="wizardOverlay">
        <div id="wizardModal">
          <button class="wizardCloseBtn" onclick="simpleModeWizard.fermerWizard()" aria-label="Fermer">‚úï</button>
          <div id="simpleModeContainer">
            <!-- Le wizard s'affichera ici dynamiquement -->
          </div>
        </div>
      </div>

      <!-- CONTENU MODE INITI√â UNIQUEMENT -->
      <div id="fastCalculatorFields" class="hide-in-simple">
      <!-- Bouton pour composer le repas (mode initi√© uniquement) -->
      <button 
        id="foodSearchToggle" 
        class="foodSearchToggle" 
        type="button"
        aria-expanded="false"
      >
        üçΩÔ∏è Composer mon repas
      </button>

      <!-- Panneau de recherche d'aliments -->
      <div id="foodSearchPanel" class="hidden">
        <!-- Recherche -->
        <div class="searchBox">
          <span class="searchIcon">üîç</span>
          <input 
            type="text" 
            id="foodSearchInput" 
            placeholder="Rechercher un aliment..."
            autocomplete="off"
          >
        </div>

        <!-- R√©sultats de recherche -->
        <div id="searchResults" class="searchResults"></div>

        <!-- Mon assiette -->
        <div class="myPlate">
          <h4>üçΩÔ∏è Mon assiette</h4>
          <div id="plateItems"></div>
          <div id="plateSummary"></div>
        </div>

        <!-- Bouton validation -->
        <button 
          id="validateMealBtn" 
          class="validateMealBtn"
          type="button"
          disabled
        >
          ‚úÖ Valider mon repas
        </button>
      </div>
      </div><!-- Fin fastCalculatorFields -->
    </section>

    <footer>
      Tout reste sur ton appareil. Le th√®me et le mode simple sont enregistr√©s en local.
    </footer>
  </main>
</div>

<script>
(() => {
  "use strict";

  // -------------------- Helpers --------------------
  const $ = (id) => document.getElementById(id);

  const Util = {
    toNumber(v){
      if(v === null || v === undefined) return NaN;
      const s = String(v).trim().replace(",", ".");
      if(s === "") return NaN;
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    },
    clamp(n, min, max){
      if(!Number.isFinite(n)) return NaN;
      return Math.min(max, Math.max(min, n));
    },
    roundToStep(n, step){
      if(!Number.isFinite(n)) return NaN;
      const s = Number(step);
      const safeStep = (Number.isFinite(s) && s > 0) ? s : 0.1;
      return Math.round(n / safeStep) * safeStep;
    }
  };

  const rangeOk = (n, min, max) => Number.isFinite(n) && n >= min && n <= max;

  // -------------------- Constants --------------------
  const GLY_MIN = 50, GLY_MAX = 600; // P0 audit: warning fort >600, blocage g/L >10
  const CARB_MIN = 0, CARB_MAX = 200;
  const TARGET_MIN = 70, TARGET_MAX = 180;

  const MIN_BASALE = 20, MAX_BASALE = 35;
  const MIN_RAPIDE = 10,  MAX_RAPIDE = 25;
  // P0 Issue 3 ‚Äî FSI invers√© : plage physiologique acceptable du FSI calcul√©
  const FSI_MIN = 10,  FSI_MAX = 150;  // mg/dL/U ‚Äî blocage si FSI < 5 (crit√®re audit)

  // -------------------- AppStorage (inline) --------------------
  // AppStorage doit √™tre disponible avant l'objet Storage ci-dessous.
  // On l'embarque ici plut√¥t que de le charger via <script src> externe,
  // car le script inline s'ex√©cute AVANT les scripts du bas du <body>.
  // Le fichier storage.js externe reste charg√© pour food-search-ui.js.
  // Les deux d√©finitions sont identiques ‚Äî window.AppStorage est le point commun.
  if (!window.AppStorage) {
    window.AppStorage = (() => {
      const ENVELOPE_VERSION = 1;

      function get(key, opts = {}) {
        const { maxAge, schemaVersion } = opts;
        let raw;
        try { raw = localStorage.getItem(key); } catch (e) { return null; }
        if (raw === null) return null;
        let envelope;
        try { envelope = JSON.parse(raw); } catch (e) { localStorage.removeItem(key); return null; }
        if (!envelope || typeof envelope !== 'object' || envelope.v !== ENVELOPE_VERSION) {
          localStorage.removeItem(key); return null;
        }
        if (schemaVersion !== undefined && envelope.sv !== schemaVersion) {
          localStorage.removeItem(key); return null;
        }
        const now = Date.now();
        if (maxAge !== undefined) {
          if (!Number.isFinite(envelope.savedAt) || now - envelope.savedAt > maxAge) {
            localStorage.removeItem(key); return null;
          }
        } else if (envelope.expiresAt !== null && Number.isFinite(envelope.expiresAt)) {
          if (now > envelope.expiresAt) { localStorage.removeItem(key); return null; }
        }
        return envelope.data;
      }

      function set(key, value, opts = {}) {
        const { ttl, schemaVersion } = opts;
        const now = Date.now();
        const envelope = {
          v: ENVELOPE_VERSION,
          sv: schemaVersion !== undefined ? schemaVersion : null,
          savedAt: now,
          expiresAt: (ttl !== undefined && Number.isFinite(ttl)) ? now + ttl : null,
          data: value
        };
        try { localStorage.setItem(key, JSON.stringify(envelope)); return true; }
        catch (e) { return false; }
      }

      function clear(key) {
        try { localStorage.removeItem(key); } catch (_) {}
      }

      const KEYS = {
        theme:      'bc_theme',
        simpleMode: 'bc_simple',
        ratios:     'bc_ratios',
        lastCarbs:  'bc_last_carbs',
        meal:       'bc_meal_composition',
      };
      const SCHEMA = { ratios: 2, meal: 2 };
      const TTL    = { ratios: 3 * 24 * 60 * 60 * 1000, meal: 8 * 60 * 60 * 1000 };

      return { get, set, clear, KEYS, SCHEMA, TTL };
    })();
  }
  // Alias local pour raccourcir les appels dans ce script
  const AppStorage = window.AppStorage;

  // -------------------- BolusMath (inline) --------------------
  // M√™me raison que AppStorage : le script inline s'ex√©cute avant les <script src>.
  // Les fichiers bolusMath.js et units.js externes restent charg√©s pour usage futur.
  if (!window.BolusMath) {
    window.BolusMath = (() => {
      const ICR_CONSTANT = 500;
      const FSI_CONSTANT = 1800;
      function _positif(n) { return Number.isFinite(n) && n > 0; }

      function calcRatios(basale, rapide) {
        if (!Number.isFinite(basale) || !Number.isFinite(rapide)) return { dtq: NaN, icr: NaN, fsi: NaN };
        const dtq = basale + rapide;
        if (!_positif(dtq)) return { dtq: NaN, icr: NaN, fsi: NaN };
        return { dtq, icr: ICR_CONSTANT / dtq, fsi: FSI_CONSTANT / dtq };
      }
      function calcCorrection(glycemie, objectif, fsi) {
        if (!Number.isFinite(glycemie) || !Number.isFinite(objectif) || !_positif(fsi)) return NaN;
        return (glycemie - objectif) / fsi;
      }
      function calcRepas(glucides, icr) {
        if (!Number.isFinite(glucides) || glucides < 0 || !_positif(icr)) return NaN;
        return glucides / icr;
      }
      function calcTotal(correction, repas) {
        if (!Number.isFinite(correction) || !Number.isFinite(repas)) return NaN;
        return correction + repas;
      }
      const STEP_DEFAULT = 0.1;
      function roundToStep(n, step) {
        if (!Number.isFinite(n)) return NaN;
        const s = Number(step);
        const safeStep = (Number.isFinite(s) && s > 0) ? s : STEP_DEFAULT;
        return Math.round(n / safeStep) * safeStep;
      }
      function clamp(n, min, max) {
        if (!Number.isFinite(n)) return NaN;
        return Math.min(max, Math.max(min, n));
      }
      function calcBolus({ glycemie, objectif, glucides, basale, rapide, step = 0.1 }) {
        const { dtq, icr, fsi } = calcRatios(basale, rapide);
        const correction   = calcCorrection(glycemie, objectif, fsi);
        const repas        = calcRepas(glucides, icr);
        const total        = calcTotal(correction, repas);
        const totalArrondi = roundToStep(total, step);
        return { correction, repas, total, totalArrondi, dtq, icr, fsi };
      }
      return { calcRatios, calcCorrection, calcRepas, calcTotal, calcBolus, roundToStep, clamp, ICR_CONSTANT, FSI_CONSTANT };
    })();
  }
  const BolusMath = window.BolusMath;

  if (!window.GlyUnits) {
    window.GlyUnits = (() => {
      const GL_TO_MGDL = 100, MGDL_TO_GL = 1/100, MMOL_TO_MGDL = 18.016, MGDL_TO_MMOL = 1/18.016;
      const RANGE = { min: 20, max: 600 };
      function _parse(str) {
        if (str === null || str === undefined) return NaN;
        const s = String(str).trim().replace(',', '.');
        if (s === '') return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }
      function mgdlToGl(v)  { const n = _parse(v); return Number.isFinite(n) ? n * MGDL_TO_GL : NaN; }
      function glToMgdl(v)  { const n = _parse(v); return Number.isFinite(n) ? n * GL_TO_MGDL : NaN; }
      function mgdlToMmol(v){ const n = _parse(v); return Number.isFinite(n) ? n * MGDL_TO_MMOL : NaN; }
      function mmolToMgdl(v){ const n = _parse(v); return Number.isFinite(n) ? n * MMOL_TO_MGDL : NaN; }
      function parseGly(str, opts = {}) {
        const n = _parse(str);
        if (!Number.isFinite(n)) return NaN;
        if (!opts.allowOutOfRange && (n < RANGE.min || n > RANGE.max)) return NaN;
        return n;
      }
      function parseGlyGl(str) {
        const gl = _parse(str);
        if (!Number.isFinite(gl)) return NaN;
        const mgdl = glToMgdl(gl);
        if (!Number.isFinite(mgdl) || mgdl < RANGE.min || mgdl > RANGE.max) return NaN;
        return mgdl;
      }
      function formatMgdl(v) { return Number.isFinite(v) ? String(Math.round(v)) : '‚Äî'; }
      function formatGl(v)   { return Number.isFinite(v) ? v.toFixed(1) : '‚Äî'; }
      function detectUnit(str) {
        const n = _parse(str);
        if (!Number.isFinite(n)) return 'unknown';
        if (n >= RANGE.min && n <= RANGE.max) return 'mgdl';
        if (n > 0 && n < RANGE.min) { const m = glToMgdl(n); if (m >= RANGE.min && m <= RANGE.max) return 'gl'; }
        return 'unknown';
      }
      return { mgdlToGl, glToMgdl, mgdlToMmol, mmolToMgdl, parseGly, parseGlyGl, formatMgdl, formatGl, detectUnit, GL_TO_MGDL, MGDL_TO_GL, MMOL_TO_MGDL, MGDL_TO_MMOL, RANGE };
    })();
  }
  const GlyUnits = window.GlyUnits; // eslint-disable-line no-unused-vars (utilis√© pour usage futur)

  // -------------------- Storage --------------------
  // Wrapper mince qui mappe les m√©thodes de l'app vers AppStorage.
  const Storage = {

    getTheme(){
      return AppStorage.get(AppStorage.KEYS.theme) || 'clair';
    },
    setTheme(v){
      AppStorage.set(AppStorage.KEYS.theme, v); // pas de TTL : persistant
    },

    getSimple(){
      const val = AppStorage.get(AppStorage.KEYS.simpleMode);
      if (val === null) return true; // mode simple par d√©faut si jamais configur√©
      return val === true || val === '1' || val === 1;
    },
    setSimple(v){
      AppStorage.set(AppStorage.KEYS.simpleMode, v ? '1' : '0'); // pas de TTL : persistant
    },

    getLastCarbs(){
      const n = AppStorage.get(AppStorage.KEYS.lastCarbs);
      if (n === null) return null;
      const parsed = typeof n === 'number' ? n : Util.toNumber(String(n));
      return Number.isFinite(parsed) ? parsed : null;
    },
    setLastCarbs(v){
      if (Number.isFinite(v)) AppStorage.set(AppStorage.KEYS.lastCarbs, v); // persistant
    },

    // Ratios persist√©s 3 jours ‚Äî avec schemaVersion
    getRatios(){
      const o = AppStorage.get(AppStorage.KEYS.ratios, {
        schemaVersion: AppStorage.SCHEMA.ratios
      });
      if (!o || typeof o !== 'object') return null;
      const r = {
        basale:  Util.toNumber(o.basale),
        rapide:  Util.toNumber(o.rapide),
        objectif: Util.toNumber(o.objectif),
        step:    Util.toNumber(o.step)
      };
      // V√©rification minimaliste : basale et rapide doivent √™tre des nombres finis
      if (!Number.isFinite(r.basale) || !Number.isFinite(r.rapide)) return null;
      return r;
    },
    setRatios({ basale, rapide, objectif, step }){
      AppStorage.set(
        AppStorage.KEYS.ratios,
        { basale, rapide, objectif, step },
        { ttl: AppStorage.TTL.ratios, schemaVersion: AppStorage.SCHEMA.ratios }
      );
    },
    clearRatios(){
      AppStorage.clear(AppStorage.KEYS.ratios);
    }
  };

  // -------------------- DOM --------------------
  const el = {
    // header / toggles
    themeBtn: $("themeBtn"),
    themeIcon: $("themeIcon"),
    simpleBtn: $("simpleBtn"),
    simpleBtnIcon: $("simpleBtnIcon"),
    simpleText: $("simpleText"),

    // settings
    settingsBtn: $("settingsBtn"),
    settingsPanel: $("settingsPanel"),
    ratioAlert: $("ratioAlert"),

    basale: $("basale"),
    rapide: $("rapide"),
    objectif: $("objectif"),
    arrondi: $("arrondi"),

    basaleErr: $("basaleErr"),
    rapideErr: $("rapideErr"),
    objectifErr: $("objectifErr"),

    // fast inputs
    glyFast: $("glyFast"),
    carbFast: $("carbFast"),
    carbWizardLockBadge: $("carbWizardLockBadge"),
    glyFastErr: $("glyFastErr"),
    glyDangerBadge: $("glyDangerBadge"),
    carbFastErr: $("carbFastErr"),

    // unit labels (dynamic)
    glyUnitLabel: $("glyUnitLabel"),
    pillGlyUnit: $("pillGlyUnit"),

    // unit labels (dynamic)
    glyUnitLabel: $("glyUnitLabel"),
    pillGlyUnit: $("pillGlyUnit"),

    // pills
    pillGly: $("pillGly"),
    pillCarbs: $("pillCarbs"),
    pillTarget: $("pillTarget"),
    dtq: $("dtq"),
    icr: $("icr"),
    fsi: $("fsi"),
    fsiWarn: $("fsiWarn"),
    icrBadgeFast: $("icrBadgeFast"),
    fsiBadgeFast: $("fsiBadgeFast"),

    // results
    corrFast: $("corrFast"),
    repasFast: $("repasFast"),
    totalFast: $("totalFast"),
    totalDetail: $("totalDetail"),

    statusFast: $("statusFast"),
    status: $("status")
  };

  // -------------------- UI State --------------------
  const Touched = { gly:false, carbs:false, objectif:false, basale:false, rapide:false };
  let simpleMode = false;
  // Note : window.simpleModeWizard est g√©r√© par app.js (bootstrap unique)

  // -------------------- Theme --------------------
  function applyTheme(theme){
    document.documentElement.dataset.theme = theme;
    if(el.themeIcon) el.themeIcon.textContent = (theme === "sombre") ? "üåô" : "‚òÄÔ∏è";
  }

  function initTheme(){
    const t = Storage.getTheme();
    applyTheme(t);
  }

  function toggleTheme(){
    const cur = Storage.getTheme();
    const next = (cur === "clair") ? "sombre" : "clair";
    Storage.setTheme(next);
    applyTheme(next);
  }

  // -------------------- Simple mode --------------------
  function applySimpleMode(){
    if(el.simpleBtn) el.simpleBtn.setAttribute("aria-pressed", String(simpleMode));
    if(el.simpleText) el.simpleText.textContent = simpleMode ? "Mode simple" : "Mode initi√©";
    
    // Changer l'ic√¥ne du bouton toggle
    if(el.simpleBtnIcon){
      el.simpleBtnIcon.textContent = simpleMode ? "üåü" : "üî≠";
    }
    
    document.body.classList.toggle("simple-mode", !!simpleMode);
    
    // NOUVEAU : G√©rer l'affichage wizard vs contenu mode initi√©
    const wizardContainer = document.getElementById('simpleModeContainer');
    const initiatedContent = document.getElementById('fastCalculatorFields');
    
    if(simpleMode){
      // MODE SIMPLE : Afficher le wizard, cacher le contenu mode initi√©
      if(wizardContainer) {
        wizardContainer.classList.remove('hidden');
        // Initialiser le wizard (instance g√©r√©e par app.js)
        if(window.simpleModeWizard){
          // Ne pas rappeler init() (d√©j√† fait par app.js au boot).
          // On veut simplement afficher l'√©cran d'accueil du wizard.
          window.simpleModeWizard.afficherChoixRepas();
        }
      }
      if(initiatedContent) initiatedContent.classList.add('hidden');
      
      // Les champs Glyc√©mie et Glucides restent TOUJOURS visibles
      // Les d√©tails (Correction, Repas, ICR, FSI) sont cach√©s par CSS (.hide-in-simple)
    } else {
      // MODE INITI√â : Cacher le wizard, afficher le contenu mode initi√©
      if(wizardContainer) wizardContainer.classList.add('hidden');
      if(initiatedContent) initiatedContent.classList.remove('hidden');
      
      // Tous les d√©tails sont visibles
    }
  }

  function toggleSimpleMode(){
    simpleMode = !simpleMode;
    Storage.setSimple(simpleMode);
    applySimpleMode();
    render();
  }

  // -------------------- Toggle d√©tails bolus (mode simple) --------------------
  function toggleBolusDetails() {
    const isShowing = document.body.classList.toggle('show-bolus-details');
    const btn = document.getElementById('toggleDetailsBtn');
    const icon = document.getElementById('toggleDetailsIcon');
    if (btn && icon) {
      icon.textContent = isShowing ? '‚àí' : '+';
      btn.setAttribute('aria-expanded', String(isShowing));
      btn.setAttribute('aria-label', isShowing ? 'Masquer les d√©tails' : 'Afficher les d√©tails');
    }
    
    // Recalculer et afficher les valeurs
    render();
  }
  
  // Rendre la fonction accessible globalement
  window.toggleBolusDetails = toggleBolusDetails;

  // -------------------- Field errors --------------------
  function setFieldError(inputEl, errEl, show){
    if(!inputEl || !errEl) return;
    inputEl.classList.toggle("input-error", !!show);
    errEl.classList.toggle("show", !!show);
  }

  // -------------------- Settings panel lock --------------------
  function setEditingRatios(isEditing){
    document.body.classList.toggle("editing-ratios", !!isEditing);
  }

  function toggleSettings(){
    if(!el.settingsPanel || !el.settingsBtn) return;
    const isOpen = !el.settingsPanel.classList.contains("hidden");
    el.settingsPanel.classList.toggle("hidden", isOpen);
    el.settingsBtn.setAttribute("aria-expanded", String(!isOpen));
    setEditingRatios(!isOpen);
    if(!isOpen){
      // opening: focus sur objectif glyc√©mie pour accessibilit√© clavier
      setTimeout(() => {
        el.objectif?.focus();
      }, 100);
    }
  }

  // -------------------- Ratios / DTQ / ICR / FSI --------------------
  function ratiosInRange(basale, rapide){
    const ok = Number.isFinite(basale) && Number.isFinite(rapide)
      && basale >= MIN_BASALE && basale <= MAX_BASALE
      && rapide >= MIN_RAPIDE && rapide <= MAX_RAPIDE;
    return ok;
  }

  /**
   * Valide basale/rapide ET le FSI calcul√© r√©sultant.
   * P0 Issue 3 : FSI hors plage [FSI_MIN, FSI_MAX] ‚Üí warning + blocage si FSI < 5.
   */
  function updateRatioAlert(basale, rapide){
    const ok = ratiosInRange(basale, rapide);
    if(el.ratioAlert){
      el.ratioAlert.classList.toggle("show", !ok);
    }
    setFieldError(el.basale, el.basaleErr, Touched.basale && !(Number.isFinite(basale) && basale >= MIN_BASALE && basale <= MAX_BASALE));
    setFieldError(el.rapide, el.rapideErr, Touched.rapide && !(Number.isFinite(rapide) && rapide >= MIN_RAPIDE && rapide <= MAX_RAPIDE));

    // ‚îÄ‚îÄ Validation du FSI calcul√© (P0 Issue 3) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let fsiOk = true;
    if (el.fsiWarn) {
      if (ok) {
        const dtq = basale + rapide;
        const fsi = 1800 / dtq;
        if (fsi < 5) {
          // Blocage dur ‚Äî FSI < 5 : correction serait dangereusement √©lev√©e
          el.fsiWarn.textContent = `üö´ FSI calcul√© : ${fsi.toFixed(1)} mg/dL/U ‚Äî valeur impossible (< 5). V√©rifiez vos doses d'insuline.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else if (fsi < FSI_MIN) {
          // Warning fort ‚Äî FSI tr√®s bas (correction puissante)
          el.fsiWarn.textContent = `‚ö†Ô∏è FSI calcul√© : ${fsi.toFixed(1)} mg/dL/U ‚Äî tr√®s sensible (norme : 10‚Äì150 mg/dL/U). Confirmez avec votre √©quipe soignante.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else if (fsi > FSI_MAX) {
          // Warning fort ‚Äî FSI tr√®s √©lev√© (correction faible, possible sous-dosage)
          el.fsiWarn.textContent = `‚ö†Ô∏è FSI calcul√© : ${fsi.toFixed(1)} mg/dL/U ‚Äî valeur inhabituelle (norme : 10‚Äì150 mg/dL/U). V√©rifiez vos doses.`;
          el.fsiWarn.style.display = 'block';
          fsiOk = false;
        } else {
          el.fsiWarn.style.display = 'none';
          el.fsiWarn.textContent = '';
        }
      } else {
        el.fsiWarn.style.display = 'none';
        el.fsiWarn.textContent = '';
      }
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    return ok && fsiOk;
  }

  function validateTarget(){
    const t = Util.toNumber(el.objectif?.value);
    const invalid = !rangeOk(t, TARGET_MIN, TARGET_MAX);
    setFieldError(el.objectif, el.objectifErr, Touched.objectif && invalid);
    return { target: t, ok: !invalid };
  }

  function computeRatios(basale, rapide){
    // D√©l√®gue √† BolusMath ‚Äî source unique de v√©rit√© pour ICR/FSI/DTQ
    return BolusMath.calcRatios(basale, rapide);
  }

  function readCommonParams(){
    const basale = Util.toNumber(el.basale?.value);
    const rapide = Util.toNumber(el.rapide?.value);
    const rawStep = Util.toNumber(el.arrondi?.value);
    const VALID_STEPS = [0.1, 0.5, 1];
    const step = VALID_STEPS.includes(rawStep) ? rawStep : 0.1;
    if (!VALID_STEPS.includes(rawStep) && el.arrondi) el.arrondi.value = '0.1';
    const tv = validateTarget();
    const ratiosOk = updateRatioAlert(basale, rapide);

    if(!ratiosOk || !tv.ok){
      return { basale, rapide, objectif: tv.target, step, ratiosOk:false, targetOk: tv.ok, dtq:NaN, icr:NaN, fsi:NaN };
    }
    const { dtq, icr, fsi } = computeRatios(basale, rapide);
    return { basale, rapide, objectif: tv.target, step, ratiosOk:true, targetOk:true, dtq, icr, fsi };
  }

  // -------------------- S√©curit√© P0 : popup confirmation unit√© glyc√©mie --------------------
  let _lastGlyWarnValue = null; // anti-spam : ne r√©p√®te pas le popup pour la m√™me valeur

  /**
   * Affiche un popup de confirmation quand la valeur saisie est suspecte.
   * @param {number} rawVal  - Valeur brute saisie
   * @param {'mgdl-overflow'} type
   */
  function _showGlyUnitWarning(rawVal, type) {
    if (type === 'mgdl-overflow') {
      const asGl   = GlyUnits.mgdlToGl(rawVal);          // ex: 180 ‚Üí 1.8 g/L
      const asMgdl = Math.round(rawVal);                   // la valeur telle que saisie
      const msg =
        `‚ö†Ô∏è V√©rification unit√© glyc√©mie\n\n` +
        `Vous avez saisi : ${asMgdl}\n\n` +
        `‚Ä¢ En mg/dL ‚Üí ${asMgdl} mg/dL (tr√®s √©lev√©, hyperglyc√©mie s√©v√®re)\n` +
        `‚Ä¢ En g/L   ‚Üí ${asMgdl} g/L = ${asMgdl * 100} mg/dL (valeur physiologiquement impossible)\n\n` +
        `Si vous √™tes bien en mg/dL, la valeur sera accept√©e.\n` +
        `Sinon, corrigez votre saisie ou changez d'unit√©.`;
      // Utilise window.confirm natif (synchrone, accessible, pas de d√©pendance)
      const confirmed = window.confirm(msg);
      if (!confirmed) {
        // Vider le champ ‚Üí force re-saisie
        if (el.glyFast) {
          el.glyFast.value = '';
          _lastGlyWarnValue = null;
        }
      }
    }
  }

  // -------------------- Inputs validation (fast mode only) --------------------
  function validateMealInputs(){
    const rawGly = el.glyFast?.value ?? '';
    const c = Util.toNumber(el.carbFast?.value);

    // --- D√©tection automatique de l'unit√© glyc√©mie ---
    const detectedUnit = GlyUnits.detectUnit(rawGly); // 'mgdl' | 'gl' | 'unknown'
    const rawNum = Util.toNumber(rawGly);
    let g;
    if (detectedUnit === 'gl') {
      g = GlyUnits.glToMgdl(rawGly);   // converti en mg/dL pour tous les calculs
    } else {
      g = rawNum;                        // mg/dL direct
    }

    // Mise √† jour visuelle de l'unit√© d√©tect√©e
    const unitLabel = detectedUnit === 'gl' ? 'g/L' : 'mg/dL';
    if (el.glyUnitLabel)  el.glyUnitLabel.textContent  = unitLabel;
    if (el.pillGlyUnit)   el.pillGlyUnit.textContent   = unitLabel;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // S√âCURIT√â P0 ‚Äî D√©tection confusion unit√©s mg/dL ‚Üî g/L
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let glyErrMsg = '‚ö†Ô∏è Glyc√©mie hors plage (50‚Äì500 mg/dL ou 0.5‚Äì6 g/L).';
    let glyHardBlock = false;

    if (Number.isFinite(rawNum) && rawNum > 0) {
      // CAS 1 : Saisie > 600 mg/dL ‚Üí suspicion de saisie en g/L (ex: 180 g/L)
      // Crit√®re audit : saisie > 600 mg/dL ‚Üí warning fort
      if (detectedUnit !== 'gl' && rawNum > 600) {
        const asGl = GlyUnits.mgdlToGl(rawNum);
        glyErrMsg = `üö® ${rawNum} mg/dL d√©passe 600 ‚Äî saisi en g/L ? (${rawNum} g/L = ${Math.round(rawNum * 100)} mg/dL). V√©rifiez votre unit√©.`;
        // D√©clenchement popup unique par valeur (√©vite le spam)
        if (Touched.gly && rawNum !== _lastGlyWarnValue) {
          _lastGlyWarnValue = rawNum;
          _showGlyUnitWarning(rawNum, 'mgdl-overflow');
        }
      }

      // CAS 2 : Saisie d√©tect√©e g/L > 10 g/L ‚Üí BLOCAGE (= 1000 mg/dL, impossible)
      // Crit√®re audit : saisie > 10 g/L ‚Üí blocage
      // Note : detectUnit retourne 'gl' pour 0.2‚Äì5.9, 'unknown' au-del√† ‚Üí on couvre les deux
      if ((detectedUnit === 'gl' && rawNum > 10) || (detectedUnit === 'unknown' && rawNum > 10 && rawNum < GLY_MIN)) {
        glyErrMsg = `üö´ ${rawNum} g/L est impossible (max physiologique ‚âà 6 g/L = 600 mg/dL). V√©rifiez votre saisie.`;
        glyHardBlock = true;
        g = NaN; // Force invalide ‚Äî bloque le calcul
      }

      // CAS 3 : Valeur dans zone ambigu√´ (100‚Äì600) alors que l'utilisateur pourrait
      // avoir saisi en g/L sans le savoir (ex: "1.8" d√©tect√© g/L ‚Üí 180 mg/dL, OK mais
      // on confirme visuellement pour rassurer)
    }
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const glyInvalid = glyHardBlock || !rangeOk(g, GLY_MIN, GLY_MAX);
    const carbInvalid = !rangeOk(c, CARB_MIN, CARB_MAX);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // S√âCURIT√â P1 ‚Äî Glyc√©mie aberrante (Issue 4)
    // Badge rouge "valeur inhabituelle" pour glyc√©mies s√©v√®res mais accept√©es
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (el.glyDangerBadge) {
      const gVal = Number.isFinite(g) ? g : rawNum; // valeur en mg/dL pour les seuils
      if (!glyInvalid && Number.isFinite(gVal)) {
        if (gVal >= 501) {
          // Seuil m√©dical DKA/HHS : > 500 mg/dL ‚Üí urgence m√©tabolique potentielle
          el.glyDangerBadge.textContent = 'üö® Valeur critique (> 500 mg/dL) ‚Äî Consultez imm√©diatement votre √©quipe soignante avant toute injection.';
          el.glyDangerBadge.style.cssText = 'display:block; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4; background:rgba(239,68,68,0.18); border:1.5px solid rgba(239,68,68,0.55); color:inherit;';
        } else if (gVal >= 400) {
          // Seuil interm√©diaire : hyperglyc√©mie s√©v√®re
          el.glyDangerBadge.textContent = '‚ö†Ô∏è Hyperglyc√©mie s√©v√®re (‚â• 400 mg/dL) ‚Äî V√©rifiez votre glyc√©mie avant injection.';
          el.glyDangerBadge.style.cssText = 'display:block; margin-top:6px; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:800; line-height:1.4; background:rgba(251,113,133,0.14); border:1.5px solid rgba(251,113,133,0.45); color:inherit;';
        } else {
          el.glyDangerBadge.style.display = 'none';
          el.glyDangerBadge.textContent = '';
        }
      } else {
        el.glyDangerBadge.style.display = 'none';
        el.glyDangerBadge.textContent = '';
      }
    }
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Mise √† jour dynamique du message d'erreur glyc√©mie
    if (el.glyFastErr) el.glyFastErr.textContent = glyErrMsg;
    setFieldError(el.glyFast, el.glyFastErr, Touched.gly && glyInvalid);
    setFieldError(el.carbFast, el.carbFastErr, Touched.carbs && carbInvalid);

    const confirmed = Touched.gly && Touched.carbs;
    
    // Effet n√©on si le champ est vide ou invalide (et pas encore touch√© pour √©viter l'erreur rouge)
    const glyEmpty = !rawGly || glyInvalid;
    const carbEmpty = !el.carbFast?.value || carbInvalid;
    
    if(el.glyFast){
      if(glyEmpty && !Touched.gly){
        el.glyFast.classList.add("input-required-empty");
      } else {
        el.glyFast.classList.remove("input-required-empty");
      }
    }
    
    if(el.carbFast){
      if(carbEmpty && !Touched.carbs){
        el.carbFast.classList.add("input-required-empty");
      } else {
        el.carbFast.classList.remove("input-required-empty");
      }
    }

    return { gly: g, glyRaw: rawGly, glyUnit: detectedUnit, carbs: c, ok: !(glyInvalid || carbInvalid), confirmed };
  }

  // -------------------- Status --------------------
  function setStatus(level, text){
    const node = el.statusFast || el.status;
    if(!node) return;
    
    // NOUVEAU : V√©rifier si un message du wizard est pr√©sent
    const wizardMessage = node.querySelector('[data-wizard-preserved="true"]');
    
    // Si un message wizard existe, ne PAS l'√©craser
    if(wizardMessage){
      // Mettre √† jour seulement la classe (pour la couleur de fond)
      node.classList.remove("ok","warn","bad","info");
      node.classList.add("ok"); // Toujours vert si wizard message pr√©sent
      return; // Ne rien faire d'autre - pr√©server le message
    }
    
    // Sinon, comportement normal
    node.classList.remove("ok","warn","bad","info");
    node.classList.add(level);

    const icon = (level === "ok") ? "‚úÖ" : (level === "warn") ? "‚ö†Ô∏è" : (level === "info") ? "üíé" : "‚õî";
    node.innerHTML = "";
    const i = document.createElement("span");
    i.className = "statusIcon";
    i.setAttribute("aria-hidden","true");
    i.textContent = icon;
    const t = document.createElement("span");
    t.className = "statusText";
    t.textContent = text;
    node.appendChild(i);
    node.appendChild(t);
  }

  // -------------------- Calculation --------------------
  function calcBolus(){
    const p = readCommonParams();
    const v = validateMealInputs();

    // gate: ratios + target
    if(!p.ratiosOk || !p.targetOk){
      setStatus("warn", "V√©rifie les param√®tres (insulines quotidiennes et objectif).");
      return null;
    }
    // gate: inputs in range - mais seulement afficher l'erreur si les champs sont vraiment invalides (et touch√©s)
    if(!v.ok && v.confirmed){
      setStatus("warn", "V√©rifie les champs en rouge");
      return null;
    }
    // gate: user confirmation (touch) - si pas confirm√©, on garde le message bleu
    if(!v.confirmed){
      setStatus("info", "Compl√®te les champs en bleu pour calculer ton bolus");
      return null;
    }

    // keep last carbs
    if(Number.isFinite(v.carbs)) Storage.setLastCarbs(v.carbs);

    // D√©l√®gue √† BolusMath ‚Äî source unique de v√©rit√© pour les formules
    const { correction, repas, total, totalArrondi } = BolusMath.calcBolus({
      glycemie:  v.gly,
      objectif:  p.objectif,
      glucides:  v.carbs,
      basale:    p.basale,
      rapide:    p.rapide,
      step:      p.step
    });

    // R√®gle produit : pas de bolus n√©gatif conseill√©.
    const isHypo = Number.isFinite(totalArrondi) && totalArrondi < 0;
    const totalConseille = isHypo ? 0 : totalArrondi;

    return { ...p, ...v, correction, repas, total, totalArrondi, totalConseille, isHypo };
  }

  // -------------------- Rendering --------------------
  function renderPills(params){
    // Affichage des donn√©es (pills)
    const t = params?.objectif;
    if(el.pillTarget) el.pillTarget.textContent = (Number.isFinite(t) && rangeOk(t, TARGET_MIN, TARGET_MAX)) ? String(t) : "‚Äî";

    const rawGly = el.glyFast?.value ?? '';
    const detectedUnit = GlyUnits.detectUnit(rawGly);
    const gMgdl = detectedUnit === 'gl' ? GlyUnits.glToMgdl(rawGly) : Util.toNumber(rawGly);
    // Affichage dans l'unit√© saisie par l'utilisateur
    const gDisplay = detectedUnit === 'gl'
      ? (Number.isFinite(gMgdl) ? GlyUnits.formatGl(GlyUnits.mgdlToGl(gMgdl)) : '‚Äî')
      : (Number.isFinite(gMgdl) ? String(Math.round(gMgdl)) : '‚Äî');
    if(el.pillGly) el.pillGly.textContent = gDisplay;
    const g = gMgdl; // mg/dL pour les seuils de couleur ci-dessous
    
    // Coloration du point glyc√©mie selon la valeur (pour les pills et le champ input)
    const pillDot = $("pillDot");
    const labelDotFast = $("labelDotFast");
    
    if(Number.isFinite(g) && Number.isFinite(t)){
      const classes = [];
      if(g < t - 20) classes.push("bad");           // Hypo
      else if(g < t) classes.push("cool");          // L√©g√®rement bas
      else if(g <= t + 20) classes.push("good");    // Objectif
      else if(g <= t + 50) classes.push("warn");    // L√©g√®rement haut
      else classes.push("bad");                     // Hyper
      
      // Appliquer aux deux points
      if(pillDot){
        pillDot.classList.remove("cool", "good", "warn", "bad");
        pillDot.classList.add(...classes);
      }
      if(labelDotFast){
        labelDotFast.classList.remove("cool", "good", "warn", "bad");
        labelDotFast.classList.add(...classes);
      }
    } else {
      // Reset si pas de valeur
      if(pillDot) pillDot.classList.remove("cool", "good", "warn", "bad");
      if(labelDotFast) labelDotFast.classList.remove("cool", "good", "warn", "bad");
    }

    const c = Util.toNumber(el.carbFast?.value);
    if(el.pillCarbs) el.pillCarbs.textContent = Number.isFinite(c) ? String(c) : "‚Äî";

    // Ratios calcul√©s (DTQ / ICR / FSI) visibles dans Param√®tres / d√©tails
    if(el.dtq) el.dtq.textContent = Number.isFinite(params?.dtq) ? params.dtq.toFixed(1) : "‚Äî";
    if(el.icr) el.icr.textContent = Number.isFinite(params?.icr) ? params.icr.toFixed(1) : "‚Äî";
    if(el.fsi) el.fsi.textContent = Number.isFinite(params?.fsi) ? params.fsi.toFixed(1) : "‚Äî";

    // Badges rapides (mode initi√© seulement)
    const icrTxt = Number.isFinite(params?.icr) ? params.icr.toFixed(1) : "‚Äî";
    const fsiTxt = Number.isFinite(params?.fsi) ? params.fsi.toFixed(1) : "‚Äî";
    if(el.icrBadgeFast) el.icrBadgeFast.textContent = icrTxt;
    if(el.fsiBadgeFast) el.fsiBadgeFast.textContent = fsiTxt;
  }

  function renderResults(r){
    const fmt = (n) => Number.isFinite(n) ? n.toFixed(2) : "‚Äî";
    const fmt1 = (n) => Number.isFinite(n) ? n.toFixed(1) : "‚Äî";

    const showDetails = document.body.classList.contains('show-bolus-details');

    if(simpleMode && !showDetails){
      if(el.totalFast)   el.totalFast.textContent   = r ? fmt1(r.totalConseille) : "‚Äî";
      if(el.corrFast)    el.corrFast.textContent    = "‚Äî";
      if(el.repasFast)   el.repasFast.textContent   = "‚Äî";
      if(el.totalDetail) el.totalDetail.textContent = "";
      return;
    }

    if(!r){
      if(el.corrFast)    el.corrFast.textContent    = "‚Äî";
      if(el.repasFast)   el.repasFast.textContent   = "‚Äî";
      if(el.totalFast)   el.totalFast.textContent   = "‚Äî";
      if(el.totalDetail) el.totalDetail.textContent = "";
      return;
    }

    if(el.corrFast)  el.corrFast.textContent  = fmt(r.correction);
    if(el.repasFast) el.repasFast.textContent = fmt(r.repas);
    if(el.totalFast) el.totalFast.textContent = fmt1(r.totalConseille);

    // Ligne d'arrondi : montre le total exact ‚Üí arrondi au pas
    // Exemples : "= 6.36 ‚Üí arrondi 6.5 U (pas 0.5)"  /  "= 6.00 ‚Üí exact"
    if(el.totalDetail && Number.isFinite(r.total)){
      const exactStr  = r.total.toFixed(2);
      const stepStr   = String(r.step);
      const isExact   = Math.abs(r.total - r.totalConseille) < 0.001;
      el.totalDetail.textContent = isExact
        ? `= ${exactStr} U (exact)`
        : `= ${exactStr} ‚Üí arrondi au pas ${stepStr} U`;
    }
  }

  // ‚îÄ‚îÄ P2 Issue 7 ‚Äî Verrou wizard sur le champ glucides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Expos√©es sur window pour √™tre accessibles depuis simple-mode-wizard.js
  // et food-search-ui.js (scripts externes, hors closure)
  window.lockCarbField = function(sourceLabel) {
    const field = document.getElementById('carbFast');
    const badge = document.getElementById('carbWizardLockBadge');
    if (!field) return;
    field.setAttribute('readonly', 'true');
    if (badge) badge.style.display = 'flex';
  };
  window.unlockCarbField = function() {
    const field = document.getElementById('carbFast');
    const badge = document.getElementById('carbWizardLockBadge');
    if (!field) return;
    field.removeAttribute('readonly');
    field.classList.remove('input-required-empty');
    if (badge) badge.style.display = 'none';
    field.focus();
  };
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function render(){
    const p = readCommonParams();
    renderPills(p);

    const result = calcBolus();
    renderResults(result);

    if(result){
      if(result.isHypo){
        setStatus("bad", "‚õî Glyc√©mie basse ‚Äî 0 U conseill√©. Resucrage recommand√©, ne pas injecter.");
      } else {
        // P1 Issue 4 ‚Äî Alerte physiologique glyc√©mie aberrante
        if (Number.isFinite(result.gly) && result.gly >= 501) {
          setStatus("bad", "üö® Glyc√©mie critique (> 500 mg/dL) ‚Äî Consultez imm√©diatement votre √©quipe soignante. Bolus calcul√© √† titre indicatif uniquement.");
        } else if (Number.isFinite(result.gly) && result.gly >= 400) {
          setStatus("warn", "‚ö†Ô∏è Hyperglyc√©mie s√©v√®re (‚â• 400 mg/dL) ‚Äî V√©rifiez votre glyc√©mie avant toute injection.");
        } else {
          setStatus("ok", "Calcul du Bolus r√©alis√©");
        }
        if(p.rapide > p.basale){
          setStatus("warn", "‚ö†Ô∏è Insuline rapide > basale : v√©rifie que c'est coh√©rent.");
        }
      }
    }
    // Pas de else ici - on laisse calcBolus() g√©rer les messages d'erreur/info
  }

  // -------------------- Init --------------------
  function init(){
    // Theme / simple mode
    initTheme();
    simpleMode = Storage.getSimple();
    
    // Note : window.simpleModeWizard est cr√©√© par app.js apr√®s ce script
    
    applySimpleMode();

    // Restore ratios (3 days) if available
    const saved = Storage.getRatios();
    if(saved && el.basale && el.rapide && el.objectif && el.arrondi){
      el.basale.value = Number.isFinite(saved.basale) ? String(saved.basale) : "";
      el.rapide.value = Number.isFinite(saved.rapide) ? String(saved.rapide) : "";
      el.objectif.value = Number.isFinite(saved.objectif) ? String(saved.objectif) : el.objectif.value;
      el.arrondi.value = Number.isFinite(saved.step) ? String(saved.step) : el.arrondi.value;
      
      // Marquer comme "touched" et valider si les valeurs restaur√©es sont invalides
      if(!ratiosInRange(saved.basale, saved.rapide)){
        Touched.basale = true;
        Touched.rapide = true;
      }
      if(!rangeOk(saved.objectif, TARGET_MIN, TARGET_MAX)){
        Touched.objectif = true;
      }
    }

    // Restore last carbs (does NOT count as confirmation)
    // D√©sactiv√© : on force l'utilisateur √† entrer ses glucides √† chaque fois
    /*
    const lastC = Storage.getLastCarbs();
    if(Number.isFinite(lastC) && el.carbFast){
      el.carbFast.value = String(lastC);
    }
    */

    // Touch tracking (show errors only after user interaction)
    const mark = (k) => { if(k in Touched) Touched[k] = true; };

    el.glyFast?.addEventListener("input", () => { mark("gly"); render(); }, { passive:true });
    el.glyFast?.addEventListener("blur",  () => { mark("gly"); render(); }, { passive:true });
    el.glyFast?.addEventListener("change",() => { mark("gly"); render(); }, { passive:true });

    // ‚îÄ‚îÄ P2 Issue 8 ‚Äî Normalisation virgule ‚Üí point en temps r√©el ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // input[type="text"] laisse JS lire la valeur brute incluant la virgule.
    // On remplace imm√©diatement avant que toNumber() ne soit appel√©.
    const DECIMAL_FIELDS = ['glyFast', 'carbFast', 'basale', 'rapide', 'objectif'];
    DECIMAL_FIELDS.forEach(id => {
      const field = document.getElementById(id);
      if (!field) return;
      field.addEventListener('input', () => {
        const raw = field.value;
        const normalized = raw.replace(/,/g, '.');
        if (normalized !== raw) {
          // Pr√©server la position du curseur
          const pos = field.selectionStart;
          field.value = normalized;
          // Repositionner le curseur (la virgule et le point ont la m√™me largeur)
          try { field.setSelectionRange(pos, pos); } catch(e) {}
        }
      }, { passive: true });
    });
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    el.carbFast?.addEventListener("input", () => { mark("carbs"); render(); }, { passive:true });
    el.carbFast?.addEventListener("blur",  () => { mark("carbs"); render(); }, { passive:true });
    el.carbFast?.addEventListener("change",() => { mark("carbs"); render(); }, { passive:true });

    // P2 Issue 7 ‚Äî Bouton d√©verrouillage manuel du champ glucides
    document.getElementById("carbUnlockBtn")?.addEventListener("click", () => {
      window.unlockCarbField();
      mark("carbs");
      render();
    });

    // NOUVEAU : Effacer le message wizard si modification manuelle des glucides
    el.carbFast?.addEventListener("input", function(){
      const statusNode = el.statusFast || el.status;
      if(statusNode){
        const wizardMessage = statusNode.querySelector('[data-wizard-preserved="true"]');
        if(wizardMessage){
          // L'utilisateur modifie manuellement ‚Üí effacer le message wizard
          wizardMessage.remove();
        }
      }
    }, { passive:true });

    el.objectif?.addEventListener("input", () => { mark("objectif"); render(); }, { passive:true });
    el.objectif?.addEventListener("blur",  () => { mark("objectif"); render(); }, { passive:true });

    el.basale?.addEventListener("input", () => { mark("basale"); render(); }, { passive:true });
    el.basale?.addEventListener("blur",  () => { mark("basale"); render(); }, { passive:true });

    el.rapide?.addEventListener("input", () => { mark("rapide"); render(); }, { passive:true });
    el.rapide?.addEventListener("blur",  () => { mark("rapide"); render(); }, { passive:true });

    el.arrondi?.addEventListener("change", () => { render(); }, { passive:true });

    // Buttons
    el.themeBtn?.addEventListener("click", toggleTheme);
    el.simpleBtn?.addEventListener("click", toggleSimpleMode);
    el.settingsBtn?.addEventListener("click", toggleSettings);

    // Close settings on Escape
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && el.settingsPanel && !el.settingsPanel.classList.contains("hidden")){
        toggleSettings();
      }
    });

    // Save ratios when leaving settings panel (auto-save)
    // We keep it simple: save on any change, but only if in-range.
    let saveTimeout = null;
    const saveRatiosIfOk = () => {
      const basale = Util.toNumber(el.basale?.value);
      const rapide = Util.toNumber(el.rapide?.value);
      const objectif = Util.toNumber(el.objectif?.value);
      const step = Util.toNumber(el.arrondi?.value);
      if(ratiosInRange(basale, rapide) && rangeOk(objectif, TARGET_MIN, TARGET_MAX)){
        Storage.setRatios({ basale, rapide, objectif, step });
        
        // Feedback visuel temporaire
        if(el.settingsBtn){
          const originalText = el.settingsBtn.innerHTML;
          el.settingsBtn.innerHTML = '‚úì Sauvegard√©';
          el.settingsBtn.style.color = 'var(--good)';
          
          if(saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            el.settingsBtn.innerHTML = originalText;
            el.settingsBtn.style.color = '';
          }, 2000);
        }
      }
    };
    el.basale?.addEventListener("change", saveRatiosIfOk);
    el.rapide?.addEventListener("change", saveRatiosIfOk);
    el.objectif?.addEventListener("change", saveRatiosIfOk);
    el.arrondi?.addEventListener("change", saveRatiosIfOk);

    // Initial render
    setEditingRatios(false);
    render();
    
    // Forcer l'affichage du message bleu initial si aucun champ n'est rempli
    const statusNode = el.statusFast || el.status;
    if(statusNode){
      setStatus("info", "Compl√®te les champs en bleu pour calculer ton bolus");
    }
  }

  init();
  
  // BOUTON DE TEST MANUEL (√Ä RETIRER APR√àS DEBUG)
  window.testColorerBlocIG = function() {
    console.log('üß™ TEST MANUEL DE COLORATION');
    const blocIG = document.querySelector('.recapTotalItem.ig');
    if (blocIG) {
      const valueElement = blocIG.querySelector('.recapTotalValue');
      if (valueElement) {
        const valueText = valueElement.textContent.trim();
        const igValue = parseInt(valueText.replace(/[^\d]/g, ''));
        console.log('üìù Texte brut:', valueText);
        console.log('üìä Valeur pars√©e:', igValue);
        
        // D√©terminer la classe et l'emoji avec logs d√©taill√©s
        let classe = '';
        let emoji = '';
        if (igValue < 55) {
          classe = 'ig-low';
          emoji = 'üü¢';
          console.log(`‚úÖ ${igValue} < 55 ‚Üí IG BAS (VERT)`);
        } else if (igValue <= 69) {
          classe = 'ig-medium';
          emoji = 'üü°';
          console.log(`‚úÖ ${igValue} est entre 55 et 69 ‚Üí IG MOYEN (JAUNE)`);
        } else {
          classe = 'ig-high';
          emoji = 'üî¥';
          console.log(`‚úÖ ${igValue} >= 70 ‚Üí IG √âLEV√â (ROUGE)`);
        }
        
        // Nettoyer compl√®tement
        blocIG.classList.remove('ig-low', 'ig-medium', 'ig-high');
        blocIG.style.background = '';
        blocIG.style.borderColor = '';
        
        // Appliquer la nouvelle classe
        blocIG.classList.add(classe);
        console.log('Classe appliqu√©e:', classe);
        console.log('Classes finales:', blocIG.className);
        
        // CHANGER LA SPH√àRE APR√àS LE CHIFFRE (pas l'ic√¥ne du label !)
        const currentText = valueElement.textContent;
        const numberOnly = igValue.toString();
        const newText = numberOnly + ' ' + emoji;
        valueElement.textContent = newText;
        console.log(`üé® Sph√®re chang√©e: "${currentText}" ‚Üí "${newText}"`);
        
        // Forcer le style inline avec setProperty
        if (classe === 'ig-low') {
          blocIG.style.setProperty('background', 'rgba(52, 211, 153, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(52, 211, 153, 0.4)', 'important');
        } else if (classe === 'ig-medium') {
          blocIG.style.setProperty('background', 'rgba(251, 191, 36, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(251, 191, 36, 0.4)', 'important');
        } else {
          blocIG.style.setProperty('background', 'rgba(251, 113, 133, 0.15)', 'important');
          blocIG.style.setProperty('border-color', 'rgba(251, 113, 133, 0.4)', 'important');
        }
        console.log('‚úÖ Style inline forc√© avec setProperty');
        console.log('Background final:', window.getComputedStyle(blocIG).backgroundColor);
      }
    } else {
      console.log('‚ùå Bloc IG non trouv√©');
    }
  };
  console.log('üí° Pour tester: tapez testColorerBlocIG() dans la console');
})();

// -------------------- Coloration dynamique du bloc IG (R√©capitulatif mode simple) --------------------
(() => {
  "use strict";

  function getIGClass(v) { return v < 55 ? 'ig-low' : v <= 69 ? 'ig-medium' : 'ig-high'; }

  function colorerBlocIGRecap() {
    const blocIG = document.querySelector('.recapTotalItem.ig');
    if (!blocIG) return false;
    const valueElement = blocIG.querySelector('.recapTotalValue');
    if (!valueElement) return false;
    const igValue = parseInt(valueElement.textContent.replace(/[^\d]/g, ''));
    if (isNaN(igValue)) return false;

    const igClass = getIGClass(igValue);
    const emoji   = igClass === 'ig-low' ? 'üü¢' : igClass === 'ig-medium' ? 'üü°' : 'üî¥';

    blocIG.classList.remove('ig-low', 'ig-medium', 'ig-high');
    blocIG.style.background  = '';
    blocIG.style.borderColor = '';
    blocIG.classList.add(igClass);
    valueElement.textContent = valueElement.textContent.replace(/[^\d]/g, '') + ' ' + emoji;

    const colors = {
      'ig-low':    ['rgba(52,211,153,0.15)',  'rgba(52,211,153,0.4)'],
      'ig-medium': ['rgba(251,191,36,0.15)',  'rgba(251,191,36,0.4)'],
      'ig-high':   ['rgba(251,113,133,0.15)', 'rgba(251,113,133,0.4)'],
    };
    blocIG.style.setProperty('background',   colors[igClass][0], 'important');
    blocIG.style.setProperty('border-color', colors[igClass][1], 'important');
    return true;
  }

  const observer = new MutationObserver((mutations) => {
    const recapAdded = mutations.some(m =>
      Array.from(m.addedNodes).some(n =>
        n.nodeType === 1 && (
          n.classList?.contains('recapRepas') ||
          n.classList?.contains('recapTotalItem') ||
          n.querySelector?.('.recapRepas') ||
          n.querySelector?.('.recapTotalItem')
        )
      )
    );
    if (recapAdded) setTimeout(colorerBlocIGRecap, 100);
  });
  observer.observe(document.body, { childList: true, subtree: true });
})();

// -------------------- Coloration dynamique du bloc IG (Mon assiette) --------------------
(() => {
  "use strict";

  function getIGClass(v) { return v < 55 ? 'ig-low' : v <= 69 ? 'ig-medium' : 'ig-high'; }

  function colorerBlocIG() {
    const plateSummary = document.getElementById('plateSummary');
    if (!plateSummary) return;
    plateSummary.querySelectorAll('.summaryItem').forEach((item) => {
      const label = item.querySelector('.summaryLabel');
      const val   = item.querySelector('.summaryValue');
      if (!label || !val) return;
      const txt = label.textContent.trim().toLowerCase();
      if (txt.includes('ig') || txt.includes('index') || txt.includes('glyc√©mique')) {
        const igValue = parseInt(val.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(igValue)) {
          item.classList.remove('ig-low', 'ig-medium', 'ig-high');
          item.classList.add(getIGClass(igValue));
        }
      }
    });
  }

  const plateSummary = document.getElementById('plateSummary');
  if (plateSummary) {
    const observer = new MutationObserver(colorerBlocIG);
    observer.observe(plateSummary, { childList: true, subtree: true, characterData: true });
  }
})();
</script>

<!--
  ORDRE D'EX√âCUTION GARANTI (Issue 1 + Issue 2 + Issue 4 + Issue 7) :
  1. storage.js        ‚Äî AppStorage unifi√© (TTL + versioning), doit √™tre 1er
  2. bolusMath.js      ‚Äî BolusMath : pure functions moteur bolus
  3. units.js          ‚Äî GlyUnits : conversions mg/dL ‚Üî g/L + parsing
  4. notifications.js  ‚Äî Notify : toasts/banni√®res/confirm centralis√©s
  5. food-database     ‚Äî FoodDatabase (utilise Notify pour les erreurs)
  6. bolus-optimizer   ‚Äî BolusOptimizer (pas de d√©pendances)
  7. food-search-ui    ‚Äî FoodSearchUI (d√©pend de AppStorage + Notify)
  8. simple-mode-*     ‚Äî SimpleModeData + SimpleModeWizard
  9. app.js en dernier ‚Äî instancie FoodSearchUI et SimpleModeWizard une seule fois
-->
<script src="storage.js?v=2.1"></script>
<script src="bolusMath.js?v=2.1"></script>
<script src="units.js?v=2.1"></script>
<script src="notifications.js?v=2.1"></script>
<script src="food-database.js?v=2.1"></script>
<script src="bolus-optimizer.js?v=2.1"></script>
<script src="food-search-ui.js?v=2.1"></script>
<script src="simple-mode-data.js?v=2.1"></script>
<script src="simple-mode-wizard.js?v=2.1"></script>
<script src="app.js?v=2.1"></script>

</body>
</html>
