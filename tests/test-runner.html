<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AC Bolus â€” Tests</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0b1220;
      --panel:   rgba(255,255,255,0.05);
      --border:  rgba(255,255,255,0.10);
      --text:    rgba(255,255,255,0.92);
      --muted:   rgba(255,255,255,0.45);
      --accent:  #6ee7ff;
      --good:    #34d399;
      --bad:     #fb7185;
      --warn:    #fbbf24;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    header h1 { font-size: 22px; font-weight: 900; }
    header p  { font-size: 13px; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ Barre de rÃ©sumÃ© â”€â”€ */
    #summary {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 28px;
    }

    .stat {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 20px;
      min-width: 120px;
      text-align: center;
    }
    .stat .n    { font-size: 32px; font-weight: 950; }
    .stat .lbl  { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .stat.pass  .n { color: var(--good); }
    .stat.fail  .n { color: var(--bad);  }
    .stat.total .n { color: var(--accent); }

    /* â”€â”€ Badge rÃ©sultat global â”€â”€ */
    #globalBadge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 15px;
      margin-bottom: 28px;
    }
    #globalBadge.allPass { background: rgba(52,211,153,0.18); border: 1px solid var(--good); color: var(--good); }
    #globalBadge.hasFail { background: rgba(251,113,133,0.18); border: 1px solid var(--bad);  color: var(--bad);  }

    /* â”€â”€ Suites â”€â”€ */
    .suite-block {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .suite-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      background: var(--panel);
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .suite-header:hover { background: rgba(255,255,255,0.08); }

    .suite-header .suite-name { flex: 1; }
    .suite-header .suite-count { font-size: 12px; color: var(--muted); }
    .suite-header .suite-icon  { font-size: 16px; }

    .suite-body { display: none; }
    .suite-body.open { display: block; }

    /* â”€â”€ Tests individuels â”€â”€ */
    .test-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px 10px 24px;
      border-top: 1px solid rgba(255,255,255,0.04);
      font-size: 13px;
    }
    .test-row.pass { }
    .test-row.fail { background: rgba(251,113,133,0.06); }

    .test-icon { font-size: 14px; flex-shrink: 0; }
    .test-label { flex: 1; }
    .test-detail {
      font-size: 12px;
      color: var(--bad);
      margin-top: 2px;
      font-family: monospace;
    }
    .test-cell { flex-direction: column; align-items: flex-start; }

    /* â”€â”€ Async note â”€â”€ */
    #asyncNote {
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(251,191,36,0.10);
      border: 1px solid rgba(251,191,36,0.30);
      border-radius: 10px;
      font-size: 13px;
      color: var(--warn);
      display: none;
    }

    /* â”€â”€ Bouton relancer â”€â”€ */
    #rerunBtn {
      margin-top: 24px;
      padding: 12px 28px;
      background: rgba(110,231,255,0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 50px;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #rerunBtn:hover { background: rgba(110,231,255,0.25); }
  </style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ§ª AC Bolus â€” Harness de tests</h1>
    <p>Tests unitaires et d'intÃ©gration â€” aucun framework, aucun serveur requis</p>
  </div>
</header>

<div id="summary"></div>
<div id="globalBadge"></div>
<div id="results"></div>
<div id="asyncNote">â³ Tests asynchrones en cours (DB2 : load fail)â€¦ Les rÃ©sultats s'ajouteront automatiquement.</div>

<button id="rerunBtn" onclick="location.reload()">ğŸ”„ Relancer les tests</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Chargement des modules dans l'ordre requis
     Chemin relatif depuis tests/ â†’ ../
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="../storage.js"></script>
<script src="../bolusMath.js"></script>
<script src="../units.js"></script>
<script src="../food-database.js"></script>
<script src="../bolus-optimizer.js"></script>

<!-- Suite de tests -->
<script src="tests.js"></script>

<!-- Rendu des rÃ©sultats -->
<script>
  // â”€â”€ Rendu synchrone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderResults(extraAsync = false) {
    const { passed, failed, results } = TestRunner.run();
    const total = passed + failed;

    // RÃ©sumÃ© chiffres
    document.getElementById('summary').innerHTML = `
      <div class="stat total"><div class="n">${total}</div><div class="lbl">Total</div></div>
      <div class="stat pass"><div class="n">${passed}</div><div class="lbl">âœ… PassÃ©s</div></div>
      <div class="stat fail"><div class="n">${failed}</div><div class="lbl">âŒ Ã‰chouÃ©s</div></div>
    `;

    // Badge global
    const badge = document.getElementById('globalBadge');
    if (failed === 0 && !extraAsync) {
      badge.className = 'allPass';
      badge.textContent = 'âœ… TOUS LES TESTS PASSENT';
    } else if (failed > 0) {
      badge.className = 'hasFail';
      badge.textContent = `âŒ ${failed} test${failed > 1 ? 's' : ''} Ã©chouÃ©${failed > 1 ? 's' : ''}`;
    } else {
      badge.className = '';
      badge.textContent = 'â³ Tests asynchrones en coursâ€¦';
    }

    // Grouper par suite
    const suites = {};
    results.forEach(r => {
      if (r.type === 'suite') return;
      const s = r.suite || '(sans suite)';
      if (!suites[s]) suites[s] = [];
      suites[s].push(r);
    });

    // Rendu des suites
    const container = document.getElementById('results');
    container.innerHTML = '';

    for (const [suiteName, tests] of Object.entries(suites)) {
      const suitePass   = tests.filter(t => t.type === 'pass').length;
      const suiteFail   = tests.filter(t => t.type === 'fail').length;
      const suiteIcon   = suiteFail > 0 ? 'âŒ' : 'âœ…';
      const isFailSuite = suiteFail > 0;

      const block = document.createElement('div');
      block.className = 'suite-block';

      const body = document.createElement('div');
      body.className = 'suite-body' + (isFailSuite ? ' open' : '');

      const header = document.createElement('div');
      header.className = 'suite-header';
      header.innerHTML = `
        <span class="suite-icon">${suiteIcon}</span>
        <span class="suite-name">${suiteName}</span>
        <span class="suite-count">${suitePass}/${tests.length}</span>
      `;
      header.addEventListener('click', () => body.classList.toggle('open'));

      tests.forEach(t => {
        const row = document.createElement('div');
        row.className = `test-row ${t.type} test-cell`;
        const icon  = t.type === 'pass' ? 'âœ…' : 'âŒ';
        row.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;width:100%">
            <span class="test-icon">${icon}</span>
            <span class="test-label">${t.label}</span>
          </div>
          ${t.detail ? `<div class="test-detail">${t.detail}</div>` : ''}
        `;
        body.appendChild(row);
      });

      block.appendChild(header);
      block.appendChild(body);
      container.appendChild(block);
    }
  }

  // â”€â”€ Callback pour tests async (DB2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window._testRunnerRenderFinal = function() {
    document.getElementById('asyncNote').style.display = 'none';
    renderResults(false);
  };

  // â”€â”€ Rendu initial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VÃ©rifier si DB2 a lancÃ© une promesse async
  const hasAsync = typeof FoodDatabase !== 'undefined';
  if (hasAsync) {
    document.getElementById('asyncNote').style.display = 'block';
  }
  renderResults(hasAsync);

  // Fallback : si DB2 ne rappelle pas dans 3s (ex: fetch bloquÃ©), on re-render
  setTimeout(() => {
    document.getElementById('asyncNote').style.display = 'none';
    renderResults(false);
  }, 3000);
</script>

</body>
</html>
